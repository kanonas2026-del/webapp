<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#88cfd3" />
  <title>„Ç¶„ÇØ„É¨„É¨„Éª„Ç≤„Éº„É†</title>
  <style>
    :root{ --vh: 1vh; }

    :root{
      --primary: #ff7a3d;
      --card: rgba(255,255,255,0.92);
      --shadow: rgba(0,0,0,0.18);
    }
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      position: fixed;
      background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%);
      color: #4a3728;
      font-family: system-ui, -apple-system, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    #app { position: fixed; inset: 0; width: 100%; height: calc(var(--vh) * 100); overflow: hidden; }
    canvas { display:block; width:100%; height:100%; touch-action:none; }

    /* „É°„Éã„É•„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    #menu-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.32);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; backdrop-filter: blur(2px);
    }
    .menu-card {
      background: var(--card); width: min(560px, 96vw);
      max-height: calc(100% - 24px); overflow-y: auto;
      border-radius: 18px; padding: 18px;
      box-shadow: 0 12px 0 rgba(122,177,204,0.35), 0 18px 36px var(--shadow);
      display: flex; flex-direction: column; gap: 10px;
    }
    .menu-card h1 { margin: 0 0 6px; font-size: 22px; text-align: center; }
    
    .menu-btn {
      background: rgba(255,255,255,0.98); color: #4a3728;
      border: none; border-radius: 16px; padding: 12px;
      cursor: pointer; display: flex; gap: 12px; align-items: center;
      box-shadow: 0 4px 0 rgba(122,177,204,0.32);
      transition: transform 0.08s; text-align: left;
    }
    .menu-btn:active { transform: translateY(2px); box-shadow: none; }
    .badge { flex: 0 0 38px; height: 38px; border-radius: 12px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; }
    .menu-btn.mode2 .badge{ background: #ffde59; color:#4a3728; }
    .menu-btn.mode3 .badge{ background: #7ed957; }
    .menu-btn.mode4 .badge{ background: #5ce1e6; color: #133; }
    
    .menu-text .title { font-size: 16px; font-weight: 900; margin-bottom: 2px; }
    .menu-text small { font-size: 11px; opacity: 0.8; }

    /* „É¢„Éº„ÉâÈÅ∏Êäû */
    .mode-select { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); }
    .mode-pills { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .mode-pill {
      border: 2px solid rgba(0,0,0,0.1); background: #fff; border-radius: 20px;
      padding: 6px 12px; font-weight: 800; font-size: 12px; cursor: pointer;
    }
    .mode-pill.active { border-color: var(--primary); background: rgba(255,122,61,0.1); color: var(--primary); }

    /* „Ç≤„Éº„É†UI */
    #score-panel, #timer-panel {
      position: fixed; z-index: 90; background: rgba(255,255,255,0.85);
      padding: 6px 12px; border-radius: 14px; font-weight: 900; font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;
    }
    #score-panel { top: 60px; right: 12px; }
    #timer-panel { top: 12px; right: 12px; font-size: 16px; }

    #stopBtn {
      position: fixed; right: 14px; bottom: 14px; z-index: 180; display: none;
      border: none; border-radius: 16px; padding: 12px 18px;
      background: rgba(255,255,255,0.92); font-weight: 900; font-size: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15); cursor: pointer;
    }
    
    #back-btn {
      position: fixed; top: 12px; left: 12px; z-index: 180;
    }
    #back-btn button {
      border: none; background: rgba(255,255,255,0.6); color: #0d2b3b;
      font-weight: 800; font-size: 12px; padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }

    #chordHud {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      z-index: 85; display: none; pointer-events: none;
      background: rgba(255,255,255,0.86); border-radius: 18px; padding: 6px 16px;
      font-weight: 900; font-size: 32px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    #lyrics-area {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%;
      text-align: center; font-size: 28px; font-weight: 900; color: #4a3728;
      text-shadow: 0 2px 8px rgba(255,255,255,0.8); pointer-events: none; z-index: 50;
    }

    /* „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÖ±ÈÄö */
    .overlay-card {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 120; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    }
    .card-content {
      background: #fff; width: min(480px, 90vw); border-radius: 20px; padding: 24px;
      text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative;
    }
    .result-score { font-size: 32px; font-weight: 900; margin: 10px 0; color: var(--primary); }
    .action-btn {
      width: 100%; border: none; border-radius: 14px; padding: 14px; font-size: 16px; font-weight: 900;
      cursor: pointer; margin-top: 10px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: #eee; color: #555; }

    @media (orientation: landscape) and (max-height: 460px) {
      .menu-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .menu-btn { padding: 8px; }
    }
  
#version-badge{position:fixed;right:10px;bottom:10px;z-index:9999;background:rgba(0,0,0,0.55);color:#fff;font-weight:800;font-size:12px;padding:6px 10px;border-radius:14px;backdrop-filter:blur(4px);}

</style>
</head>
<body>

<div id="app">
  <div id="menu-overlay">
    <div class="menu-card">
      <h1 style="margin-bottom: 2px;">ü™ï „Ç≤„Éº„É†„É°„Éã„É•„Éº</h1>
      
      <div class="menu-list" style="display:flex; flex-direction:column; gap:8px;">
        <button class="menu-btn mode1" onclick="prepGame('scale')">
          <div class="badge">üê§</div>
          <div class="menu-text"><div class="title">„Éâ„É¨„Éü„Éï„Ç°„ÇΩ„É©„Ç∑„Éâ</div><small>„Å†„Çì„Å†„ÇìÈÄü„Åè„Å™„Çã„Çà</small></div>
        </button>
        <button class="menu-btn mode2" onclick="prepGame('easy')">
          <div class="badge">üê±</div>
          <div class="menu-text"><div class="title">„Ç≥„Éº„Éâ „Åã„Çì„Åü„Çì</div><small>C / F / G7 / Am</small></div>
        </button>
        <button class="menu-btn mode3" onclick="prepGame('hard')">
          <div class="badge">üêº</div>
          <div class="menu-text"><div class="title">„Ç≥„Éº„Éâ „Å°„Çá„ÅÑ„ÇÄ„Åö</div><small>„ÅÑ„Çç„ÅÑ„Çç„Å™„Ç≥„Éº„Éâ</small></div>
        </button>
        <button class="menu-btn mode4" onclick="prepGame('song')">
          <div class="badge">ü¶Å</div>
          <div class="menu-text"><div class="title">Êõ≤Ôºö„Åç„Çâ„Åç„ÇâÊòü</div><small>„É°„É≠„Éá„Ç£Ôºã„Ç≥„Éº„Éâ</small></div>
        </button>
      </div>

      <div class="mode-select">
        <div class="mode-pills">
          <div class="mode-pill" onclick="setMode(this, 'NORMAL')">„Éé„Éº„Éû„É´</div>
          <div class="mode-pill active" onclick="setMode(this, 'WAIT')">„Åæ„Å°„É¢„Éº„Éâ</div>
          <div class="mode-pill" onclick="setMode(this, 'TAP')">„Çø„ÉÉ„Éó„É¢„Éº„Éâ</div>
        </div>
      </div>
      
      <button class="action-btn btn-secondary" onclick="location.href='index.html'" style="margin-top:10px;">üèùÔ∏è TOP„Å∏„ÇÇ„Å©„Çã</button>
    </div>
  </div>

  <div id="lyrics-area"></div>
  <div id="score-panel">‚≠ê <span id="score">0</span></div>
  <div id="timer-panel">„ÅÆ„Åì„Çä <span id="timer">60</span> Áßí</div>
  <div id="chordHud" aria-hidden="true"></div>
  
  <div id="back-btn"><button onclick="goMenu()">üèùÔ∏è „É°„Éã„É•„Éº</button></div>
  <button id="stopBtn" type="button">„Çπ„Éà„ÉÉ„Éó</button>

  <div id="loading-overlay" class="overlay-card">
    <div class="card-content">
      <h2>„Éû„Ç§„ÇØ„Åò„ÇÖ„Çì„Å≥‰∏≠...</h2>
      <p id="loading-msg">Èùô„Åã„Å´„Åó„Å¶„Å≠Ôºà„Éé„Ç§„Ç∫„Çí„ÅØ„Åã„Å£„Å¶„ÅÑ„Åæ„ÅôÔºâ</p>
    </div>
  </div>

  <div id="pause-overlay" class="overlay-card">
    <div class="card-content">
      <h2>„Çπ„Éà„ÉÉ„Éó‰∏≠</h2>
      <button class="action-btn btn-primary" onclick="resumeGame()">„Å§„Å•„Åë„Çã</button>
      <button class="action-btn btn-secondary" onclick="goMenu()">„É°„Éã„É•„Éº„Å∏</button>
    </div>
  </div>

  <div id="result-overlay" class="overlay-card">
    <div class="card-content">
      <h2>Finish!</h2>
      <div class="result-score">‚≠ê <span id="result-score">0</span> pts</div>
      <p id="result-msg">Good Job!</p>
      <button class="action-btn btn-primary" onclick="restartLast()">„ÇÇ„ÅÜÔºëÂõû</button>
      <button class="action-btn btn-secondary" onclick="goMenu()">„É°„Éã„É•„Éº</button>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>
</div>

<script>
// ===== Âü∫Êú¨Ë®≠ÂÆö =====
const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameState = 'MENU';
let playMode = 'WAIT';

// „Éû„Ç§„ÇØÈñ¢ÈÄ£
let audioCtx = null;
let micStream = null;
let micAnalyser = null;
let prevRms = 0;
let pluckHoldCount = 0;
let ignorePluckUntil = 0;
let NOISE_RMS = 0;
let PLUCK_HIGH_RMS = 0.012; 
let PLUCK_RISE_RMS = 0.010;

// „Ç≤„Éº„É†Â§âÊï∞
let rafId = 0;
let gameEndAt = 0;
let score = 0;
let groups = [];
let stars = [];
let lastSpawn = 0;
let scrollSpeed = 3.5;
let baseScrollSpeed = 3.5;
let gameMode = 'practice';
let isSongMode = false;
let waitHold = false;
let waitTargetGroup = null;

// „Éá„Éº„Çø
const NUT_X = 180;
const STRING_COLORS = ['#ff5757', '#ffde59', '#7ed957', '#5ce1e6'];
const CHORD_LIB = {
  'C':  { name: 'C',  targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'Ëñ¨'}] },
  'F':  { name: 'F',  targetIdx: 0, fingers: [{s: 2, f: 1, txt: '‰∫∫'}, {s: 4, f: 2, txt: '‰∏≠'}] },
  'G7': { name: 'G7', targetIdx: 0, fingers: [{s: 2, f: 1, txt: '‰∫∫'}, {s: 1, f: 2, txt: '‰∏≠'}, {s: 3, f: 2, txt: 'Ëñ¨'}] },
  'Am': { name: 'Am', targetIdx: 0, fingers: [{s: 3, f: 2, txt: '‰∏≠'}] },
  'G':  { name: 'G',  targetIdx: 0, fingers: [{s: 3, f: 2, txt: '‰∫∫'}, {s: 2, f: 3, txt: 'Ëñ¨'}, {s: 1, f: 2, txt: '‰∏≠'}] },
  'A7': { name: 'A7', targetIdx: 0, fingers: [{s: 3, f: 1, txt: '‰∫∫'}] },
  'Dm': { name: 'Dm', targetIdx: 0, fingers: [{s: 4, f: 2, txt: '‰∏≠'}, {s: 3, f: 1, txt: '‰∫∫'}, {s: 2, f: 1, txt: '‰∫∫'}] },
  'Em': { name: 'Em', targetIdx: 0, fingers: [{s: 3, f: 4, txt: 'Â∞è'}, {s: 2, f: 3, txt: 'Ëñ¨'}, {s: 1, f: 2, txt: '‰∏≠'}] },
  'D7': { name: 'D7', targetIdx: 0, fingers: [{s: 2, f: 2, txt: '‰∏≠'}, {s: 3, f: 2, txt: 'Ëñ¨'}, {s: 4, f: 2, txt: '‰∫∫'}] }
};
const SOLO_LIB = {
  'do':  { name:'', targetIdx:0, fingers:[{s:3,f:0,txt:'0'}]},
  're':  { name:'', targetIdx:0, fingers:[{s:3,f:2,txt:'‰∏≠'}]},
  'mi':  { name:'', targetIdx:0, fingers:[{s:2,f:0,txt:'0'}]},
  'fa':  { name:'', targetIdx:0, fingers:[{s:2,f:1,txt:'‰∫∫'}]},
  'so':  { name:'', targetIdx:0, fingers:[{s:2,f:3,txt:'Ëñ¨'}]},
  'la':  { name:'', targetIdx:0, fingers:[{s:1,f:0,txt:'0'}]},
  'si':  { name:'', targetIdx:0, fingers:[{s:1,f:2,txt:'‰∏≠'}]},
  'do2': { name:'', targetIdx:0, fingers:[{s:1,f:3,txt:'Ëñ¨'}]}
};
const SONG_DATA = [
  {lib:CHORD_LIB,key:'C',lyrics:"„Åç„Çâ"},{lib:SOLO_LIB,key:'do',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"„Åç„Çâ"},{lib:SOLO_LIB,key:'so',lyrics:""},
  {lib:CHORD_LIB,key:'F',lyrics:"„Å≤„Åã"},{lib:SOLO_LIB,key:'la',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"„Çã„Éº"},{lib:SOLO_LIB,key:'so',lyrics:""},
  {lib:CHORD_LIB,key:'G7',lyrics:"„Åä„Åù"},{lib:SOLO_LIB,key:'fa',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"„Çâ„ÅÆ"},{lib:SOLO_LIB,key:'mi',lyrics:""},
  {lib:CHORD_LIB,key:'G7',lyrics:"„Åª„Åó"},{lib:SOLO_LIB,key:'re',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"„Çà„Éº"},{lib:SOLO_LIB,key:'do',lyrics:""}
];

let songIndex=0; let practiceIndex=0; let scaleIndex=0;
let currentLevelChords = [];
let spawnInterval = 1800;
let lastStartParams = null; // „É™„Éà„É©„Ç§Áî®

// --- UIÊìç‰Ωú ---
function setMode(el, mode){
  playMode = mode;
  document.querySelectorAll('.mode-pill').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// ‚òÖ‰øÆÊ≠£: „É°„Éã„É•„Éº„Å∏Êàª„ÇãÂãï‰ΩúÔºàTOP„Åß„ÅØ„Å™„Åè„Ç≤„Éº„É†„É°„Éã„É•„Éº„Å´Êàª„ÇãÔºâ
function goMenu(){
  if(rafId) cancelAnimationFrame(rafId);
  gameState = 'MENU';
  
  // UI„É™„Çª„ÉÉ„Éà
  document.getElementById('menu-overlay').style.display = 'flex';
  document.getElementById('score-panel').style.display = 'none';
  document.getElementById('timer-panel').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('pause-overlay').style.display = 'none';
  document.getElementById('result-overlay').style.display = 'none';
  document.getElementById('back-btn').style.display = 'none';
  document.getElementById('chordHud').style.display = 'none';
  document.getElementById('lyrics-area').innerText = '';
  
  // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

document.getElementById('stopBtn').onclick = () => {
  if(gameState==='PLAY') {
    gameState='PAUSE';
    document.getElementById('pause-overlay').style.display='flex';
  }
};
function resumeGame(){
  gameState='PLAY';
  document.getElementById('pause-overlay').style.display='none';
  lastFrameT=0; rafId=requestAnimationFrame(gameLoop);
}

// --- „Ç≤„Éº„É†ÈñãÂßã„Éï„É≠„Éº ---
async function prepGame(type){
  // „Çø„ÉÉ„Éó„É¢„Éº„Éâ„Å™„Çâ„Éû„Ç§„ÇØ‰∏çË¶Å
  if(playMode === 'TAP'){ startGameByType(type); return; }

  // „Éû„Ç§„ÇØÊ∫ñÂÇô
  document.getElementById('loading-overlay').style.display = 'flex';
  try {
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') await audioCtx.resume();

    if(!micStream){
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: IS_IOS ? { echoCancellation:false, noiseSuppression:false, autoGainControl:false } : true
      });
      const src = audioCtx.createMediaStreamSource(micStream);
      micAnalyser = audioCtx.createAnalyser();
      const gain = audioCtx.createGain();
      gain.gain.value = IS_IOS ? 3.9 : 1.0;
      micAnalyser.fftSize = IS_IOS ? 4096 : 2048;
      src.connect(gain).connect(micAnalyser);
    }
    
    // „Éé„Ç§„Ç∫Ë®àÊ∏¨ (1Áßí)
    await new Promise(r => setTimeout(r, 1000));
    // Á∞°Êòì„Ç≠„É£„É™„Éñ„É¨„Éº„Ç∑„Éß„É≥ÔºàÁèæÂú®ÂÄ§„Çí„Éé„Ç§„Ç∫Â∫ä„Å®„Åô„ÇãÔºâ
    const buf = new Float32Array(micAnalyser.fftSize);
    micAnalyser.getFloatTimeDomainData(buf);
    let rms=0; for(let i=0;i<buf.length;i++) rms+=buf[i]*buf[i];
    NOISE_RMS = Math.sqrt(rms/buf.length);
    
    // ÈñæÂÄ§Ë®≠ÂÆö
    if(IS_IOS){
      PLUCK_RISE_RMS = Math.max(0.0016, NOISE_RMS * 2.0);
      PLUCK_HIGH_RMS = Math.max(0.0020, NOISE_RMS * 3.0);
    } else {
      PLUCK_RISE_RMS = Math.max(0.010, NOISE_RMS * 2.0);
      PLUCK_HIGH_RMS = Math.max(0.012, NOISE_RMS * 3.0);
    }

    document.getElementById('loading-overlay').style.display = 'none';
    startGameByType(type);

  } catch(e) {
    alert('„Éû„Ç§„ÇØ„Åå‰Ωø„Åà„Åæ„Åõ„Çì„ÄÇ„Çø„ÉÉ„Éó„É¢„Éº„Éâ„ÅßÈñãÂßã„Åó„Åæ„Åô„ÄÇ');
    playMode = 'TAP';
    document.getElementById('loading-overlay').style.display = 'none';
    startGameByType(type);
  }
}

function startGameByType(type){
  lastStartParams = type;
  if(type==='scale') initGame('scale', null, {speedBase:3.4, interval:2000});
  else if(type==='easy') initGame('practice', ['C','F','G7','Am'], {speedBase:3.2});
  else if(type==='hard') initGame('practice', ['C','F','G7','Am','G','A7','Dm','Em','D7'], {speedBase:3.35});
  else if(type==='song') initGame('song', '„Åç„Çâ„Åç„ÇâÊòü', {speedBase:3.45});
}

function restartLast(){
  document.getElementById('result-overlay').style.display='none';
  startGameByType(lastStartParams || 'easy');
}

function initGame(mode, levelData, opts){
  if(rafId) cancelAnimationFrame(rafId);
  gameState='PLAY';
  
  // UI„É™„Çª„ÉÉ„Éà
  document.getElementById('menu-overlay').style.display='none';
  document.getElementById('result-overlay').style.display='none';
  document.getElementById('score-panel').style.display='block';
  document.getElementById('timer-panel').style.display='block';
  document.getElementById('stopBtn').style.display='block';
  document.getElementById('back-btn').style.display='none'; // „Ç≤„Éº„É†‰∏≠„ÅØÈÇ™È≠î„Å™„ÅÆ„ÅßÊ∂à„Åô

  // Â§âÊï∞„É™„Çª„ÉÉ„Éà
  score=0; groups=[]; stars=[];
  waitHold=false; waitTargetGroup=null;
  baseScrollSpeed = opts.speedBase || 3.5;
  scrollSpeed = baseScrollSpeed;
  gameMode = mode;
  isSongMode = (mode==='song');
  currentLevelChords = levelData || [];
  practiceIndex=0; scaleIndex=0; songIndex=0;
  spawnInterval = (mode==='scale') ? 2000 : 1800;

  document.getElementById('score').innerText="0";
  document.getElementById('lyrics-area').innerText="";
  gameEndAt = performance.now() + 60000;

  // ÊÑüÂ∫¶„É™„Çª„ÉÉ„Éà
  prevRms = NOISE_RMS;
  pluckHoldCount=0; ignorePluckUntil=Date.now()+500;

  rafId = requestAnimationFrame(gameLoop);
}

// --- „É°„Ç§„É≥„É´„Éº„Éó ---
let lastFrameT=0;
function gameLoop(time){
  if(gameState!=='PLAY') return;
  if(!lastFrameT) lastFrameT=time;
  lastFrameT=time;

  // „Çø„Ç§„Éû„Éº
  if(!waitHold){
    const rem = Math.max(0, gameEndAt - performance.now());
    document.getElementById('timer').innerText = Math.ceil(rem/1000);
    if(rem<=0) { endGame(); return; }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawFretboard();

  // „Çπ„Éù„Éº„É≥
  if(!waitHold && (time - lastSpawn > spawnInterval)){
    // ÁîªÈù¢„ÅåË©∞„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
    let cnt=0, maxX=-9999;
    for(let g of groups) { if(g.active){ cnt++; if(g.x>maxX) maxX=g.x; } }
    
    if(cnt<6 && (maxX < canvas.width+120 - 260)){
      if(isSongMode){
        const d = SONG_DATA[songIndex % SONG_DATA.length];
        groups.push(new ChordGroup(d.lib[d.key], d.lyrics));
        songIndex++;
      } else if(gameMode==='scale'){
        const k = ['do','re','mi','fa','so','la','si','do2'][scaleIndex%8];
        groups.push(new ChordGroup(SOLO_LIB[k], ""));
        scaleIndex++;
      } else {
        const k = currentLevelChords[practiceIndex % currentLevelChords.length];
        groups.push(new ChordGroup(CHORD_LIB[k], ""));
        practiceIndex++;
      }
      lastSpawn=time;
    }
  }

  // HUD & Draw
  let target=null, bestDist=Infinity;
  for(let g of groups){
    if(!g.active) continue;
    const d = Math.abs(g.x - NUT_X);
    if(d < bestDist && d < 620 + 100){ bestDist=d; target=g; }
  }
  if(target && gameMode!=='scale'){
    document.getElementById('chordHud').style.display='block';
    document.getElementById('chordHud').innerText = target.chord.name||"";
    target.isTarget=true;
  } else {
    document.getElementById('chordHud').style.display='none';
  }

  for(let i=groups.length-1; i>=0; i--){
    groups[i].update(); groups[i].draw();
    if(groups[i].x < -300) groups.splice(i,1);
  }

  // „Ç®„Éï„Çß„ÇØ„Éà
  stars.forEach(s=>{ s.update(); s.draw(); });
  stars = stars.filter(s=>s.life>0);

  // „Éû„Ç§„ÇØÂà§ÂÆö
  processMicInput();

  rafId = requestAnimationFrame(gameLoop);
}

function endGame(){
  gameState='RESULT';
  cancelAnimationFrame(rafId);
  document.getElementById('result-score').innerText = score;
  document.getElementById('result-msg').innerText = score>300 ? "Amazing!!" : "Good Job!";
  document.getElementById('result-overlay').style.display='flex';
}

// --- ÂÖ•ÂäõÂà§ÂÆö ---
function processMicInput(){
  if(playMode==='TAP' || !micAnalyser) return;
  const buf = new Float32Array(micAnalyser.fftSize);
  micAnalyser.getFloatTimeDomainData(buf);
  let rms=0; for(let i=0; i<buf.length; i++) rms+=buf[i]*buf[i];
  const val = Math.sqrt(rms/buf.length);

  const rise = val - prevRms;
  const now = Date.now();
  if(now >= ignorePluckUntil && val > PLUCK_HIGH_RMS && rise > PLUCK_RISE_RMS){
    pluckHoldCount++;
  } else {
    pluckHoldCount = Math.max(0, pluckHoldCount-1);
  }
  prevRms = val;

  if(pluckHoldCount>=2){
    pluckHoldCount=0; ignorePluckUntil=now+250;
    handleAction();
  }
}

function handleAction(){
  if(gameState!=='PLAY') return;
  // „Çø„Éº„Ç≤„ÉÉ„ÉàÊé¢Á¥¢
  let target=null, best=Infinity;
  if(waitHold && waitTargetGroup && waitTargetGroup.active){
    target = waitTargetGroup; best = Math.abs(target.x - NUT_X);
  } else {
    for(let g of groups){
      if(!g.active) continue;
      const d = Math.abs(g.x - NUT_X);
      if(d < 620 && d > -220){ if(d<best){ best=d; target=g; } }
    }
  }

  if(target){
    const win = (playMode==='TAP') ? 220 : 110;
    if(best < win){
      // HIT
      target.active=false;
      if(waitHold){
        waitHold=false; scrollSpeed=baseScrollSpeed; waitTargetGroup=null; lastSpawn=performance.now();
      }
      score += (best<50 ? 15 : 10);
      document.getElementById('score').innerText=score;
      for(let i=0;i<15;i++) stars.push(new Star(NUT_X, canvas.height/2));
    } else if(playMode==='WAIT'){
      // MISS in WAIT mode
      if(!waitHold){
        waitHold=true; scrollSpeed=0; waitTargetGroup=target; target.x=NUT_X;
      }
    }
  }
}

// --- ÊèèÁîª„ÇØ„É©„Çπ ---
class ChordGroup {
  constructor(chord, lyrics){
    this.chord=chord; this.lyrics=lyrics;
    this.x = canvas.width+120; this.active=true; this.ticked=false; this.isTarget=false;
  }
  update(){ this.x -= scrollSpeed; if(!this.ticked && this.x<=NUT_X){ if(this.lyrics) document.getElementById('lyrics-area').innerText=this.lyrics; this.ticked=true; } }
  draw(){
    if(!this.active) return;
    const cy = canvas.height/2;
    const fw = (canvas.width - NUT_X - 60)/12;
    
    // „Ç¨„Ç§„ÉâÔºà„Çø„Éº„Ç≤„ÉÉ„ÉàÊôÇÔºâ
    if(this.isTarget && Math.abs(this.x-NUT_X)<620){
      const t = Math.max(0, 1 - Math.abs(this.x-NUT_X)/620);
      this.chord.fingers.forEach(f=>{
        const fx = f.f===0 ? NUT_X : NUT_X+(f.f*fw)-(fw/2);
        const fy = cy + (f.s-2.5)*75;
        drawCircle(fx, fy, f.txt, 32+t*10, 0.2+t*0.6, true);
      });
      this.isTarget=false;
    }
    // Êú¨‰Ωì
    const blink = (waitHold && waitTargetGroup===this) ? (0.5+0.5*Math.sin(performance.now()/100)) : 1.0;
    this.chord.fingers.forEach(f=>{
      const fx = f.f===0 ? this.x : this.x+(f.f*fw)-(fw/2);
      const fy = cy + (f.s-2.5)*75;
      drawCircle(fx, fy, f.txt, 40, 1.0, false, blink);
    });
    // „Çπ„Ç±„Éº„É´Âêç
    if(gameMode==='scale'){
      const tf = this.chord.fingers[0];
      const nx = tf.f===0 ? this.x : this.x+(tf.f*fw)-(fw/2);
      ctx.fillStyle="#fff"; ctx.font="bold 50px sans-serif"; ctx.textAlign="center";
      const chordY = Math.max(64, cy - 180);
      ctx.fillText(this.chord.name||"", nx, chordY);
    }
  }
}
function drawCircle(x,y,txt,size,alpha,blur,scale=1){
  ctx.save(); ctx.globalAlpha=alpha;
  if(blur) ctx.filter="blur(2px)";
  ctx.translate(x,y); ctx.scale(scale,scale);
  ctx.beginPath(); ctx.arc(0,0,size,0,Math.PI*2);
  ctx.fillStyle = (txt==='Ëñ¨')?'#5271ff':(txt==='‰∏≠'?'#ff66c4':(txt==='‰∫∫'?'#ff914d':'#888'));
  ctx.fill(); ctx.strokeStyle="#fff"; ctx.lineWidth=4; ctx.stroke();
  ctx.filter="none"; ctx.fillStyle="#fff"; ctx.font=`bold ${size*0.75}px sans-serif`;
  ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(txt,0,2);
  ctx.restore();
}
class Star {
  constructor(x,y){ this.x=x;this.y=y;this.vx=(Math.random()-.5)*20;this.vy=(Math.random()-.5)*20;this.life=1; }
  update(){ this.x+=this.vx;this.y+=this.vy;this.vy+=0.5;this.life-=0.03; }
  draw(){ ctx.save();ctx.globalAlpha=this.life;ctx.fillStyle="#ffeb3b";ctx.beginPath();ctx.arc(this.x,this.y,8,0,Math.PI*2);ctx.fill();ctx.restore(); }
}

function drawFretboard(){
  const cy = canvas.height/2;
  const fw = (canvas.width - NUT_X - 60)/12;
  ctx.fillStyle="#6d4c41"; ctx.fillRect(NUT_X, cy-150, canvas.width, 300);
  for(let i=0;i<=12;i++){
    const x = NUT_X + i*fw;
    ctx.strokeStyle=(i===0)?"#eee":"#a1887f"; ctx.lineWidth=(i===0)?10:3;
    ctx.beginPath(); ctx.moveTo(x,cy-150); ctx.lineTo(x,cy+150); ctx.stroke();
  }
  const labs=['1A','2E','3C','4G'];
  for(let i=0;i<4;i++){
    const y = cy + (i-1.5)*75;
    ctx.beginPath(); ctx.fillStyle=STRING_COLORS[i]; ctx.arc(125, y, 24, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff"; ctx.font="bold 16px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(labs[i], 125, y);
    ctx.strokeStyle=STRING_COLORS[i]; ctx.lineWidth=6;
    ctx.beginPath(); ctx.moveTo(NUT_X, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }
}

function handleResize(){
  document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', handleResize); handleResize();

// „Çø„ÉÉ„ÉóÊìç‰Ωú
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(playMode==='TAP') handleAction(); }, {passive:false});
canvas.addEventListener('mousedown', ()=>{ if(playMode==='TAP') handleAction(); });

// UIBAR FIX PATCH
(function(){
  function nudge(){ try{ window.scrollTo(0, 1); }catch(e){} setTimeout(function(){ try{ window.scrollTo(0, 1); }catch(e){} }, 50); }
  window.addEventListener('touchstart', nudge, {passive:true});
  window.addEventListener('touchend',   nudge, {passive:true});
  window.addEventListener('click',      nudge, {passive:true});
  window.addEventListener('orientationchange', function(){ setTimeout(nudge, 250); }, {passive:true});
  window.addEventListener('pageshow', function(){ setTimeout(nudge, 250); }, {passive:true});
  setTimeout(nudge, 300);
})();
</script>

<div id="version-badge">game_layout_fix_v1</div>
</body>
</html>