<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ã‚¦ã‚¯ãƒ¬ãƒ¬è¨ºæ–­ - ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <style>
    /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã®ã€Œã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã€ã¨ã€Œå¼¦ã®è‰²ã€ã‚’ç¶­æŒ */
    body { margin: 0; background: #4a3728; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }

    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    /* ===== TOPã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ (æ–°è¦è¿½åŠ ) ===== */
    .nav-back { 
      position:fixed; top:15px; right:15px; z-index:1000; 
      top: calc(var(--safe-top) + 15px); right: calc(var(--safe-right) + 15px);
    }
    .nav-back a {
      display:inline-block; background:rgba(255,255,255,0.85);
      color:#4a3728; font-weight:bold; text-decoration:none;
      padding:10px 18px; border-radius:20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      font-family: sans-serif; font-size: 14px;
      transition: transform 0.1s;
    }
    .nav-back a:active { transform: scale(0.95); }

    /* ===== iPhone / small screen responsive fixes (UIå´©ã‚Œå¯¾ç­–) ===== */
    #guide-msg{
      top: calc(var(--safe-top) + 10px);
      padding: 0 12px;
      font-size: clamp(16px, 4.8vw, 26px);
      line-height: 1.2;
      white-space: normal;
      word-break: keep-all;
    }
    #tuner-nav{
      top: calc(var(--safe-top) + 54px);
      height: auto;
      min-height: 92px;
      font-size: clamp(46px, 12vw, 80px);
    }
    .status-msg{
      font-size: clamp(14px, 4.2vw, 24px);
      margin-top: 2px;
      line-height: 1.2;
    }
    .ui-panel{ display:none; /* hide right buttons: use left labels instead */

      bottom: calc(var(--safe-bottom) + 14px);
      gap: clamp(10px, 3vw, 15px);
    }
    .string-btn{
      width: clamp(54px, 14vw, 75px);
      height: clamp(54px, 14vw, 75px);
      font-size: clamp(14px, 4.2vw, 20px);
      border-width: clamp(3px, 1vw, 4px);
    }
    .string-btn.active{
      border-width: clamp(6px, 1.6vw, 8px);
    }
    .start-btn{
      font-size: clamp(18px, 5vw, 24px);
      padding: clamp(16px, 4.8vw, 25px) clamp(28px, 7vw, 50px);
    }
    #diagnosis-card{
      max-height: calc(100vh - var(--safe-top) - var(--safe-bottom) - 40px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-height: 700px){
      #guide-msg{ top: calc(var(--safe-top) + 6px); }
      #tuner-nav{ top: calc(var(--safe-top) + 44px); }
      .ui-panel{ bottom: calc(var(--safe-bottom) + 10px); }
    }

    #screen-tuning { background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%); width: 100vw; height: 100vh; position: relative; }
    canvas { display: block; width: 100%; height: 100%; }
    #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .start-btn { background: #ff914d; color: white; border: none; padding: 25px 50px; font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 0 #d97b41; }
    #guide-msg { position: absolute; top: 6%; width: 100%; text-align: center; font-size: 26px; font-weight: bold; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 5; }
    #tuner-nav { position: absolute; top: 12%; left: 50%; transform: translateX(-50%); text-align: center; font-size: 80px; font-weight: 900; z-index: 5; height: 120px;}
    .arrow-up { color: #ff5757; text-shadow: 0 0 20px #fff; }
    .arrow-down { color: #5ce1e6; text-shadow: 0 0 20px #fff; }
    .status-msg { font-size: 24px; display: block; margin-top: -10px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .ui-panel { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 10; }
    .string-btn { width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; color: white; opacity: 0.8; }
    .string-btn.played { background: #888 !important; color: #ccc !important; border-color: #666 !important; transform: scale(0.9); opacity: 0.5; }
    .string-btn.active { border-width: 8px; transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.8); z-index: 11; opacity: 1; }
    #diagnosis-card { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 85%; max-width: 450px; background: white; color: #333; padding: 25px; border-radius: 30px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); z-index: 1000; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    #diagnosis-card.show { transform: translate(-50%, -50%) scale(1); }
    .diag-item { margin: 15px 0; padding: 10px; border-radius: 15px; background: #f9f9f9; }
    .diag-label { font-size: 14px; color: #888; margin-bottom: 4px; font-weight: bold; }
    .diag-value { font-size: 18px; color: #4a3728; font-weight: 900; }
  
/* ===== Diagnosis splash ===== */
.splash{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.splash.show{ display:flex; }
.splash-inner{
  width: min(560px, 92vw);
  background: #fff;
  border-radius: 22px;
  padding: 28px 20px 22px;
  box-shadow: 0 18px 45px rgba(0,0,0,0.22);
  text-align: center;
}
.splash-pop{
  font-weight: 900;
  font-size: 28px;
  letter-spacing: 0.5px;
  color: #ff7a3d;
  text-shadow: 0 3px 0 rgba(0,0,0,0.06);
  transform: scale(0.6);
  opacity: 0;
}
.splash.show .splash-pop{
  animation: popIn 520ms cubic-bezier(.2,1.35,.35,1) forwards;
}
@keyframes popIn{
  0% { transform: scale(0.6) rotate(-2deg); opacity: 0; }
  70% { transform: scale(1.08) rotate(1deg); opacity: 1; }
  100% { transform: scale(1.0) rotate(0deg); opacity: 1; }
}
.splash-btn{
  margin-top: 18px;
  border: 0;
  border-radius: 18px;
  padding: 14px 22px;
  font-size: 18px;
  font-weight: 800;
  color: #fff;
  background: #3fc26b;
  box-shadow: 0 8px 0 rgba(0,0,0,0.08);
  cursor: pointer;
}
.splash-btn:active{ transform: translateY(2px); }

/* ===== Diagnosis extra lines ===== */
.diag-meaning{
  margin-top: 6px;
  font-size: 14px;
  color: #7a7a7a;
  font-weight: 700;
}
.diag-scoreline{
  margin-top: 8px;
  margin-bottom: 8px;
  font-size: 16px;
  font-weight: 900;
  color: #ff7a3d;
}


/* ===== Drumroll ===== */
.splash-pop.blink{
  animation: blinkRoll 120ms steps(1,end) infinite;
}
@keyframes blinkRoll{
  0%{ opacity: 1; }
  50%{ opacity: 0.25; }
  100%{ opacity: 1; }
}
.splash-btn[disabled]{
  opacity: 0.6;
  cursor: default;
  filter: grayscale(0.1);
}


    /* ===== iPhone landscape fix (æ¨ªç”»é¢ã§ãƒœã‚¿ãƒ³ãŒãƒãƒƒã‚¯ã«è¢«ã‚‹å¯¾ç­–) ===== */
    @media (orientation: landscape) and (max-height: 520px){
      /* ä¸Šã®ã‚¬ã‚¤ãƒ‰ã¯1è¡Œã«å¯„ã›ã¦çœã‚¹ãƒšãƒ¼ã‚¹ */
      #guide-msg{
        top: calc(var(--safe-top) + 6px);
        font-size: clamp(14px, 3.6vw, 20px);
        line-height: 1.05;
      }
      #tuner-nav{
        top: calc(var(--safe-top) + 34px);
        min-height: 64px;
        font-size: clamp(34px, 8vw, 56px);
      }

      /* å¼¦ãƒœã‚¿ãƒ³ã‚’å³å´ã«ç¸¦ä¸¦ã³ã§é€€é¿ï¼ˆãƒãƒƒã‚¯ã«è¢«ã‚‰ãªã„ï¼‰ */
      .ui-panel{
        left: auto !important;
        right: calc(var(--safe-right) + 10px);
        bottom: auto !important;
        top: 54%;
        transform: translateY(-50%);
        flex-direction: column-reverse;
        gap: 10px;
      }
      .string-btn{
        width: clamp(48px, 9vw, 60px);
        height: clamp(48px, 9vw, 60px);
        font-size: clamp(13px, 2.8vw, 16px);
      }

      /* ãƒãƒƒã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å°‘ã—ä¸‹ã’ã¦ä¸Šã®æ–‡å­—ã¨å¹²æ¸‰ã•ã›ãªã„ */
      #neck-area{
        margin-top: 12px;
      }
    }


/* FINAL OVERRIDE: hide right string buttons */
.ui-panel{display:none !important;}

/* DDR4: emoji rendering */
#diag-face, #diag-personality, #diag-ukulele {
  font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP",
               "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
}

/* DDR4: face image */
#diag-face-img { width: 110px; height: 110px; }

.diag-subline{margin-top:6px; font-size:18px; font-weight:700; color:#333; text-align:center;}
.diag-mini-title{font-weight:700;}
.diag-personality{margin-top:16px; font-size:32px; font-weight:900; color:#3a2a1a; text-align:center;}


.version-badge{position:fixed;left:10px;bottom:10px;z-index:9999;font-size:11px;font-weight:800;color:#234;background:rgba(255,255,255,0.72);border:1px solid rgba(0,0,0,0.08);padding:4px 8px;border-radius:10px;pointer-events:none;}

  .verBadge{position:fixed;right:10px;bottom:10px;background:rgba(0,0,0,0.55);color:#fff;font-size:12px;padding:4px 8px;border-radius:10px;z-index:9999;pointer-events:none;}
</style>
</head>
<body>

  <div id="start-overlay">
    <button class="start-btn" onclick="startEverything()">ğŸµ ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã¯ã˜ã‚ã¾ã—ã‚‡ã†ï¼</button>
  </div>

  <div class="nav-back"><a href="index.html">ğŸï¸ TOPã¸</a></div>
  <div class="version-badge">v_tuning_safe_2026-01-18a</div>

  <section id="screen-tuning">
    <div id="guide-msg">1ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†</div>
    <div id="tuner-nav">
      <div id="nav-arrow"></div>
      <div id="nav-text" class="status-msg"></div>
    </div>
    <canvas id="tuningCanvas"></canvas>
    
  <div id="diagnosis-splash" class="splash">
    <div class="splash-inner">
      <div class="splash-pop" id="splash-pop">ä»Šæ—¥ã®ã‚¦ã‚¯ãƒ¬ãƒ¬è¨ºæ–­çµæœï¼ï¼</div>
      <button id="btn-show-result" class="splash-btn">çµæœã‚’è¦‹ã‚‹</button>
    </div>
  </div>

<div id="diagnosis-card">
      <div id="diag-face" style="margin-bottom:10px; display:flex; justify-content:center;"><img id="diag-face-img" alt="face" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22120%22%20height%3D%22120%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2260%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2248%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2248%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2070%20Q60%2088%2080%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E" style="width:120px; height:120px;"/></div>
      <h2 style="color: #ff914d;">ä»Šæ—¥ã®ã‚¦ã‚¯ãƒ¬ãƒ¬è¨ºæ–­</h2>
      <div id="diag-title" style="font-size:18px; font-weight:900; color:#ff7a3d; margin-top:6px;"></div>
      <div id="diag-personality" style="font-size:28px; font-weight:900; margin:10px 0 6px; color:#4a3728;"></div>
      <div id="diag-ukulele" style="font-size:18px; font-weight:900; margin:4px 0 10px; color:#333;"></div>
      <div id="diag-scoreline" class="diag-scoreline"></div>
      <div id="diag-meaning" class="diag-meaning"></div>
<button id="btn-details" style="margin:10px auto 0; display:block; background:#fff; border:2px solid #ddd; border-radius:12px; padding:8px 14px; font-weight:900; cursor:pointer;">ãã‚ã—ã</button>
<div id="detail-panel" style="display:none; margin-top:12px;">
        
      <div class="diag-item"><div class="diag-label">ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div><div id="diag-advice" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">æ€§æ ¼ã®ç†ç”±</div><div id="diag-personality-reason" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">ã’ã‚“ã®ã‚ˆã†ã™ï¼ˆåŸå› ã®ãƒ’ãƒ³ãƒˆï¼‰</div><div id="diag-string-state" class="diag-value"></div></div>
<div class="diag-item"><div class="diag-label">ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</div><div id="diag-cond" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</div><div id="diag-maint" class="diag-value"></div></div>
      </div>
      <button onclick="resetAll()" style="background:#7ed957; border:none; padding:12px 25px; border-radius:15px; color:white; font-weight:bold; cursor:pointer;">ã‚‚ã†ã„ã¡ã©</button>
      <button onclick="location.href='game.html'" style="margin-top:10px; background:#ff914d; border:none; padding:12px 25px; border-radius:15px; color:white; font-weight:bold; cursor:pointer;">ğŸª• ã‚²ãƒ¼ãƒ ã¸</button>
    </div>

    <div class="ui-panel">
      <div class="string-btn" id="btn3" style="background:#5ce1e6" onclick="manualSelect(3)">4 G</div>
      <div class="string-btn" id="btn2" style="background:#7ed957" onclick="manualSelect(2)">3 C</div>
      <div class="string-btn" id="btn1" style="background:#ffde59; color:#4a3728" onclick="manualSelect(1)">2 E</div>
      <div class="string-btn active" id="btn0" style="background:#ff5757" onclick="manualSelect(0)">1 A</div>
    </div>
  </section>

<script>
const canvas = document.getElementById('tuningCanvas');
const ctx = canvas.getContext('2d');
const FREQS = [440.00, 329.63, 261.63, 392.00]; 
const COLORS = ["#ff5757", "#ffde59", "#7ed957", "#5ce1e6"];

// ===== Noise calibration / adaptive thresholds =====
let NOISE_RMS = 0;
let AUTO_CORR_MIN_RMS = 0.010; // autoCorrelateã®ç„¡éŸ³é–¾å€¤ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šèª¿æ•´ï¼‰
let PLUCK_HIGH_RMS = 0.012;    // ã€Œå¼¾ã„ãŸã€ã¨ã¿ãªã™éŸ³é‡ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šèª¿æ•´ï¼‰
let PLUCK_RISE_RMS = 0.010;    // ç›´å‰ãŒã“ã®å€¤æœªæº€ãªã‚‰ã€Œç«‹ã¡ä¸ŠãŒã‚Šã€ã¨ã¿ãªã™
let OK_REL_THRESH = 0.013;     // OKã®ç›¸å¯¾èª¤å·®ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šèª¿æ•´ï¼‰
let PLUCK_WINDOW_MS = 1400;    // å¼¾ã„ãŸç›´å¾Œã®åˆ¤å®šæœ‰åŠ¹æ™‚é–“ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šèª¿æ•´ï¼‰

// ===== Diagnostics (ãŒã£ã¤ã‚Šè¨ºæ–­) =====
const STRING_NAMES = ["1A", "2E", "3C", "4G"];

const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const IS_MOBILE = IS_IOS || /Android/.test(navigator.userAgent);
let __micStream = null;
let __loopToken = 0;
// ===== Mobile sensitivity tuning (PCã¯ãã®ã¾ã¾ / iPhoneã ã‘è»½ãå¼¾ã„ã¦ã‚‚åå¿œ) =====
if (IS_IOS) {
  AUTO_CORR_MIN_RMS = 0.0012;
  PLUCK_RISE_RMS = 0.0016;
  PLUCK_HIGH_RMS = 0.0020;
} else if (IS_MOBILE) {
  AUTO_CORR_MIN_RMS = 0.0075;
  PLUCK_RISE_RMS = 0.007;
  PLUCK_HIGH_RMS = 0.009;
}

function getPluckHighRms(){
  // 2Eã¨4Gã¯åå¿œã—ã¥ã‚‰ã„ç«¯æœ«ãŒã‚ã‚‹ã®ã§ã€å°‘ã—ã ã‘ç”˜ãã™ã‚‹ï¼ˆiPhoneã®ã¿ï¼‰
  if (IS_IOS && (currentTargetIdx === 1 || currentTargetIdx === 2)) return PLUCK_HIGH_RMS * 0.30; // 2ã’ã‚“/3ã’ã‚“
  if (IS_IOS && (currentTargetIdx === 3)) return PLUCK_HIGH_RMS * 0.36; // 4ã’ã‚“
  return PLUCK_HIGH_RMS;
}
function getPluckRiseRms(){
  if (IS_IOS && (currentTargetIdx === 1 || currentTargetIdx === 2)) return PLUCK_RISE_RMS * 0.28; // 2ã’ã‚“/3ã’ã‚“
  if (IS_IOS && (currentTargetIdx === 3)) return PLUCK_RISE_RMS * 0.34; // 4ã’ã‚“
  return PLUCK_RISE_RMS;
}

// ===== è¿½åŠ : ã‚²ãƒ¼ãƒ ç”¨ã—ãã„å€¤ã®ä¿å­˜ =====
const KEY_GAME_THRESH = 'uk_game_thresholds_v1';

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

function computeGameThresholds(noiseRms, pluckPeak){
  const N = (Number(noiseRms) > 0) ? Number(noiseRms) : 0.004;
  let P = Number(pluckPeak);
  if (!(P > N)) P = N + 0.012;

  // ãƒã‚¤ã‚ºã¨ã€Œãµã¤ã†ã®å¼¾ãæ–¹ã€ã®é–“ã®45%ã‚ãŸã‚Šã‚’ã—ãã„å€¤ã«ã™ã‚‹
  const high = clamp(N + (P - N) * 0.45, N * 2.2, P * 0.85);
  const rise = clamp((high - N) * 0.35, 0.0007, high * 0.60);
  return { high, rise, noise: N, pluck: P };
}

function safeSetLS(key, value){
  try{ localStorage.setItem(key, value); return true; }catch(e){ return false; }
}

function saveGameThresholdsFromTuning(){
  try{
    if (!DIAG) return;
    const N = Number(DIAG.noiseRms || NOISE_RMS || 0);
    const peaks = (DIAG.strings || []).map(s=>Number(s.rmsPeak||0)).filter(v=>v>0);
    peaks.sort((a,b)=>a-b);
    const P = peaks.length ? peaks[Math.floor(peaks.length/2)] : (N + 0.012);
    const th = computeGameThresholds(N, P);

    const obj = {
      ts: Date.now(),
      noiseRms: th.noise,
      pluckPeak: th.pluck,
      pluckHighRms: th.high,
      pluckRiseRms: th.rise,
      source: 'tuning'
    };
    safeSetLS(KEY_GAME_THRESH, JSON.stringify(obj));
  }catch(e){
    // ignore
  }
}

let DIAG = null;
let currentStringStartedAt = 0;
let lastArrowDir = null; // "up" | "down" | null

function initDiagnostics() {
  DIAG = {
    noiseRms: NOISE_RMS || 0,
    createdAt: Date.now(),
    strings: Array.from({length: 4}, (_, i) => ({
      idx: i,
      name: STRING_NAMES[i],
      startedAt: 0,
      finishedAt: 0,
      timeToOkMs: 0,
      okPitchHz: null,
      okDiffHz: null,
      okRelDiff: null,
      flips: 0,
      samplesHz: [],
      samplesRms: [],
      rmsPeak: 0,
      rmsAvg: 0,
      hzStd: 0,
      hzRange: 0
    }))
  };
  currentStringStartedAt = Date.now();
  DIAG.strings[0].startedAt = currentStringStartedAt;
  lastArrowDir = null;
}

function pushSample(idx, hz, rmsVal) {
  const s = DIAG?.strings?.[idx];
  if (!s) return;
  s.samplesHz.push(hz);
  if (s.samplesHz.length > 40) s.samplesHz.shift();
  s.samplesRms.push(rmsVal);
  if (s.samplesRms.length > 40) s.samplesRms.shift();
  if (rmsVal > s.rmsPeak) s.rmsPeak = rmsVal;
}

function finalizeString(idx, okPitchHz, targetHz) {
  const s = DIAG?.strings?.[idx];
  if (!s) return;
  const now = Date.now();
  s.finishedAt = now;
  s.timeToOkMs = Math.max(0, now - (s.startedAt || currentStringStartedAt || now));
  s.okPitchHz = okPitchHz;
  s.okDiffHz = okPitchHz - targetHz;
  s.okRelDiff = Math.abs(s.okDiffHz / targetHz);

  const hz = s.samplesHz;
  if (hz.length >= 3) {
    const mean = hz.reduce((a,b)=>a+b,0)/hz.length;
    const v = hz.reduce((a,b)=>a + (b-mean)*(b-mean),0)/hz.length;
    s.hzStd = Math.sqrt(v);
    const mn = Math.min(...hz);
    const mx = Math.max(...hz);
    s.hzRange = mx - mn;
  }

  const rr = s.samplesRms;
  if (rr.length) s.rmsAvg = rr.reduce((a,b)=>a+b,0)/rr.length;
}

function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function msToSec(ms){ return (ms/1000).toFixed(1); }

function scoreFromRelDiff(rel) {
  const v = 1 - (rel / 0.02);
  return Math.round(100 * clamp01(v));
}
function scoreFromStd(stdHz) {
  const v = 1 - (stdHz / 6.0);
  return Math.round(100 * clamp01(v));
}
function scoreFromTime(ms) {
  const v = 1 - ((ms/1000 - 1) / 19);
  return Math.round(100 * clamp01(v));
}
function scoreFromFlips(flips) {
  const v = 1 - (flips / 8);
  return Math.round(100 * clamp01(v));
}

function buildDiagnosis() {
  const strings = DIAG?.strings || [];
  const done = strings.filter(s => s.okRelDiff != null);
  if (!done.length) {
    return {
      title: "è¨ºæ–­ã§ããªã‹ã£ãŸâ€¦",
      condition: "ã‚‚ã†ä¸€åº¦ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã¿ã¦ã­ã€‚",
      maintenance: "ãƒã‚¤ã‚¯è¨±å¯ã¨é™ã‹ãªå ´æ‰€ã‚’ç¢ºèªã—ã¦ã­ã€‚"
    };
  }

  const acc = Math.round(done.reduce((a,s)=>a+scoreFromRelDiff(s.okRelDiff),0)/done.length);
  const stab = Math.round(done.reduce((a,s)=>a+scoreFromStd(s.hzStd),0)/done.length);
  const speed = Math.round(done.reduce((a,s)=>a+scoreFromTime(s.timeToOkMs),0)/done.length);
  const control = Math.round(done.reduce((a,s)=>a+scoreFromFlips(s.flips),0)/done.length);

  const total = Math.round(acc*0.4 + stab*0.3 + control*0.2 + speed*0.1);

  let title = "ãƒãƒ©ãƒ³ã‚¹è·äºº";
  if (acc >= 85 && stab >= 80) title = "ç²¾å¯†ãƒãƒ¥ãƒ¼ãƒŠãƒ¼";
  else if (speed >= 85 && control >= 75) title = "ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ãƒãƒ¥ãƒ¼ãƒŠãƒ¼";
  else if (stab < 55) title = "ã‚†ã‚‰ããƒã‚¹ã‚¿ãƒ¼";
  else if (control < 55) title = "å›ã—ã™ãæ³¨æ„å ±";

  const worstAcc = done.reduce((p,c)=> (c.okRelDiff>p.okRelDiff?c:p), done[0]);
  const worstStab = done.reduce((p,c)=> (c.hzStd>p.hzStd?c:p), done[0]);

  let condition = `ç·åˆ ${total}ç‚¹ï½œç²¾åº¦${acc} å®‰å®š${stab} æ“ä½œ${control} é€Ÿã•${speed}`;
  condition += `
ã‚ºãƒ¬ã‚„ã™ã„ï¼ˆéŸ³ãŒã¡ãŒã†æ‰€ã«è¡Œãã‚„ã™ã„ï¼‰ï¼š${worstAcc.name}ï¼ˆÂ±${(worstAcc.okRelDiff*100).toFixed(2)}%ï¼‰`;
  condition += `
æºã‚Œã‚„ã™ã„ï¼ˆéŸ³ãŒãµã‚‰ãµã‚‰å‹•ãï¼‰ï¼š${worstStab.name}ï¼ˆã‚†ã‚‰ã ${worstStab.hzStd.toFixed(1)}Hzï¼‰`;

  const tips = [];
  if ((DIAG.noiseRms || 0) >= 0.015) tips.push("å‘¨ã‚ŠãŒã«ãã‚„ã‹ã€‚é™ã‹ãªå ´æ‰€ or å£å…ƒã«è¿‘ã¥ã‘ã‚‹ã¨å®‰å®šã€‚");
  if (acc < 70) tips.push("æœ€å¾Œã®1å›ã¯çŸ­ãå¼¾ã„ã¦ã€è¡¨ç¤ºãŒè½ã¡ç€ã„ãŸç¬é–“ã«åˆã‚ã›ã‚‹ã¨ç²¾åº¦UPã€‚");
  if (stab < 65) tips.push("å¼¦ã‚’å¼·ãå¼¾ãã™ãã‚‹ã¨æºã‚Œã‚„ã™ã„ã€‚è»½ã1å›å¼¾ãã§OKã€‚");
  if (control < 65) tips.push("ãƒšã‚°ã¯â€œã¡ã‚‡ã„å›ã—â†’ç¢ºèªâ€ã®åˆ»ã¿ãŒå®‰å®šã€‚è¡ŒãéããŸã‚‰æˆ»ã—éããªã„ã€‚");

  const times = done.map(s=>s.timeToOkMs);
  const avgT = times.reduce((a,b)=>a+b,0)/times.length;
  const longOne = done.find(s=>s.timeToOkMs > avgT*1.8 && s.timeToOkMs > 8000);
  if (longOne) tips.push(`${longOne.name}ã¯åˆã‚ã›ã«ãã„å‚¾å‘ã€‚å¼¦ã®å·»ã/ãƒšã‚°æ»‘ã‚Š/å¼¦ã®åŠ£åŒ–ã‚’ãƒã‚§ãƒƒã‚¯ã€‚`);

  const maintenance = tips.length ? tips.slice(0,3).join("\n") : "ã™ã”ãè‰¯ã„æ„Ÿã˜ï¼ã“ã®ã¾ã¾å¼¾ã“ã†ï¼";
  const meaningMap = {
    "ç²¾å¯†ãƒãƒ¥ãƒ¼ãƒŠãƒ¼": "éŸ³ã‚’ãƒ”ã‚¿ãƒƒã¨æ­£ã—ãåˆã‚ã›ã‚‰ã‚Œã‚‹ã‚ˆã€‚",
    "ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ãƒãƒ¥ãƒ¼ãƒŠãƒ¼": "",
    "ã‚†ã‚‰ããƒã‚¹ã‚¿ãƒ¼": "éŸ³ãŒãµã‚‰ãµã‚‰ã—ã‚„ã™ã„æ—¥ã‹ã‚‚ã€‚",
    "å›ã—ã™ãæ³¨æ„å ±": "ãƒšã‚°ã‚’å›ã—ã™ãã¡ã‚ƒã†ã“ã¨ãŒã‚ã‚‹ã‚ˆã€‚",
    "ãƒãƒ©ãƒ³ã‚¹è·äºº": "ãƒãƒ©ãƒ³ã‚¹ã‚ˆãåˆã‚ã›ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã€‚"
  };
  const meaning = meaningMap[title] || "ä»Šæ—¥ã®èª¿å­ã‚’è¦‹ãªãŒã‚‰ã€ã‚†ã£ãã‚Šåˆã‚ã›ã¦ã„ã“ã†ã€‚";

  // ã»ã‚è¨€è‘‰ï¼ˆå¿…ãš1ã¤å…¥ã‚Œã‚‹ï¼‰
  const praise = [];
  if (speed >= 85) praise.push("ãƒ†ãƒ³ãƒã‚ˆãé€²ã‚ã‚‰ã‚Œã¦ã‚‹ï¼");
  if (control >= 80) praise.push("ãƒšã‚°æ“ä½œãŒä¸Šæ‰‹ã„ï¼");
  if (acc >= 80) praise.push("éŸ³ç¨‹ã®è©°ã‚ãŒãã‚Œã„ï¼");
  if (stab >= 75) praise.push("éŸ³ãŒå®‰å®šã—ã¦ã„ã¦æ°—æŒã¡ã„ã„ï¼");
  if (!praise.length) praise.push("æœ€å¾Œã¾ã§ã‚„ã‚Šåˆ‡ã£ãŸã®ãŒãˆã‚‰ã„ï¼");

  // â€œæœ€è¿‘å¼¾ã„ã¦ã„ãªã„ã‹ã‚‚â€ã¯æ–­å®šã—ãªã„ï¼šæ™‚é–“ãŒã‹ã‹ã‚‹/æºã‚Œã‚‹å ´åˆã«ææ¡ˆã¨ã—ã¦
  const maybeRusty = (speed < 55 || stab < 55) && (DIAG.noiseRms || 0) < 0.012;

  // å¼¦ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ¨å®š
  const wornHint = (done.some(s => s.hzStd > 4.5) && done.some(s => s.timeToOkMs > 9000));

  const scoreline = `ãã‚‡ã†ã®ã‚¦ã‚¯ãƒ¬ãƒ¬ã®èª¿å­ ${total}ç‚¹ï¼ï¼`;
  const condition2 = `${praise[0]}\n${condition}` + (maybeRusty ? "\nâ€»ã‚‚ã—ä¹…ã—ã¶ã‚Šãªã‚‰ã€æœ€åˆã®1åˆ†ã ã‘è»½ãé³´ã‚‰ã™ã¨å®‰å®šã—ã‚„ã™ã„ã‚ˆã€‚" : "");

  const tips2 = [];
  tips2.push(...tips);
  if (wornHint) tips2.push("å¼¦ãŒç–²ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã€‚æœ€è¿‘äº¤æ›ã—ã¦ã„ãªã„ãªã‚‰ã€ãã‚ãã‚äº¤æ›ã‚‚æ¤œè¨ã€‚\nï¼ˆäº¤æ›ç›´å¾Œãªã‚‰ã€ä¼¸ã³ã‚‹ã®ã§æ•°å›ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦é¦´æŸ“ã¾ã›ã¦ã­ï¼‰");
  // å¼¦åˆ¥ã²ã¨ã“ã¨
  tips2.push(`å¼¦ã®çŠ¶æ…‹ãƒ¡ãƒ¢ï¼šã‚ºãƒ¬ã‚„ã™ã„ ${worstAcc.name}ï¼æºã‚Œã‚„ã™ã„ ${worstStab.name}`);

  const simpleTips = [];
  // å­ã©ã‚‚ã§ã‚‚åˆ†ã‹ã‚‹ã€Œã‚„ã‚‹ã“ã¨ã€ã ã‘ã«ã™ã‚‹
  if ((DIAG.noiseRms || 0) >= 0.015) simpleTips.push("ã¾ã‚ã‚ŠãŒã†ã‚‹ã•ã„ã¨ãã¯ã€ãƒã‚¤ã‚¯ã«è¿‘ã¥ã‘ã¦ã­ã€‚");
  if (stab < 65) simpleTips.push("éŸ³ãŒãµã‚‰ãµã‚‰ã—ãŸã‚‰ã€å¼±ã1å›ã ã‘å¼¾ã„ã¦ã­ã€‚");
  if (control < 65) simpleTips.push("ãƒšã‚°ã¯å°‘ã—ãšã¤å›ã—ã¦ã­ï¼ˆã¡ã‚‡ã„â†’ç¢ºèªï¼‰ã€‚");
  if (acc < 70) simpleTips.push("æœ€å¾Œã¯çŸ­ãå¼¾ã„ã¦ã€æ•°å­—ãŒæ­¢ã¾ã£ãŸã¨ãã«åˆã‚ã›ã‚ˆã†ã€‚");
  if (wornHint) simpleTips.push("å¼¦ãŒå¤ã„ã‹ã‚‚ã€‚æ–°ã—ã„å¼¦ã«ã™ã‚‹ã¨è‰¯ããªã‚‹ã‚ˆã€‚");
  if (!simpleTips.length) simpleTips.push("å•é¡Œãªã—ï¼ã“ã®ã¾ã¾å¼¾ã“ã†ï¼");
  const maintenance2 = simpleTips.slice(0,3).join("\n");
  return { title, meaning, scoreline, condition: condition2, maintenance: maintenance2 };
}

let vibrations = [0, 0, 0, 0];
let playedStrings = [false, false, false, false];
let currentTargetIdx = 0; 
let audioCtx = null;
let analyser = null;
let micGain = null;
let isMonitoring = false;
let pitchHistory = [];
let ignorePluckUntil = 0;
let pluckHoldCount = 0;
let lastPluckAt = 0; // â˜…æœ€å¾Œã«ã€Œå¼¾ã„ãŸã€ã¨åˆ¤æ–­ã—ãŸæ™‚åˆ»ï¼ˆæ”¾ç½®ã§å‹æ‰‹ã«é€²ã¾ãªã„ï¼‰
let prevRms = 0;
let currentRmsVal = 0;
const SAMPLES_REQUIRED = 4; // åå¿œã‚’ã‚ˆã‚Šæ©Ÿæ•ã«ã™ã‚‹ãŸã‚æ¸›ã‚‰ã—ã¾ã—ãŸ

async function startEverything(forceReinit=false) {
  document.getElementById('start-overlay').style.display = 'none';

  // iOSã¯ã€Œã‚‚ã†ã„ã¡ã©ã€å¾Œã«Audioã®å†…éƒ¨çŠ¶æ…‹ãŒå›ºã¾ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å¿…è¦æ™‚ã¯å®Œå…¨ã«ä½œã‚Šç›´ã™
  if (forceReinit) {
    try { isMonitoring = false; } catch(e) {}
    try {
      if (__micStream) { __micStream.getTracks().forEach(t => t.stop()); }
      __micStream = null;
    } catch(e) {}
    try {
      if (audioCtx && audioCtx.state !== 'closed') await audioCtx.close();
    } catch(e) {}
    audioCtx = null;
    analyser = null;
    micGain = null;
  }

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  try {
    const audioOpts = IS_IOS
      ? { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
      : true;

    const stream = await navigator.mediaDevices.getUserMedia({ audio: audioOpts });
    __micStream = stream;

    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    micGain = audioCtx.createGain();
    micGain.gain.value = (IS_IOS ? 3.9 : 1.0);
    analyser.fftSize = (IS_IOS ? 4096 : 2048);

    source.connect(micGain);
    micGain.connect(analyser);

    // runtime reset (è¦‹ãŸç›®/UIã¯è§¦ã‚‰ãªã„)
    isMonitoring = false;
    lastPluckAt = 0;
    prevRms = 0;
    pluckHoldCount = 0;
    ignorePluckUntil = 0;
    pitchHistory = [];

    // ãƒã‚¤ã‚¯è¨±å¯ç›´å¾Œã«ç’°å¢ƒãƒã‚¤ã‚ºã‚’æ¸¬å®šã—ã¦ã€åˆ¤å®šã—ãã„å€¤ã‚’è‡ªå‹•èª¿æ•´
    await calibrateNoise(1500);
    prevRms = (NOISE_RMS || 0);
    ignorePluckUntil = Date.now() + 700;
    initDiagnostics();

    isMonitoring = true;

    // ãƒ”ãƒƒãƒãƒ«ãƒ¼ãƒ—ã¯ã€Œ1æœ¬ã ã‘ã€ã«ã™ã‚‹ï¼ˆå¤šé‡èµ·å‹•ãƒã‚°é˜²æ­¢ï¼‰
    const myToken = ++__loopToken;
    requestAnimationFrame(() => updatePitch(myToken));

    document.getElementById('nav-text').innerText = "ãã„ã¦ã‚‹ã‚ˆ...";
  } catch (err) {
    alert("ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã€‚");
  }
}

async function calibrateNoise(durationMs = 1500) {
  // ãƒã‚¤ã‚¯è¨±å¯ç›´å¾Œã«ç’°å¢ƒãƒã‚¤ã‚ºï¼ˆrmsï¼‰ã‚’è¨ˆæ¸¬ã—ã¦ã€åˆ¤å®šã—ãã„å€¤ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹
  const navText = document.getElementById('nav-text');
  const guide = document.getElementById('guide-msg');
  const navArrow = document.getElementById('nav-arrow');
  navArrow.innerText = "";
  navText.innerText = "";
  guide.innerText = "ç’°å¢ƒãƒã‚¤ã‚ºæ¸¬å®šä¸­â€¦ï¼ˆå¼¾ã‹ãªã„ã§ã­ï¼‰";

  const samples = [];
  const buffer = new Float32Array(analyser.fftSize);
  const start = Date.now();

  while (Date.now() - start < durationMs) {
    analyser.getFloatTimeDomainData(buffer);
    let rms = 0;
    for (let i = 0; i < buffer.length; i++) {
      const v = buffer[i];
      rms += v * v;
    }
    const rmsVal = Math.sqrt(rms / buffer.length);
    samples.push(rmsVal);

    // 60fpsæƒ³å®šã®è»½ã„ã‚¦ã‚§ã‚¤ãƒˆ
    await new Promise(r => setTimeout(r, 50));
  }

  samples.sort((a,b) => a-b);
  const avg = samples.reduce((a,b)=>a+b,0) / Math.max(1, samples.length);
  const p90 = samples[Math.floor(samples.length * 0.90)] ?? avg;

  NOISE_RMS = p90;

  // ã—ãã„å€¤ã‚’ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®šï¼ˆå®‰å…¨å¯„ã‚Šï¼‰
  // - ãƒã‚¤ã‚ºãŒå¤§ãã„ã»ã©ã€Œç„¡éŸ³åˆ¤å®šã€ã¨ã€Œå¼¾ã„ãŸåˆ¤å®šã€ã‚’ä¸Šã’ã‚‹
  // - iPhoneã¯rmsãŒå°ã•ãè¦‹ãˆã‚„ã™ã„ã®ã§ã€iPhoneã ã‘åˆ¥ã‚¹ã‚±ãƒ¼ãƒ«ã§ä¸‹ã’ã‚‹ï¼ˆPCã®æŒ™å‹•ã¯ç¶­æŒï¼‰
  if (IS_IOS) {
    const auto = p90 * 2.5;
    const rise = p90 * 2.0;
    const high = p90 * 3.0;

    // iPhoneç”¨ï¼šä¸‹é™(åºŠ)ã‚’æ®‹ã—ã¤ã¤ã€ç’°å¢ƒãƒã‚¤ã‚ºã§è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«
    AUTO_CORR_MIN_RMS = Math.min(0.0040, Math.max(0.0012, auto * 0.25));
    PLUCK_RISE_RMS    = Math.min(0.0060, Math.max(0.0016, rise * 0.25));
    PLUCK_HIGH_RMS    = Math.min(0.0080, Math.max(0.0020, high * 0.25));
  } else {
    AUTO_CORR_MIN_RMS = Math.max(0.010, p90 * 2.5);
    PLUCK_RISE_RMS    = Math.max(0.010, p90 * 2.0);
    PLUCK_HIGH_RMS    = Math.max(0.012, p90 * 3.0);

    // ãƒ¢ãƒã‚¤ãƒ«ï¼ˆAndroidç­‰ï¼‰ã¯å°‘ã—ã ã‘æ„Ÿåº¦ã‚’ä¸Šã’ã‚‹
    if (IS_MOBILE) {
      AUTO_CORR_MIN_RMS = Math.max(0.007, AUTO_CORR_MIN_RMS * 0.75);
      PLUCK_RISE_RMS    = Math.max(0.007, PLUCK_RISE_RMS * 0.75);
      PLUCK_HIGH_RMS    = Math.max(0.009, PLUCK_HIGH_RMS * 0.75);
    }
  }

  // - ãƒã‚¤ã‚ºãŒå¤§ãã„ã»ã©OKåˆ¤å®šã‚’å°‘ã—ç”˜ãã€åˆ¤å®šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å°‘ã—é•·ã
  if (p90 < 0.008) {
    OK_REL_THRESH = 0.012;      // é™ã‹ï¼šå°‘ã—å³ã—ã‚
    PLUCK_WINDOW_MS = 1200;
    guide.innerText = "é™ã‹ã§æ¤œå‡ºã—ã‚„ã™ã„ã‚ˆï¼";
  } else if (p90 < 0.015) {
    OK_REL_THRESH = 0.013;      // æ™®é€š
    PLUCK_WINDOW_MS = 1400;
    guide.innerText = "ç’°å¢ƒãƒã‚¤ã‚ºï¼šãµã¤ã†ï¼ˆOKï¼‰";
  } else {
    OK_REL_THRESH = 0.016;      // ã†ã‚‹ã•ã„ï¼šå°‘ã—ç”˜ã
    PLUCK_WINDOW_MS = 1800;
    guide.innerText = "å‘¨ã‚ŠãŒã«ãã‚„ã‹ã‹ã‚‚ã€‚å°‘ã—å¼·ã‚ã«å¼¾ã„ã¦ã­ï¼";
  }

  // 1ç§’ã ã‘è¡¨ç¤ºã—ã¦ã‹ã‚‰æˆ»ã™
  await new Promise(r => setTimeout(r, 1900));
  guide.innerText = `${currentTargetIdx+1}ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†`;
  navText.innerText = "";
}


function updatePitch(token) {
  if (token !== __loopToken) return;
  // ãƒ«ãƒ¼ãƒ—ã¯æ­¢ã‚ãªã„ï¼ˆæ­¢ã‚ã‚‹ã¨å†é–‹ã§ããšã€Œå†èµ·å‹•ãŒå¿…è¦ã€ã«ãªã‚‹ï¼‰
  if (!isMonitoring) {
    requestAnimationFrame(() => updatePitch(token));
    return;
  }

  const buffer = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buffer);

  // â˜…ç°¡æ˜“RMSï¼ˆå¼¾ã„ãŸç¬é–“ã®æ¤œå‡ºã«ä½¿ã†ï¼‰
  let rms = 0;
  for (let i = 0; i < buffer.length; i++) {
    const v = buffer[i];
    rms += v * v;
  }
  const rmsVal = Math.sqrt(rms / buffer.length);
  currentRmsVal = rmsVal;

  // â˜…ã€Œå¼¾ã„ãŸã€æ¤œå‡ºï¼šiPhoneã¯ãƒã‚¤ã‚ºåºŠãŒé«˜ããªã‚Šã‚„ã™ã„ã®ã§ã€Œå·®åˆ†ã€ã‚‚è¦‹ã‚‹
  // ===== Pluck detection (iPhone 2/3/4ã’ã‚“ã‚’ã•ã‚‰ã«ç”˜ã) =====
  const highTh = (typeof getPluckHighRms === 'function') ? getPluckHighRms() : PLUCK_HIGH_RMS;
  const riseTh = (typeof getPluckRiseRms === 'function') ? getPluckRiseRms() : PLUCK_RISE_RMS;

  const noiseBase = (NOISE_RMS || 0);

  // iPhoneã¯å¼¦ã«ã‚ˆã£ã¦åå¿œå·®ãŒå‡ºã‚„ã™ã„ã®ã§ã€2ã’ã‚“(E2)ã‚’ã•ã‚‰ã«ç”˜ã
  const isE2 = (IS_IOS && currentTargetIdx === 1);
  const isC3 = (IS_IOS && currentTargetIdx === 2);
  const isG4 = (IS_IOS && currentTargetIdx === 3);

  let relTh = (IS_IOS ? 1.20 : 1.70);
  if (isE2) relTh = 0.82;          // 2ã’ã‚“ï¼ˆã•ã‚‰ã«ç”˜ãï¼‰          // 2ã’ã‚“ï¼ˆã•ã‚‰ã«1æ®µéšã•ã’ï¼‰
  else if (isC3) relTh = 0.98;     // 3ã’ã‚“ï¼ˆç”˜ãï¼‰     // 3ã’ã‚“
  else if (isG4) relTh = 1.02; // 4ã’ã‚“ï¼ˆå°‘ã—ç”˜ãï¼‰ // 4ã’ã‚“ï¼ˆ1æ®µéšã•ã’ï¼‰

  // ãƒã‚¤ã‚ºé€£å‹•ã—ãã„å€¤ï¼ˆå‘¨å›²éŸ³ã«å¼•ã£å¼µã‚‰ã‚Œã™ããªã„ã‚ˆã†ã«ä¸Šé™ï¼‰
  const rawByNoise = noiseBase > 0 ? (noiseBase * relTh) : 0;
  let cap = Infinity;
  if (isE2) cap = 0.0098;          // 2ã’ã‚“ï¼ˆä¸‹ã’ï¼‰          // 2ã’ã‚“ï¼ˆã•ã‚‰ã«1æ®µéšã•ã’ï¼‰
  else if (isC3) cap = 0.0120;
  else if (isG4) cap = 0.0140;
  else if (IS_IOS) cap = 0.018;

  const highByNoise = Math.min(rawByNoise, cap);
  const high = Math.max(highTh, highByNoise);
  // ã—ãã„å€¤ã®å¾®èª¿æ•´ï¼ˆè¿½åŠ ã®æ®µéšèª¿æ•´ï¼‰
  // - 2ã’ã‚“ã¯ã•ã‚‰ã« 0.001 ä¸‹ã’
  // - 4ã’ã‚“ã¯ 0.0005 ä¸‹ã’
  const floorBase = (IS_IOS ? 0.0005 : 0.006);
  const highAdj = Math.max(floorBase, high - (isE2 ? 0.0014 : (IS_IOS && currentTargetIdx === 3 ? 0.0005 : 0)));


  const rise = rmsVal - prevRms;

  // èª¤åˆ¤å®šå¯¾ç­–ï¼š
  // - ãƒœã‚¿ãƒ³æ“ä½œç›´å¾Œã¯ç„¡åŠ¹åŒ–
  // - ã€ŒprevRmsãŒå°ã•ã„ã ã‘ã€ã§OKã«ã—ãªã„
  const now = Date.now();
  const canUpdatePluck = now >= (ignorePluckUntil || 0);

  // iPhone 2ã’ã‚“ã¯ç«‹ã¡ä¸ŠãŒã‚Šæœ€å°å€¤ã‚’å°‘ã—ä¸‹ã’ã‚‹ï¼ˆãŸã ã—2ãƒ•ãƒ¬ãƒ¼ãƒ é€£ç¶šã§ç¢ºå®šï¼‰
  const riseMin = isE2 ? 0.0008 : (isC3 ? 0.0014 : (isG4 ? 0.0018 : (IS_IOS ? 0.0028 : 0.004)));
  const riseNeed = Math.max(riseTh * (IS_IOS ? 0.32 : 0.55), riseMin);

  const candidate = canUpdatePluck && (rmsVal > highAdj) && (rise > riseNeed);

  // 2ãƒ•ãƒ¬ãƒ¼ãƒ é€£ç¶šã§ candidate ã®ã¨ãã ã‘ pluck ã¨ã¿ãªã™ï¼ˆæ„Ÿåº¦â†‘ã§ã‚‚èª¤åˆ¤å®šâ†“ï¼‰
  if (candidate) pluckHoldCount = Math.min(pluckHoldCount + 1, 6);
  else pluckHoldCount = Math.max(pluckHoldCount - 1, 0);

  if (pluckHoldCount >= 2) {
    lastPluckAt = now;
    pluckHoldCount = 0;
  }

  prevRms = rmsVal;

  // â˜…æ”¾ç½®å¯¾ç­–ï¼šå¼¾ã„ãŸç›´å¾Œ(2.5ç§’)ã ã‘åˆ¤å®šã™ã‚‹
  const isInPluckWindow = (Date.now() - lastPluckAt) < PLUCK_WINDOW_MS;
  if (!isInPluckWindow) {
    // è¡¨ç¤ºã ã‘è»½ãæ¡ˆå†…ï¼ˆé »ç¹ã«æ›¸ãæ›ãˆãŸããªã„ã®ã§æ§ãˆã‚ï¼‰
    const navText = document.getElementById('nav-text');
  const guide = document.getElementById('guide-msg');
    if (!navText.innerText || navText.innerText.includes("æ”¾ç½®") || navText.innerText.includes("å¼¾ã„ã¦")) {
      guide.innerText = `${currentTargetIdx+1}ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†`;
  navText.innerText = "";
    }
    requestAnimationFrame(() => updatePitch(token));
    return;
  }

  const pitchRaw = autoCorrelate(buffer, audioCtx.sampleRate);

  if (pitchRaw !== -1) {
    const target = FREQS[currentTargetIdx];

    // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–è£œæ­£ï¼štargetè¿‘è¾ºã«å¯„ã›ã‚‹ï¼ˆå€éŸ³/ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–èª¤æ¤œå‡ºå¯¾ç­–ï¼‰
    let pitch = pitchRaw;
    while (pitch < target * 0.8) pitch *= 2;
    while (pitch > target * 1.2) pitch /= 2;

    // æœ€çµ‚ã‚²ãƒ¼ãƒˆï¼ˆå°‘ã—ä½™è£•ï¼‰
    if (pitch > target * 0.85 && pitch < target * 1.15) {
      processPitch(pitch);
    }
  }

  requestAnimationFrame(() => updatePitch(token));
}

function processPitch(detectedPitch) {
  const target = FREQS[currentTargetIdx];
  pitchHistory.push(detectedPitch);
  if (pitchHistory.length > SAMPLES_REQUIRED) pitchHistory.shift();

  if (pitchHistory.length === SAMPLES_REQUIRED) {
    const avgPitch = pitchHistory.reduce((a, b) => a + b) / SAMPLES_REQUIRED;
    const diff = avgPitch - target;
    try { pushSample(currentTargetIdx, avgPitch, (typeof currentRmsVal==='number'?currentRmsVal:0)); } catch(e) {}
    const navArrow = document.getElementById('nav-arrow');
    const navText = document.getElementById('nav-text');
  const guide = document.getElementById('guide-msg');

    navText.innerText = `ã„ã¾: ${avgPitch.toFixed(1)} Hz / ç›®æ¨™: ${target.toFixed(2)} Hz`;

    // â˜…OKåˆ¤å®šï¼šç›¸å¯¾èª¤å·®ã§å®‰å®šåŒ–ï¼ˆå¼¦ãŒé•ã†ã®ã«OKã«ãªã‚‹äº‹æ•…ã‚’é˜²ãï¼‰
    const relDiff = Math.abs(diff / target);
    let arrowDir = null;
    if (relDiff < OK_REL_THRESH) arrowDir = 'ok';
    else if (diff > 0) arrowDir = 'down';
    else arrowDir = 'up';
    if (arrowDir === 'up' || arrowDir === 'down') {
      if (lastArrowDir && lastArrowDir !== arrowDir) {
        const s = DIAG?.strings?.[currentTargetIdx];
        if (s) s.flips = (s.flips || 0) + 1;
      }
      lastArrowDir = arrowDir;
    }

    // â˜…1å¼¦(A)ã®èª¤å‹•ä½œå¯¾ç­–ï¼šéŸ³é‡ãŒååˆ†ã§ã€ã‹ã¤åˆ¤å®šã‚’å°‘ã—å³ã—ã‚ã«ã™ã‚‹
    const okThreshold = (currentTargetIdx === 0) ? 0.008 : 0.013; // Aã ã‘å°‘ã—å³ã—ã
    const minRmsForOk = (currentTargetIdx === 0) ? 0.018 : 0.012; // Aã ã‘éŸ³é‡è¦æ±‚

    if (relDiff < okThreshold && currentRmsVal >= minRmsForOk) { // ç´„Â±1%
      navArrow.innerText = "âœ¨";
      try { finalizeString(currentTargetIdx, avgPitch, target); } catch(e) {}
      navArrow.className = "";
      navText.innerText = `ã‚ªãƒƒã‚±ãƒ¼ï¼ï¼ˆã„ã¾: ${avgPitch.toFixed(1)} Hzï¼‰`;
      vibrations[currentTargetIdx] = 40;

      // é€£ç¶šOKé€£æ‰“é˜²æ­¢ï¼šçŸ­æ™‚é–“ã ã‘æ­¢ã‚ã¦æ¬¡ã¸
      isMonitoring = false;
      setTimeout(() => {
        markAsDone(currentTargetIdx);
        isMonitoring = true;
        // æ¬¡ã®å¼¦ã¸ç§»ã£ãŸç›´å¾Œã¯ã€Œå¼¾ã„ãŸã€åˆ¤å®šå¾…ã¡ã«ã™ã‚‹
        lastPluckAt = 0;
        ignorePluckUntil = Date.now() + 450;
  pluckHoldCount = 0;
        prevRms = (typeof currentRmsVal === "number" ? currentRmsVal : (NOISE_RMS || 0));
        pitchHistory = [];
      }, 600);

    } else if (diff > 0) {
      navArrow.innerText = "â†“";
      navArrow.className = "arrow-down";
      navText.innerText = `ã™ã“ã— ã‚†ã‚‹ã‚ã¦ï¼ï¼ˆã„ã¾: ${avgPitch.toFixed(1)} Hzï¼‰`;
    } else {
      navArrow.innerText = "â†‘";
      navArrow.className = "arrow-up";
      navText.innerText = `ã™ã“ã— ã—ã‚ã¦ï¼ï¼ˆã„ã¾: ${avgPitch.toFixed(1)} Hzï¼‰`;
    }
  }
}

function markAsDone(idx) {
  if (playedStrings[idx]) return;
  playedStrings[idx] = true;

  const btn = document.getElementById(`btn${idx}`);
  btn.classList.add('played');
  btn.classList.remove('active');

  pitchHistory = [];
  document.getElementById('nav-arrow').innerText = "";

  // æ¬¡ã®æœªå®Œäº†å¼¦ã¸è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆ
  let next = playedStrings.indexOf(false);
  if (next !== -1) {
    currentTargetIdx = next;
    try {
      currentStringStartedAt = Date.now();
      if (DIAG?.strings?.[next]) DIAG.strings[next].startedAt = currentStringStartedAt;
      lastArrowDir = null;
    } catch(e) {}

    // activeè¡¨ç¤ºã‚’æ›´æ–°
    document.querySelectorAll('.string-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn${next}`).classList.add('active');

    document.getElementById('guide-msg').innerText = `${idx+1}ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†`;
    ignorePluckUntil = Date.now() + 350;
    pluckHoldCount = 0;
    prevRms = (typeof currentRmsVal === "number" ? currentRmsVal : (NOISE_RMS || 0));
    document.getElementById('nav-text').innerText = "å¼¾ã„ã¦ã­â€¦";
  } else {
    document.getElementById('guide-msg').innerText = "ãœã‚“ã¶ ã§ããŸã­ï¼";
    document.getElementById('nav-text').innerText = "";
    saveGameThresholdsFromTuning();
    setTimeout(doDiagnosis, 800);
  }
}

// â˜…æ‰‹å‹•ãƒœã‚¿ãƒ³ã¯ã€Œå³ã‚¯ãƒªã‚¢ã€ã§ã¯ãªãã€Œåˆ‡æ›¿ã€ã«å¤‰æ›´
function manualSelect(idx) {
  // ä»»æ„ã®å¼¦ã‚’é¸æŠã—ã¦å†ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãã‚‹ï¼ˆå®Œäº†æ¸ˆã¿ã§ã‚‚OKï¼‰
  currentTargetIdx = idx;
  pitchHistory = [];
  lastPluckAt = 0;
  ignorePluckUntil = Date.now() + 450;
  pluckHoldCount = 0;
  prevRms = (typeof currentRmsVal === "number" ? currentRmsVal : (NOISE_RMS || 0));

  // å®Œäº†æ¸ˆã¿ã‚’é¸ã‚“ã å ´åˆã¯ã€Œæœªå®Œäº†ã€ã«æˆ»ã™ï¼ˆãã“ã‹ã‚‰å…ˆã‚’ã‚„ã‚Šç›´ã›ã‚‹ï¼‰
  if (playedStrings[idx]) {
    playedStrings[idx] = false;
    const btn = document.getElementById(`btn${idx}`);
    btn.classList.remove('played');
  }

  // activeè¡¨ç¤ºã‚’æ›´æ–°
  document.querySelectorAll('.string-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`btn${idx}`).classList.add('active');

  document.getElementById('guide-msg').innerText = `${idx+1}ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†`;
    ignorePluckUntil = Date.now() + 350;
    pluckHoldCount = 0;
    prevRms = (typeof currentRmsVal === "number" ? currentRmsVal : (NOISE_RMS || 0));

  document.getElementById('nav-arrow').innerText = "";
  document.getElementById('nav-text').innerText = "å¼¾ã„ã¦ã­â€¦";
  isMonitoring = true;
}

// ãƒ”ãƒƒãƒæ¤œå‡ºï¼šå°éŸ³é‡ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«é–¾å€¤ã‚’èª¿æ•´
function autoCorrelate(buf, sampleRate) {
  let SIZE = buf.length;
  let rms = 0;
  for (let i=0;i<SIZE;i++) { let val = buf[i]; rms += val*val; }
  if (Math.sqrt(rms/SIZE) < AUTO_CORR_MIN_RMS) return -1; // 0.01ã‹ã‚‰0.005ã¸ä¸‹ã’ã€æ„Ÿåº¦ã‚¢ãƒƒãƒ—

  let r1=0, r2=SIZE-1, thres=0.2;
  for (let i=0; i<SIZE/2; i++) if (Math.abs(buf[i]) < thres) { r1=i; break; }
  for (let i=1; i<SIZE/2; i++) if (Math.abs(buf[SIZE-i]) < thres) { r2=SIZE-i; break; }
  buf = buf.slice(r1,r2);
  SIZE = buf.length;
  let c = new Float32Array(SIZE);
  for (let i=0; i<SIZE; i++) for (let j=0; j<SIZE-i; j++) c[i] = c[i] + buf[j]*buf[j+i];
  let d=0; while (c[d]>c[d+1]) d++;
  let maxval=-1, maxpos=-1;
  for (let i=d; i<SIZE; i++) { if (c[i] > maxval) { maxval = c[i]; maxpos = i; } }
  return sampleRate/maxpos;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const midY = canvas.height / 2;
  const nutX = 180;
  ctx.fillStyle = "#6d4c41"; ctx.fillRect(nutX, midY - 150, canvas.width, 300);
  const fretW = (canvas.width - nutX - 100) / 12;
  for (let i = 0; i <= 12; i++) {
    const x = nutX + i * fretW;
    ctx.strokeStyle = (i === 0) ? "#fff" : "#a1887f"; ctx.lineWidth = (i === 0) ? 12 : 3;
    ctx.beginPath(); ctx.moveTo(x, midY - 150); ctx.lineTo(x, midY + 150); ctx.stroke();
  }
    const labels = ['1A','2E','3C','4G'];
for (let i = 0; i < 4; i++) {
    const y = midY + (i - 1.5) * 75;
    const isActive = (i === currentTargetIdx);

    // å·¦ã®ã‚·ãƒ³ãƒœãƒ«ï¼ˆè‰²ã¤ãã€‡ï¼‰â€»æ–‡å­—åˆ—ã®ç¾…åˆ—ã‚’ã‚„ã‚ã¦è¦–è¦šã§åˆ†ã‹ã‚‹ã‚ˆã†ã«
    const cx = 125;
    const r = isActive ? 27 : 24;
    ctx.beginPath();
    ctx.fillStyle = COLORS[i];
    ctx.globalAlpha = isActive ? 1.0 : 0.85;
    ctx.arc(cx, y, r, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1.0;

    // ä¸­ã« 1A / 2E ... ã‚’å…¥ã‚Œã‚‹ï¼ˆå°ã•ã‚ï¼‰
    ctx.fillStyle = '#fff';
    ctx.font = isActive ? 'bold 18px sans-serif' : 'bold 16px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(labels[i], cx, y);

    // å¼¦ï¼ˆæŒ¯å‹•ï¼‰
    const vib = Math.sin(Date.now() * 0.15) * vibrations[i];
    vibrations[i] *= 0.94;
    ctx.strokeStyle = COLORS[i]; ctx.lineWidth = 8;
    ctx.beginPath(); ctx.moveTo(nutX, y);
    ctx.quadraticCurveTo(nutX + (canvas.width - nutX)/2, y + vib, canvas.width, y);
    ctx.stroke();
  }
  // ä»¥é™ã®æç”»ã§ textAlign ã‚’æˆ»ã™
  ctx.textAlign = 'start';
  ctx.textBaseline = 'alphabetic';
  requestAnimationFrame(draw);
}


// ===== SE (è»½ã„ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«é¢¨) =====
let _seCtx = null;
function getSeCtx(){
  if (!_seCtx) _seCtx = new (window.AudioContext || window.webkitAudioContext)();
  return _seCtx;
}
function playTick(){
  try{
    const ctx = getSeCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.value = 180 + Math.random()*60;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.06);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.07);
  }catch(e){}
}
function playTaDa(){
  try{
    const ctx = getSeCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(660, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.12);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.26);
  }catch(e){}
}


function resetAll() {
  // è¨ºæ–­ç”»é¢ã‚’é–‰ã˜ã¦ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
  document.getElementById('diagnosis-card').classList.remove('show');
  const splash = document.getElementById('diagnosis-splash');
  if (splash) splash.classList.remove('show');

  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  playedStrings = [false, false, false, false];
  vibrations = [0, 0, 0, 0];
  currentTargetIdx = 0;
  pitchHistory = [];
  lastPluckAt = 0;
  ignorePluckUntil = Date.now() + 700;
  pluckHoldCount = 0;
  prevRms = (typeof currentRmsVal === "number" ? currentRmsVal : (NOISE_RMS || 0));
  lastArrowDir = null;

  // ãƒœã‚¿ãƒ³è¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.string-btn').forEach(b => {
    b.classList.remove('played');
    b.classList.remove('active');
  });
  const b0 = document.getElementById('btn0');
  if (b0) b0.classList.add('active');

  // ã‚¬ã‚¤ãƒ‰æ–‡ã‚’1ã’ã‚“ã«æˆ»ã™
  const guide = document.getElementById('guide-msg');
  if (guide) guide.innerText = "1ã’ã‚“ã‚’ ã²ã„ã¦ã¿ã‚ˆã†";
  const nav = document.getElementById('nav-text');
  if (nav) nav.innerText = "å¼¾ã„ã¦ã­â€¦";
  const arrow = document.getElementById('nav-arrow');
  if (arrow) arrow.innerText = "";

  // è¨ºæ–­ãƒ­ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ
  try { initDiagnostics(); } catch(e) {}

  // ç›£è¦–ã‚’å†é–‹ï¼ˆiOSã¯å¿µã®ãŸã‚Audioã‚’ä½œã‚Šç›´ã™ï¼‰
  isMonitoring = true;

  if (IS_IOS) {
    // iOS: ã€Œã‚‚ã†ã„ã¡ã©ã€ã§å›ºã¾ã‚‹/é…ã‚Œã¦æ€¥ã«æ‹¾ã†å¯¾ç­–ã¨ã—ã¦ã€AudioContextã¨Streamã‚’ä½œã‚Šç›´ã™
    startEverything(true);
    return;
  }

  // éiOS: ãƒã‚¤ã‚¯ã¯ãã®ã¾ã¾ãƒ»ãƒ«ãƒ¼ãƒ—ã ã‘ã‚’ç¢ºå®Ÿã«å˜ç‹¬å†èµ·å‹•
  const myToken = ++__loopToken;
  requestAnimationFrame(() => updatePitch(myToken));
}



function computeUkulelePersonality(diag, ukuleleDiagText, conditionKidText){
  // Returns: "ã“ã®å­ã¯ã€â—¯â—¯ã§ã™ã€‚"
  // Sets: window.__personalityReason (short text)
  try{
    const done = (diag?.strings || []).filter(s => s && (s.okRelDiff != null || s.hzStd != null || s.rmsAvg != null));
    if (!done.length){
      window.__personalityReason = "ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ã‚ˆã€‚";
      return "ã“ã®å­ã¯ã€ã²ã‹ãˆã‚ã§ã™ã€‚";
    }

    const rmsAvg = done.reduce((a,s)=>a+(Number(s.rmsAvg||0)),0)/done.length;
    const jitterAvg = done.reduce((a,s)=>a+(Number(s.hzStd||0)),0)/done.length;
    const driftAvg = done.reduce((a,s)=>a+Math.abs(Number(s.okRelDiff||0)),0)/done.length;
    const jitterMax = Math.max(...done.map(s=>Number(s.hzStd||0)));
    const driftMax  = Math.max(...done.map(s=>Math.abs(Number(s.okRelDiff||0))));

    const clamp01 = (x)=>Math.max(0, Math.min(1, x));

    // normalize
    const loud   = clamp01((rmsAvg - 0.010) / 0.020);          // 0.010..0.030
    const quiet  = 1 - loud;
    const stable = 1 - clamp01((jitterAvg - 3) / 10);          // <=3 good, >=13 bad
    const accurate = 1 - clamp01((driftAvg - 0.004) / 0.016);  // <=0.4% good, >=2.0% bad (rel diff)
    const incons = clamp01(((jitterMax - jitterAvg) + (driftMax - driftAvg)) / 10);

    const score = { "ã¾ã˜ã‚":0,"ã®ã³ã®ã³":0,"ãã‚‰ãã‚‰":0,"ã’ã‚“ã":0,"ãã¾ãã‚Œ":0,"ã²ã‹ãˆã‚":0 };

    score["ã²ã‹ãˆã‚"] = quiet*1.4 + (1-loud)*0.2;
    score["ã¾ã˜ã‚"]   = stable*1.2 + accurate*1.1 - incons*0.3;
    score["ãã‚‰ãã‚‰"] = loud*1.2 + accurate*0.9 - (1-stable)*0.2;

    const lively = clamp01((jitterAvg - 2) / 10);
    score["ã’ã‚“ã"]   = loud*1.0 + lively*0.9 + accurate*0.2;
    score["ã®ã³ã®ã³"] = loud*0.7 + stable*0.6 + (1-accurate)*0.3;
    // ãã¾ãã‚Œï¼šæœ¬å½“ã«ã€Œã°ã‚‰ã¤ãã€ãŒå¼·ã„æ™‚ã ã‘å‡ºã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆå‡ºéãé˜²æ­¢ï¼‰
    const kJ = clamp01((jitterAvg - 9) / 10);              // å¹³å‡ã‚†ã‚ŒãŒå¤§ãã„æ™‚ï¼ˆé–¾å€¤ã‚’ä¸Šã’ã‚‹ï¼‰
    const kI = clamp01((incons - 0.25) / 0.75);            // å¼¦ã”ã¨ã®å·®ãŒå¤§ãã„æ™‚
    const kD = clamp01((driftMax - 0.018) / 0.015);        // æœ€å¤§ã‚ºãƒ¬ãŒå¤§ãã„æ™‚ï¼ˆ1.8%ã€œï¼‰
    score["ãã¾ãã‚Œ"] = (kJ*0.6 + kI*0.9 + kD*0.3) - stable*0.25;

    let best = "ã¾ã˜ã‚", bestVal = -1;
    Object.keys(score).forEach(k=>{ if (score[k] > bestVal){ bestVal = score[k]; best = k; } });

    // --- Consistency with ukulele diagnosis ---
    const u = String(ukuleleDiagText||"");
    const isLowEnergy = u.includes("å…ƒæ°—ãŒãªã„") || u.includes("ã¾ã æœ¬æ°—") || u.includes("ã“ã‚Œã‹ã‚‰éŸ³ãŒã‚ˆã");
    if (isLowEnergy){
      if (best === "ã’ã‚“ã") best = "ãã¾ãã‚Œ";
      if (best === "ãã‚‰ãã‚‰") best = (quiet > 0.55) ? "ã²ã‹ãˆã‚" : "ã¾ã˜ã‚";
    }

    // --- Consistency with condition text ---
    const c = String(conditionKidText||"");
    const hasDrift = c.includes("ã‚ºãƒ¬ã‚„ã™ã„");
    const hasJitter = c.includes("ã‚†ã‚Œã‚„ã™ã„") || c.includes("æºã‚Œã‚„ã™ã„");

    
    // ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯ï¼šå®‰å®šãƒ»ç²¾åº¦ãŒãã“ãã“ã‚ã‚‹ã®ã«ã€Œãã¾ãã‚Œã€ã«ãªã‚‹ã®ã‚’é˜²ã
    if (best === "ãã¾ãã‚Œ" && stable > 0.55 && accurate > 0.55 && incons < 0.55){
      best = loud > 0.45 ? "ãã‚‰ãã‚‰" : "ã¾ã˜ã‚";
    }
let reason = "ãƒãƒ©ãƒ³ã‚¹å‹";
    if (best === "ã²ã‹ãˆã‚") reason = "éŸ³ãŒå°ã•ã‚";
    else if (best === "ã¾ã˜ã‚") reason = (hasDrift || hasJitter) ? "è½ã¡ã¤ã„ã¦ã„ã‚‹ã‘ã©ã€å°‘ã—ã‚ºãƒ¬/ã‚†ã‚ŒãŒå‡ºã‚‹" : "ã‚†ã‚ŒãŒå°‘ãªã‚ãƒ»ã‚ºãƒ¬ã‚‚å°‘ãªã‚";
    else if (best === "ãã‚‰ãã‚‰") reason = (hasDrift || hasJitter) ? "éŸ³ãŒã—ã£ã‹ã‚Šï¼ˆã§ã‚‚ä»Šæ—¥ã¯å°‘ã—ã‚†ã‚Œã‚„ã™ã„ï¼‰" : "éŸ³ãŒã—ã£ã‹ã‚Šãƒ»ã‚ºãƒ¬å°‘ãªã‚";
    else if (best === "ã’ã‚“ã") reason = "éŸ³ãŒå¤§ãã‚";
    else if (best === "ã®ã³ã®ã³") reason = "éŸ³ãŒã®ã³ã¦ã‚‹";
    else if (best === "ãã¾ãã‚Œ") reason = "ã‚†ã‚ŒãŸã‚Šã‚ºãƒ¬ãŸã‚ŠãŒå‡ºã‚„ã™ã„";

    if (isLowEnergy && (best === "ã¾ã˜ã‚" || best === "ã²ã‹ãˆã‚")){
      reason = (best === "ã¾ã˜ã‚") ? "éŸ³ã¯ãŠã¡ã¤ã„ã¦ã‚‹ï¼ˆã§ã‚‚ä»Šã¯å…ƒæ°—å°‘ãªã‚ï¼‰" : "éŸ³ãŒå°ã•ã‚ï¼ˆä»Šã¯å…ƒæ°—å°‘ãªã‚ï¼‰";
    }

    window.__personalityReason = reason;
    return "ã“ã®å­ã¯ã€" + best + "ã§ã™ã€‚";
  }catch(e){
    window.__personalityReason = "åˆ¤å®šã§ããªã‹ã£ãŸã‚ˆã€‚";
    return "ã“ã®å­ã¯ã€ã¾ã˜ã‚ã§ã™ã€‚";
  }
}




const faceMapSvg = {
  "ğŸ˜ƒ": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ğŸ˜": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ğŸ¤©": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%3Cpath%20d%3D%22M18%2026%20L22%2036%20L12%2032%20L22%2032%20L18%2036%20Z%22%20fill%3D%22%237a5cff%22/%3E%0A%20%20%3Cpath%20d%3D%22M102%2028%20L106%2038%20L96%2034%20L106%2034%20L102%2038%20Z%22%20fill%3D%22%2300b3ff%22/%3E%0A%20%20%3Cpath%20d%3D%22M20%2092%20L24%20102%20L14%2098%20L24%2098%20L20%20102%20Z%22%20fill%3D%22%23ff5ca8%22/%3E%0A%20%20%3Cpath%20d%3D%22M100%2092%20L104%20102%20L94%2098%20L104%2098%20L100%20102%20Z%22%20fill%3D%22%237dff5c%22/%3E%0A%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Cpath%20d%3D%22M36%2044%20L41%2058%20L26%2049%20L46%2049%20L31%2058%20Z%22%20fill%3D%22%237a5cff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%222%22/%3E%3Cpath%20d%3D%22M76%2044%20L81%2058%20L66%2049%20L86%2049%20L71%2058%20Z%22%20fill%3D%22%237a5cff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%222%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ğŸ¥³": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%3Cpath%20d%3D%22M18%2026%20L22%2036%20L12%2032%20L22%2032%20L18%2036%20Z%22%20fill%3D%22%237a5cff%22/%3E%0A%20%20%3Cpath%20d%3D%22M102%2028%20L106%2038%20L96%2034%20L106%2034%20L102%2038%20Z%22%20fill%3D%22%2300b3ff%22/%3E%0A%20%20%3Cpath%20d%3D%22M20%2092%20L24%20102%20L14%2098%20L24%2098%20L20%20102%20Z%22%20fill%3D%22%23ff5ca8%22/%3E%0A%20%20%3Cpath%20d%3D%22M100%2092%20L104%20102%20L94%2098%20L104%2098%20L100%20102%20Z%22%20fill%3D%22%237dff5c%22/%3E%0A%0A%20%20%3Cpath%20d%3D%22M60%2010%20L92%2042%20L28%2042%20Z%22%20fill%3D%22%237ad7ff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%223%22/%3E%3Ccircle%20cx%3D%2260%22%20cy%3D%2210%22%20r%3D%226%22%20fill%3D%22%23ff6b7a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2228%22%20r%3D%224%22%20fill%3D%22%23ffd34d%22/%3E%3Ccircle%20cx%3D%2244%22%20cy%3D%2228%22%20r%3D%224%22%20fill%3D%22%23a6ff8a%22/%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ğŸ˜œ": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Cpath%20d%3D%22M70%2050%20Q78%2046%2086%2050%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2072%20Q60%2092%2080%2072%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%3Cpath%20d%3D%22M54%2078%20Q60%2094%2066%2078%22%20fill%3D%22%23ff6b7a%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%224%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ğŸ™‚": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2072%20Q60%2090%2080%2072%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
};

function getFaceKeyFromText(t){
  const s = String(t||"");
  if (s.includes("ãã¾ãã‚Œ")) return "ğŸ˜œ";
  if (s.includes("ã¾ã˜ã‚")) return "ğŸ˜ƒ";
  if (s.includes("ãã‚‰ãã‚‰")) return "ğŸ¤©";
  if (s.includes("ã’ã‚“ã")) return "ğŸ¥³";
  if (s.includes("ã®ã³ã®ã³")) return "ğŸ˜";
  if (s.includes("ã²ã‹ãˆã‚")) return "ğŸ™‚";
  const m = s.trim().match(/^[ğŸ˜ƒğŸ˜ğŸ¤©ğŸ¥³ğŸ˜œğŸ™‚]/u);
  return m ? m[0] : "ğŸ™‚";
}

function setDiagFaceByPersonalityText(personalityLine){
  const img = document.getElementById('diag-face-img');
  if (!img) return;
  const key = getFaceKeyFromText(personalityLine);
  if (faceMapSvg[key]) img.src = faceMapSvg[key];
}
function computeUkuleleBodyDiagnosis(diag, summary){
  // D-4 (B-UK) simplified: kid-level, but clear.
  try{
    const done = (diag?.strings || []).filter(s => s && s.okRelDiff != null);
    if (!done.length) return null;

    // Parse summary scores if available (from buildDiagnosis condition text)
    const condText = String(summary?.condition || "");
    const accM = condText.match(/ç²¾åº¦(\d+)/);
    const stabM = condText.match(/å®‰å®š(\d+)/);
    const speedM = condText.match(/é€Ÿã•(\d+)/);
    const controlM = condText.match(/æ“ä½œ(\d+)/);

    const acc = accM ? Number(accM[1]) : null;
    const stab = stabM ? Number(stabM[1]) : null;
    const speed = speedM ? Number(speedM[1]) : null;
    const control = controlM ? Number(controlM[1]) : null;

    const avgStd  = done.reduce((a,s)=>a+(Number(s.hzStd)||0),0)/done.length;
    const stds = done.map(s => Number(s.hzStd)||0);
    const stdVar = (Math.max(...stds) - Math.min(...stds));

    // player-likely (avoid blaming instrument)
    const playerLikely = (control != null && control < 60) || (speed != null && speed < 55);

    // 1) å…ƒæ°—ãŒãªã„ï¼ˆæºã‚ŒãŒå¼·ã„ï¼å·®ãŒå¤§ãã„ï¼‰
    if (!playerLikely && (avgStd > 5.0 || stdVar > 4.0)){
      return "ã™ã“ã—å…ƒæ°—ãŒãªã„ã¿ãŸã„ã§ã™ã€‚";
    }

    // 2) ã²ãæ–¹
    if (playerLikely){
      return "ã‚¦ã‚¯ãƒ¬ãƒ¬ã¯å¤§ä¸ˆå¤«ã€‚ã²ãæ–¹ã§éŸ³ãŒã‹ã‚ã£ã¦ã„ã¾ã™ã€‚";
    }

    // 3) å£°ãŒå‡ºã¦ã„ã‚‹ï¼ˆå¼·ã„æ¡ä»¶ã‚’å…ˆï¼‰
    if (acc != null && stab != null && acc >= 85 && stab >= 85){
      return "ã“ã®ã‚¦ã‚¯ãƒ¬ãƒ¬ã®ã€Œå£°ã€ãŒã€ã¡ã‚ƒã‚“ã¨å‡ºã¦ã„ã¾ã™ã€‚ ã“ã®éŸ³ãŒã€ã“ã®å­ã®ã„ã¡ã°ã‚“ã„ã„éŸ³ã§ã™ã€‚";
    }

    // 4) è‚²ã£ã¦ã„ã‚‹
    if (acc != null && stab != null && acc >= 80 && stab >= 80){
      return "ã“ã®ã‚¦ã‚¯ãƒ¬ãƒ¬ã€ã„ã„éŸ³ã«ãªã£ã¦ãã¦ã„ã¾ã™ã€‚";
    }

    // 5) ã¾ã æœ¬æ°—
    if (stab != null && stab < 55){
      return "ã“ã®ã‚¦ã‚¯ãƒ¬ãƒ¬ã€ã¾ã æœ¬æ°—ã‚’å‡ºã—ã¦ã„ã¾ã›ã‚“ã€‚";
    }

    // 6) ã“ã‚Œã‹ã‚‰è‰¯ããªã‚‹
    if (stab != null && stab < 75){
      return "ã“ã®ã‚¦ã‚¯ãƒ¬ãƒ¬ã¯ã€ã“ã‚Œã‹ã‚‰éŸ³ãŒã‚ˆããªã‚Šã¾ã™ã€‚";
    }

    // 7) å•é¡Œãªã—
    return "ã‚¦ã‚¯ãƒ¬ãƒ¬ã¯ã€ã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã¾ã™ã€‚";
  }catch(e){
    return null;
  }
}


function toGenLabel(code){
  const s = String(code||"").trim();
  if (!s) return "";
  // accept "1A" "2E" "3C" "4G" or reversed "A1" "E2" ...
  let m = s.match(/^([1-4])[AECG]$/);
  if (m) return `${m[1]}ã’ã‚“`;
  m = s.match(/^[AECG]([1-4])$/);
  if (m) return `${m[1]}ã’ã‚“`;
  // accept like "1ã’ã‚“" etc
  m = s.match(/^([1-4])\s*ã’ã‚“/);
  if (m) return `${m[1]}ã’ã‚“`;
  return s;
}
function convertCodesToGen(text){
  return String(text||"").replace(/\b([1-4])[AECG]\b/g, (s)=>toGenLabel(s));
}


function idxToGen(idx){
  const n = Number(idx) + 1;
  if (n >= 1 && n <= 4) return `${n}ã’ã‚“`;
  return `${idx}`;
}

function makeStringInsights(diag, d){
  // kid-level: short, but informative. Use "ã‹ã‚‚" to avoid overclaim.
  try{
    const ss = (diag?.strings || []);
    const done = ss.filter(s => s && s.okRelDiff != null);

    if (!done.length) return "ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒãŸã‚Šãªã„ã‚ˆã€‚";

    // most shaky / quiet
    const maxStdS = done.reduce((best,s)=> (best==null || (s.hzStd||0)>(best.hzStd||0)) ? s : best, null);
    const minRmsS = done.reduce((best,s)=> (best==null || (s.rmsAvg||0)<(best.rmsAvg||0)) ? s : best, null);

    const maxStd = Number(maxStdS?.hzStd||0);
    const minRms = Number(minRmsS?.rmsAvg||0);

    // read "ã‚ºãƒ¬ã‚„ã™ã„/æºã‚Œã‚„ã™ã„" from condition text (already kid-level in details, but we can reuse)
    const condText = String(d?.condition || "");
    const zM = condText.match(/ã‚ºãƒ¬ã‚„ã™ã„.*?:\s*([1-4])[AECG]\b/);
    const yM = condText.match(/æºã‚Œã‚„ã™ã„.*?:\s*([1-4])[AECG]\b/);

    const zGen = zM ? `${zM[1]}ã’ã‚“` : null;
    const yGen = yM ? `${yM[1]}ã’ã‚“` : null;

    const lines = [];

    if (zGen) lines.push(`${zGen}ã¯ã€ã®ã³ãŸã‚Š ã‚†ã‚‹ã‚“ã ã‚Š ã—ã‚„ã™ã„ã‹ã‚‚ã€‚`);
    if (yGen) lines.push(`${yGen}ã¯ã€ãµã‚‰ãµã‚‰ ã—ã‚„ã™ã„ã‹ã‚‚ã€‚`);

    // "old string" heuristic
    // If one string is very shaky AND very quiet => likely old / worn / high friction nut/bridge, etc.
    if (maxStd >= 5.0 && minRms <= 0.012){
      const sGen = idxToGen(minRmsS.idx);
      lines.push(`${sGen}ã® ã’ã‚“ãŒ ãµã‚‹ã„ã‹ã‚‚ã€‚ã§ããŸã‚‰ ã“ã†ã‹ã‚“ã—ã‚ˆã†ã€‚`);
    } else if (maxStd >= 5.0){
      const sGen = idxToGen(maxStdS.idx);
      lines.push(`${sGen}ã¯ ã‚†ã‚ŒãŒå¤§ãã„ã‚ˆï¼ˆ${maxStd.toFixed(1)}Hzï¼‰ã€‚`);
    }

    if (!lines.length){
      // If no issue detected, still give a useful tip
      lines.push("ã’ã‚“ã¯ ã ã„ãŸã„ OK ã ã‚ˆã€‚");
    }

    // keep it short (max 3 short sentences)
    return lines.slice(0,3).join(" ");
  }catch(e){
    return "";
  }
}

function makeKidCondition(d){
  // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ = ã€Œä»Šæ—¥ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®ã‚€ãšã‹ã—ã•ï¼ˆå…¨ä½“ï¼‰ã€ã ã‘ã‚’è¨€ã†
  // â€» ä½•ã’ã‚“ãŒã€œ ã¯ã€Œã’ã‚“ã®ã‚ˆã†ã™ã€ã«é›†ç´„ã—ã¦ã€å†…å®¹ã®ã‹ã¶ã‚Šã‚’ãªãã™
  try{
    const score = Number(d?.score || d?.total || d?.totalScore || 0);

    let main = "";
    if (score >= 90) main = "ã™ã”ãã„ã„æ„Ÿã˜ï¼";
    else if (score >= 80) main = "ã„ã„æ„Ÿã˜ï¼";
    else if (score >= 70) main = "ã‚ã¨å°‘ã—ã§ ã‚‚ã£ã¨ã‚ˆããªã‚‹ã‚ˆã€‚";
    else main = "ä»Šæ—¥ã¯åˆã‚ã›ã«ãã„æ—¥ã€‚ã‚ã‚ã¦ãªã„ã§OKã€‚";

    // è¿½åŠ ã®ä¸€è¨€ï¼ˆå…·ä½“çš„ãªè¡Œå‹•ï¼‰
    // ã“ã“ã§ã¯ 1ã’ã‚“/2ã’ã‚“ ãªã©ã¯è¨€ã‚ãªã„ï¼ˆã’ã‚“ã®ã‚ˆã†ã™ã¸ï¼‰
    const s = String(d?.condition || "");
    const hasDrift = s.includes("ã‚ºãƒ¬") || s.includes("ãšã‚Œ");
    const hasJitter = s.includes("ã‚†ã‚Œ") || s.includes("æºã‚Œ");

    let tip = "";
    if (hasDrift && hasJitter){
      tip = "ã‚ºãƒ¬ã¨ã‚†ã‚ŒãŒå‡ºã‚„ã™ã„ã‚ˆã€‚1ã’ã‚“ãšã¤ã€çŸ­ã1å›ã§åˆã‚ã›ã‚ˆã†ã€‚";
    }else if (hasDrift){
      tip = "ã‚ºãƒ¬ãŒå‡ºã‚„ã™ã„ã‚ˆã€‚æœ€å¾Œã¯çŸ­ã1å›ã§åˆã‚ã›ã‚ˆã†ã€‚";
    }else if (hasJitter){
      tip = "ã‚†ã‚ŒãŒå‡ºã‚„ã™ã„ã‚ˆã€‚å¼·ãå¼¾ãã™ããªã„ã§ã­ã€‚";
    }

    return tip ? `${main}\n${tip}` : `${main}`;
  }catch(e){
    return "ä»Šæ—¥ã¯åˆã‚ã›ã«ãã„æ—¥ã€‚ã‚ã‚ã¦ãªã„ã§OKã€‚";
  }
}

function makeKidMaintenance(diag){
  try{
    const done = (diag?.strings || []).filter(s => s && (s.okRelDiff != null || s.hzStd != null));
    if (!done.length) return "ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã€‚1ã’ã‚“ãšã¤åˆã‚ã›ã‚ˆã†ã€‚";

    const drift = [...done].sort((a,b)=> (Math.abs(b.okRelDiff||0))-(Math.abs(a.okRelDiff||0)))[0];
    const jitter = [...done].sort((a,b)=> (b.hzStd||0)-(a.hzStd||0))[0];

    if (drift && Math.abs(drift.okRelDiff||0) >= 0.9){
      return "æœ€å¾Œã¯çŸ­ã1å›ã ã‘å¼¾ã„ã¦ã€æ•°å­—ãŒæ­¢ã¾ã£ãŸã‚‰åˆã‚ã›ã‚ˆã†ã€‚";
    }
    if (jitter && (jitter.hzStd||0) >= 10){
      return "å¼·ãå¼¾ãã™ããªã„ã§ã€1å›ã ã‘ãƒãƒ³ã¨å¼¾ã„ã¦ã­ã€‚";
    }
    return "1ã’ã‚“ãšã¤ã€1å›ã ã‘å¼¾ã„ã¦åˆã‚ã›ã‚ˆã†ã€‚";
  }catch(e){
    return "1ã’ã‚“ãšã¤ã€1å›ã ã‘å¼¾ã„ã¦åˆã‚ã›ã‚ˆã†ã€‚";
  }
}


function toggleDetailsPanel(forceOpen=null){
  const panel = document.getElementById('detail-panel');
  const btn = document.getElementById('btn-details');
  if (!panel || !btn) return;
  const nowOpen = (forceOpen===null) ? (panel.style.display !== 'none') : (!forceOpen);
  const nextOpen = (forceOpen===null) ? !nowOpen : forceOpen;
  panel.style.display = nextOpen ? 'block' : 'none';
  btn.innerText = nextOpen ? 'ã¨ã˜ã‚‹' : 'ãã‚ã—ã';
}


function makeStringState(diag){
  // ã’ã‚“ã®ã‚ˆã†ã™ = ã€Œã©ã®ã’ã‚“ãŒã€ã©ã†ãªã‚ŠãŒã¡ï¼Ÿã€ï¼ˆåŸå› ã®ãƒ’ãƒ³ãƒˆï¼‰
  // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«ã€ã‚ºãƒ¬/ã‚†ã‚Œ ã¨ã„ã†è¨€è‘‰ã¯ã“ã“ã§ã¯ä½¿ã‚ãªã„
  try{
    const done = (diag?.strings || []).filter(s => s && (s.okRelDiff != null || s.hzStd != null || s.rmsAvg != null));
    if (!done.length) return "ã¾ã  ã¯ã£ãã‚Šã‚ã‹ã‚‰ãªã„ã‚ˆã€‚";

    const drift = [...done].sort((a,b)=> (Math.abs(b.okRelDiff||0))-(Math.abs(a.okRelDiff||0)))[0];
    const jitter = [...done].sort((a,b)=> (b.hzStd||0)-(a.hzStd||0))[0];

    const parts = [];
    const driftVal = drift ? Math.abs(Number(drift.okRelDiff||0)) : 0; // rel diff (e.g., 0.009 = 0.9%)
    const jitterVal = jitter ? Number(jitter.hzStd||0) : 0;           // Hz

    if (drift && driftVal >= 0.009){
      const gen = toGenLabel(drift.label || drift.stringLabel || drift.string || drift.name || "");
      if (gen) parts.push(`${gen}ã¯ã€ã‚†ã‚‹ã¿ã‚„ã™ã„ã‹ã‚‚ã€‚`);
    }

    if (jitter && jitterVal >= 8){
      const gen = toGenLabel(jitter.label || jitter.stringLabel || jitter.string || jitter.name || "");
      const rms = (jitter.rmsAvg != null) ? Number(jitter.rmsAvg||0) : null;
      if (gen){
        if (rms != null && rms < 0.012) parts.push(`${gen}ã® ã’ã‚“ãŒ ãµã‚‹ã„ã‹ã‚‚ã€‚`);
        else parts.push(`${gen}ã¯ã€ã¤ã‚ˆãå¼¾ãã¨ ãµã‚‰ã¤ãã‚„ã™ã„ã‚ˆã€‚`);
      }
    }

    if (!parts.length) return "ã’ã‚“ã¯å¤§ä¸ˆå¤«ãã†ã€‚";
    return "åŸå› ã®ãƒ’ãƒ³ãƒˆï¼š " + parts.slice(0,2).join(" ");
  }catch(e){
    return "ã¾ã  ã¯ã£ãã‚Šã‚ã‹ã‚‰ãªã„ã‚ˆã€‚";
  }
}




function makeAdvice(personalityText, ukuleleDiagText, stringStateText){
  const u = String(ukuleleDiagText||"");
  const s = String(stringStateText||"");

  if (u.includes("å…ƒæ°—ãŒãªã„")){
    let out = "ã¾ãšã¯ 1åˆ†ã ã‘ ã‚„ã•ã—ãå¼¾ã„ã¦ã€ã‚ãŸãŸã‚ã‚ˆã†ã€‚";
    if (s.includes("ãµã‚‹ã„ã‹ã‚‚")) out += " ã’ã‚“ã‚’æ–°ã—ãã™ã‚‹ã¨ã€ã‚‚ã£ã¨å®‰å®šã™ã‚‹ã‚ˆã€‚";
    return out;
  }
  if (u.includes("ã¾ã æœ¬æ°—")){
    return "ã‚†ã£ãã‚Šã€ã‚„ã•ã—ãã€‚æ¯æ—¥ã¡ã‚‡ã£ã¨ãšã¤å¼¾ãã¨éŸ³ãŒè‚²ã¤ã‚ˆã€‚";
  }
  if (u.includes("ã“ã‚Œã‹ã‚‰") || u.includes("ã‚ˆããªã‚Šã¾ã™")){
    return "æ¯æ—¥ã¡ã‚‡ã£ã¨å¼¾ã“ã†ã€‚éŸ³ãŒã ã‚“ã ã‚“ ã²ã³ãã‚ˆã€‚";
  }
  if (u.includes("å£°") && u.includes("ã„ã¡ã°ã‚“")){
    return "ã„ã¾ã®éŸ³ãŒã€ã“ã®å­ã®ãƒ™ã‚¹ãƒˆã€‚ä»Šã®åˆã‚ã›æ–¹ã‚’å¤§äº‹ã«ã—ã‚ˆã†ã€‚";
  }
  if (u.includes("ã¡ã‚ƒã‚“ã¨ã—ã¦")){
    if (s.includes("ãµã‚‹ã„ã‹ã‚‚")) return "ã‚¦ã‚¯ãƒ¬ãƒ¬ã¯OKã€‚ã’ã‚“ãŒå¤ã„ã‹ã‚‚ã ã‹ã‚‰ã€ã“ã†ã‹ã‚“ã™ã‚‹ã¨å®‰å®šã™ã‚‹ã‚ˆã€‚";
    return "ã“ã®ã¾ã¾ã§OKã€‚æœ€å¾Œã¯çŸ­ãå¼¾ã„ã¦ã€æ­¢ã¾ã£ãŸã¨ã“ã‚ã§åˆã‚ã›ã‚ˆã†ã€‚";
  }
  return "ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã€‚å°‘ã—ãšã¤åˆã‚ã›ã¦ã„ã“ã†ã€‚";
}


function doDiagnosis() {
  let d;
  try {
    d = buildDiagnosis();
  } catch (e) {
    d = {
      title: "è¨ºæ–­ã‚¨ãƒ©ãƒ¼",
      meaning: "ã‚‚ã†ä¸€åº¦ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¦ã¿ã¦ã­ã€‚",
      scoreline: "",
      condition: "è¨ºæ–­ã®è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¿ãŸã„â€¦ï¼ˆç”»é¢ã‚’æ›´æ–°ã—ã¦å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ï¼‰",
      maintenance: ""
    };
  }

  // ã¾ãšãƒ¯ã‚¯ãƒ¯ã‚¯æ¼”å‡ºï¼ˆãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«â†’çµæœã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³ï¼‰
  const splash = document.getElementById('diagnosis-splash');
  const pop = document.getElementById('splash-pop');
  splash.classList.add('show');

  // ãƒœã‚¿ãƒ³ã‚’ä¸€åº¦ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
  const btnOld = document.getElementById('btn-show-result');
  btnOld.replaceWith(btnOld.cloneNode(true));
  const btn = document.getElementById('btn-show-result');

  btn.disabled = true;
  btn.innerText = "ã¾ã‚‚ãªãâ€¦";
  pop.classList.add('blink');

  // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«SEï¼ˆç´„1.2ç§’ï¼‰
  let ticks = 0;
  const roll = setInterval(() => {
    playTick();
    ticks++;
    if (ticks >= 10) {
      clearInterval(roll);
      pop.classList.remove('blink');
      btn.disabled = false;
      btn.innerText = "çµæœã‚’è¦‹ã‚‹";
      playTaDa();
    }
  }, 120);

  const showResult = () => {
    // ã“ã“ãŒçµæœè¡¨ç¤ºã®æ ¹å¹¹ã€‚DIAG ã‹ã‚‰1å›ã§ã¾ã¨ã‚ã¦ä½œã£ã¦ã€çŸ›ç›¾ã—ãªã„ã‚ˆã†ã«å‡ºã™ã€‚
    splash.classList.remove('show');

    // card show
    const card = document.getElementById('diagnosis-card');
    if (card) card.classList.add('show');

    const titleEl = document.getElementById('diag-title');
    if (titleEl) titleEl.innerText = "";

    // --- Base summary from the SAME DIAG (buildDiagnosis already uses DIAG) ---
    const base = d || { meaning:"", scoreline:"", condition:"", maintenance:"" };

    // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆå°å­¦ç”Ÿç‰ˆï¼‰: buildDiagnosis.condition -> makeKidCondition -> ã‚³ãƒ¼ãƒ‰ã‚’ 1ã’ã‚“/2ã’ã‚“ ã«å¤‰æ›
    const condKidRaw = makeKidCondition(base);
    const condKid = convertCodesToGen(condKidRaw);

    // ã’ã‚“ã®ã‚ˆã†ã™: DIAGã‹ã‚‰ï¼ˆã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¨çŸ›ç›¾ã—ãªã„ â€œã‚„ã•ã—ã‚â€ æ–‡è¨€ï¼‰
    const stringState = makeStringState(DIAG);

    // ä»Šæ—¥ã®ã‚¦ã‚¯ãƒ¬ãƒ¬è¨ºæ–­ï¼ˆB-UKï¼‰: conditionã®æ•°å€¤ï¼ˆç²¾åº¦/å®‰å®š/é€Ÿã•/æ“ä½œï¼‰ï¼‹æºã‚Œå…·åˆã‹ã‚‰åˆ¤æ–­
    const uk = computeUkuleleBodyDiagnosis(DIAG, { condition: String(base.condition||""), maintenance: String(base.maintenance||""), stringState }) || "";

    // æ€§æ ¼ï¼ˆé¡”ã¨é€£å‹•ï¼‰: uk ã¨ condKid ã‚’æ¸¡ã—ã¦ã€çŸ›ç›¾ã‚’é¿ã‘ã‚‹
    const pText = computeUkulelePersonality(DIAG, uk, condKid);

    // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼ˆå°å­¦ç”Ÿç‰ˆï¼‰: buildDiagnosis.maintenance2 ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆã‚³ãƒ¼ãƒ‰ã ã‘å¤‰æ›ï¼‰
    const maintKid = convertCodesToGen(String(base.maintenance||""));

    // ã‚¢ãƒ‰ãƒã‚¤ã‚¹: æ€§æ ¼ + B-UK + ã’ã‚“ã®ã‚ˆã†ã™ ã‹ã‚‰
    const adviceText = makeAdvice(pText, uk, stringState);

    // --- Apply to UI ---
    const pEl = document.getElementById('diag-personality');
    if (pEl) pEl.innerText = pText;

    // é¡”ã¯ â€œã“ã“1ã‹æ‰€ã ã‘â€ ã§æ±ºã‚ã‚‹ï¼ˆä¸Šæ›¸ãç¦æ­¢ï¼‰
    setDiagFaceByPersonalityText(pText);

    const pr = document.getElementById('diag-personality-reason');
    if (pr) pr.innerText = (window.__personalityReason || "");

    const ukEl = document.getElementById('diag-ukulele');
    if (ukEl) ukEl.innerText = uk; // è¦‹å‡ºã—ãŒã€Œä»Šæ—¥ã®ã‚¦ã‚¯ãƒ¬ãƒ¬è¨ºæ–­ã€ãªã®ã§ã€æ¥é ­èªã¯ä»˜ã‘ãªã„

    const meaningEl = document.getElementById('diag-meaning');
    if (meaningEl) meaningEl.innerText = String(base.meaning||"");

    const scoreEl = document.getElementById('diag-scoreline');
    if (scoreEl) scoreEl.innerText = String(base.scoreline||"");

    const condEl = document.getElementById('diag-cond');
    if (condEl) condEl.innerText = condKid;

    const maintEl = document.getElementById('diag-maint');
    if (maintEl) maintEl.innerText = maintKid;

    const strEl = document.getElementById('diag-string-state');
    if (strEl) strEl.innerText = stringState;

    const advEl = document.getElementById('diag-advice');
    if (advEl) advEl.innerText = adviceText;

    // details panel
    toggleDetailsPanel(false);
    const btnDetails = document.getElementById('btn-details');
    if (btnDetails) btnDetails.onclick = () => toggleDetailsPanel();

    btn.removeEventListener('click', showResult);
  };

  btn.addEventListener('click', showResult);
}
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
window.onresize(); draw();

// ===== FINAL FACE OVERRIDE (text-based, no emoji prefix) =====
(function(){
  function keyFromPersonalityText(t){
    const s = String(t||"");
    if (s.includes("ãã¾ãã‚Œ")) return "ğŸ˜œ";
    if (s.includes("ã¾ã˜ã‚")) return "ğŸ˜ƒ";
    if (s.includes("ãã‚‰ãã‚‰")) return "ğŸ¤©";
    if (s.includes("ã’ã‚“ã")) return "ğŸ¥³";
    if (s.includes("ã®ã³ã®ã³")) return "ğŸ˜";
    if (s.includes("ã²ã‹ãˆã‚")) return "ğŸ™‚";
    return "ğŸ™‚";
  }
  const _old = window.setDiagFaceByPersonalityText;
  window.setDiagFaceByPersonalityText = function(personalityLine){
    try{
      const img = document.getElementById('diag-face-img');
      if (!img) return;
      const key = keyFromPersonalityText(personalityLine);
      if (typeof faceMapSvg !== 'undefined' && faceMapSvg[key]) img.src = faceMapSvg[key];
      else if (window.faceMapSvg && window.faceMapSvg[key]) img.src = window.faceMapSvg[key];
      else if (_old) _old(personalityLine);
    }catch(e){
      try{ if (_old) _old(personalityLine); }catch(_e){}
    }
  };
})();

</script>

<div class="verBadge">v_release_20260118_tuning</div>
</body>
</html>