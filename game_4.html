<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#88cfd3" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ã‚¦ã‚¯ãƒ¬ãƒ¬ãƒ»ã‚­ãƒƒã‚º" />
  <meta name="application-name" content="ã‚¦ã‚¯ãƒ¬ãƒ¬ãƒ»ã‚­ãƒƒã‚º" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>ã‚¦ã‚¯ãƒ¬ãƒ¬ãƒ»ã‚­ãƒƒã‚º - ã‚½ãƒ­ã‚‚ã²ã‘ã‚‹ã‚ˆï¼</title>
  <style>
    :root{
      /* ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¯¾å¿œ */
      --vh: 100vh;
      --vvTop: 0px;
      --vvLeft: 0px;

      --bgTop: rgba(168,230,207,0.45);
      --bgMid: rgba(122,177,204,0.22);
      --bgBottom: rgba(255,255,255,0.92);
      --text: #4a3728;
      --card: rgba(255,255,255,0.92);
      --shadow: rgba(0,0,0,0.18);
      --primary: #ff7a3d;
      --mint: #a8e6cf;
      --sky: #7ab1cc;
      --aqua: #5ce1e6;
    }

    /* åŸºæœ¬è¨­å®šï¼šè¦‹ãŸç›®ã¯å›ºå®šã€‚Safariã®UIãƒãƒ¼ã‚’éš ã™ãŸã‚ã«â€œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã ã‘â€å°‘ã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: auto;            /* scrollTo(0,1) ã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ */
      overscroll-behavior: none; /* ãƒã‚¦ãƒ³ã‚¹æŠ‘åˆ¶ */
      background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      touch-action: auto; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      scrollbar-width: none;
    }
    html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }

    /* iOSã®Safariã§ãƒãƒ¼ãŒå‡ºã¦ã‚‚å´©ã‚Œãªã„ã‚ˆã†ã« dvh ã‚’ä½¿ç”¨ */
    @supports (height: 100dvh) {
      body { height: 100dvh; }
    }

    #app {
      position: fixed;
      inset: 0;
      width: 100%; height: 100%;
      overflow: hidden;
    }

    canvas { display:block; width:100%; height:100%; touch-action:none; }

    /* --- UI Components --- */

    #menu-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.32);
      display: flex; align-items: flex-start; justify-content: center; /* ä¸Šå¯„ã›ï¼ˆé•·ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯ï¼‰ */
      padding: max(12px, env(safe-area-inset-top)) 18px max(12px, env(safe-area-inset-bottom));
      z-index: 100;
      backdrop-filter: blur(2px);
    }
    .menu-card {
      background: var(--card);
      max-height: calc(100% - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      color: var(--text);
      width: min(560px, 96vw);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 12px 0 rgba(122,177,204,0.35), 0 18px 36px var(--shadow);
      border: 2px solid rgba(255,255,255,0.65);
      display: flex; flex-direction: column;
    }
    .menu-card h1 { margin: 0 0 10px; font-size: 24px; text-align: center; }
    .menu-card .sub { margin: 0 0 14px; font-size: 13px; opacity: 0.85; line-height: 1.4; text-align: center; }
    .menu-list { display:flex; flex-direction:column; gap:10px; flex:0 0 auto; overflow:visible; padding:4px; }

    .menu-btn {
      appearance: none; border: none;
      background: rgba(255,255,255,0.98);
      color: var(--text);
      width: 100%;
      border-radius: 16px;
      padding: 12px;
      cursor: pointer;
      display: flex; gap: 12px; align-items: center;
      box-shadow: 0 4px 0 rgba(122,177,204,0.32);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
      text-decoration: none;
    }
    .menu-btn:active { transform: translateY(2px); box-shadow: none; }
    
    .badge {
      flex: 0 0 38px; height: 38px;
      border-radius: 12px;
      background: var(--primary);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff;
    }
    .menu-btn.mode2 .badge{ background: #ffde59; color:#4a3728; }
    .menu-btn.mode3 .badge{ background: #7ed957; }
    .menu-btn.mode4 .badge{ background: var(--aqua); color: #133; }
    
    .menu-text { text-align: left; flex: 1; }
    .menu-text .title { font-size: 17px; font-weight: 900; line-height: 1.2; margin-bottom: 3px; }
    .menu-text small { font-size: 12px; font-weight: 600; opacity: 0.8; display: block; line-height: 1.3; }

    /* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
    .mode-select { margin-top: 14px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); }
    .mode-select-title { font-size: 12px; font-weight: 900; color: rgba(0,0,0,0.5); text-align: center; margin-bottom: 6px; }
    .mode-pills { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .mode-pill {
      border: 2px solid rgba(0,0,0,0.1);
      background: #fff;
      border-radius: 20px;
      padding: 6px 12px;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
    }
    .mode-pill.active {
      border-color: var(--primary);
      background: rgba(255,122,61,0.1);
      color: var(--primary);
    }

    /* ã‚²ãƒ¼ãƒ å†… UI */
    #lyrics-area {
      position: absolute; top: calc(10px + env(safe-area-inset-top)); left: 50%; transform: translateX(-50%);
      width: 90%; text-align: center;
      font-size: 28px; font-weight: 900; color: var(--text);
      text-shadow: 0 2px 8px rgba(255,255,255,0.8);
      pointer-events: none; z-index: 50;
    }

    #score-panel, #timer-panel {
      position: fixed; z-index: 90;
      background: rgba(255,255,255,0.85);
      padding: 6px 12px; border-radius: 14px;
      font-weight: 900; font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    /*
      å·¦å´ã®å¼¦ãƒ©ãƒ™ãƒ«(1A/2E/3C/4G)ã¯ Canvas æç”»ã§ x=125 ä»˜è¿‘ã«å‡ºã‚‹ãŸã‚ã€
      ã‚¹ã‚³ã‚¢ã¯å°‘ã—å³ã¸é€€é¿ã—ã¦è¢«ã‚Šã‚’é˜²ãã€‚
    */
    #score-panel {
      top: calc(54px + env(safe-area-inset-top));
      right: calc(12px + env(safe-area-inset-right));
      left: auto;
      font-size: 18px;
    }
    #timer-panel { top: calc(12px + env(safe-area-inset-top)); right: calc(12px + env(safe-area-inset-right)); font-size: 16px; }

    #stopBtn {
      position: fixed;
      right: calc(14px + env(safe-area-inset-right));
      bottom: calc(14px + env(safe-area-inset-bottom));
      z-index: 180; display: none;
      border: none; border-radius: 16px;
      padding: 12px 18px;
      background: rgba(255,255,255,0.92);
      color: var(--text); font-weight: 900; font-size: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    #stopBtn:active { transform: scale(0.95); }

    #back-btn {
      position: fixed;
      top: calc(58px + env(safe-area-inset-top)); /* ã‚¹ã‚³ã‚¢ã®ä¸‹ã‚ãŸã‚Š */
      left: calc(12px + env(safe-area-inset-left));
      z-index: 80; display: none;
    }
    #back-btn a {
      text-decoration: none; color: #0d2b3b; font-weight: 800; font-size: 12px;
      background: rgba(255,255,255,0.6); padding: 6px 10px; border-radius: 10px;
    }

    #chordHud {
      position: fixed;
      top: calc(60px + env(safe-area-inset-top));
      left: 50%; transform: translateX(-50%);
      z-index: 85; display: none; pointer-events: none;
      background: rgba(255,255,255,0.86);
      border-radius: 18px; padding: 6px 16px;
      font-weight: 900; font-size: 32px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    /* Pause / Result Overlay */
    #pause-overlay, #result-overlay {
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      z-index: 120;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
    }
    .pause-card, .result-card {
      background: #fff; width: min(480px, 90vw);
      border-radius: 20px; padding: 24px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      position: relative;
    }
    .result-card { border: 4px solid #fff; outline: 3px solid rgba(255,122,61,0.3); }
    
    .pause-title { font-size: 24px; font-weight: 900; margin-bottom: 8px; }
    .pause-sub { font-size: 14px; opacity: 0.8; margin-bottom: 20px; }
    
    .result-title {
      font-size: 48px; font-weight: 900;
      background: linear-gradient(90deg, #ff7a3d, #ff5757, #7ed957, #5ce1e6);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      margin-bottom: 4px;
    }
    .result-score { font-size: 32px; font-weight: 900; margin: 10px 0; }
    .result-msg { font-size: 16px; font-weight: 700; opacity: 0.8; margin-bottom: 20px; }

    .action-btn {
      width: 100%; border: none; border-radius: 14px;
      padding: 14px; font-size: 16px; font-weight: 900;
      cursor: pointer; margin-bottom: 10px;
      transition: transform 0.1s;
    }
    .action-btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 8px 16px rgba(255,122,61,0.3); }
    .btn-secondary { background: #eee; color: #555; }
    
    .result-actions { display: flex; gap: 10px; }
    .result-actions .action-btn { margin-bottom: 0; }



    /* A2HSï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼‰æ¡ˆå†…ï¼šã‚²ãƒ¼ãƒ ä¸­ã®é‚ªé­”ã«ãªã‚‰ãªã„æœ€å°è¡¨ç¤º */
    .a2hs{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 9999;
      pointer-events: none;
    }
    .a2hs-inner{
      pointer-events: auto;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 10px 44px 10px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
      color: #333;
      font-size: 13px;
      line-height: 1.3;
    }
    .a2hs-title{ font-weight: 900; margin-bottom: 2px; }
    .a2hs-text b{ font-weight: 900; }
    .a2hs-close{
      position: absolute;
      right: 10px;
      top: 8px;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 14px;
      background: rgba(0,0,0,0.06);
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <!-- Safariã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’éš ã™ãŸã‚ã®ãƒ€ãƒŸãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼ˆç”»é¢ã¯ #app ãŒå›ºå®šãªã®ã§è¦‹ãŸç›®ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰ -->
  <div id="__spacer" aria-hidden="true" style="height:120vh;width:1px;pointer-events:none;opacity:0;"></div>


<div id="app">
  <div id="menu-overlay">
    <div class="menu-card">
      <h1>ğŸ¸ ã‚¿ãƒƒãƒ—ã§ã‚Œã‚“ã—ã‚…ã†</h1>
      <p class="sub">ãƒªã‚ºãƒ ã«åˆã‚ã›ã¦æµã‚Œã¦ãã‚‹<br>ãƒãƒ¼ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã‚ˆã†ï¼</p>

      <div class="menu-list">
        <button class="menu-btn mode1" onclick="startScale()">
          <div class="badge">ğŸ¤</div>
          <div class="menu-text">
            <div class="title">ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰</div>
            <small>ã ã‚“ã ã‚“é€Ÿããªã‚‹ã‚ˆï¼ˆæŒ‡ã®ãŸã„ãã†ï¼‰</small>
          </div>
        </button>

        <button class="menu-btn mode2" onclick="startChordsEasy()">
          <div class="badge">ğŸ±</div>
          <div class="menu-text">
            <div class="title">ã‚³ãƒ¼ãƒ‰ ã‹ã‚“ãŸã‚“</div>
            <small>C / F / G7 / Am ã®ãã‚Šã‹ãˆã—</small>
          </div>
        </button>

        <button class="menu-btn mode3" onclick="startChordsHard()">
          <div class="badge">ğŸ¼</div>
          <div class="menu-text">
            <div class="title">ã‚³ãƒ¼ãƒ‰ ã¡ã‚‡ã„ã‚€ãš</div>
            <small>ã„ã‚ã‚“ãªã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã‚‹ã‚ˆ</small>
          </div>
        </button>

        <button class="menu-btn mode4" onclick="startSongTwinkle()">
          <div class="badge">ğŸ¦</div>
          <div class="menu-text">
            <div class="title">æ›²ï¼šãã‚‰ãã‚‰æ˜Ÿ</div>
            <small>ãƒ¡ãƒ­ãƒ‡ã‚£ã¨ã‚³ãƒ¼ãƒ‰ã‚’ä¸€ç·’ã«ã²ã“ã†</small>
          </div>
        </button>
      </div>

      <div class="mode-select">
        <div class="mode-select-title">ãƒ¢ãƒ¼ãƒ‰è¨­å®š</div>
        <div class="mode-pills">
          <button class="mode-pill" type="button" data-mode="NORMAL">ãƒãƒ¼ãƒãƒ«</button>
          <button class="mode-pill active" type="button" data-mode="WAIT">ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆç·´ç¿’ç”¨ï¼‰</button>
          <button class="mode-pill" type="button" data-mode="TEST">TESTï¼ˆåˆ¤å®šã‚ã¾ã„ï¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <div id="lyrics-area"></div>
  <div id="score-panel">â­ <span id="score">0</span></div>
  <div id="timer-panel">ã®ã“ã‚Š <span id="timer">60</span> ç§’</div>
  <div id="chordHud" aria-hidden="true"></div>
  
  <div id="back-btn"><a href="#" onclick="goMenu()">ğŸï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
  <button id="stopBtn" type="button">ã‚¹ãƒˆãƒƒãƒ—</button>

  <div id="pause-overlay" aria-hidden="true">
    <div class="pause-card">
      <div class="pause-title">ã‚¹ãƒˆãƒƒãƒ—ä¸­</div>
      <div class="pause-sub">ã¡ã‚‡ã£ã¨ ã²ã¨ã‚„ã™ã¿</div>
      <button class="action-btn btn-primary" type="button" onclick="resumeGame()">ã¤ã¥ã‘ã‚‹</button>
      <button class="action-btn btn-secondary" type="button" onclick="goMenuFromPause()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
    </div>
  </div>

  <div id="result-overlay" aria-hidden="true">
    <div class="result-card">
      <div class="result-title" id="result-title">Finish!</div>
      <div class="result-score">â­ <span id="result-score">0</span> pts</div>
      <div class="result-msg" id="result-msg">Good Job!</div>
      <div class="result-actions">
        <button class="action-btn btn-primary" type="button" onclick="restartLast()">ã‚‚ã†ï¼‘å›</button>
        <button class="action-btn btn-secondary" type="button" onclick="goMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
      </div>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>
</div>

<!-- UIãƒãƒ¼å¯¾ç­–æ¡ˆå†…ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºæ™‚ã®ã¿ï¼‰ -->
<div id="a2hs" class="a2hs" style="display:none;">
  <div class="a2hs-inner">
    <div class="a2hs-title">UIãƒãƒ¼ã‚’æ¶ˆã™æ–¹æ³•</div>
    <div class="a2hs-text">iPhone: å…±æœ‰ â†’ <b>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </b> ã§å…¨ç”»é¢ã«ãªã‚Šã¾ã™</div>
    <button class="a2hs-close" type="button" onclick="hideA2HS()">Ã—</button>
  </div>
</div>


<script>
/**
 * ä¿®æ­£ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * - ç”»é¢å›ºå®šåŒ–ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‰
 * - å¤‰æ•°ãƒªã‚»ãƒƒãƒˆã®å¾¹åº•
 * - ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—é˜²æ­¢
 */


// --- UI Bar / PWA helper ---
const IS_IOS = /iP(hone|od|ad)/.test(navigator.userAgent);
const IS_STANDALONE = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator.standalone === true);

function showA2HS(){
  try{
    if(!IS_IOS) return;
    if(IS_STANDALONE) return;
    if(localStorage.getItem('a2hs_dismissed') === '1') return;
    const el = document.getElementById('a2hs');
    if(!el) return;
    el.style.display = 'block';
    // è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼ˆé‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    setTimeout(()=>{ if(el.style.display==='block') el.style.display='none'; }, 6500);
  }catch(e){}
}
function hideA2HS(){
  try{
    const el = document.getElementById('a2hs');
    if(el) el.style.display = 'none';
    localStorage.setItem('a2hs_dismissed','1');
  }catch(e){}
}

function tryEnterFullscreen(){
  // Android/PCå‘ã‘ï¼ˆiOS Safariã¯åŸºæœ¬ä¸å¯ï¼‰
  const root = document.documentElement;
  const req = root.requestFullscreen || root.webkitRequestFullscreen || root.msRequestFullscreen;
  if(req && !document.fullscreenElement && !document.webkitFullscreenElement){
    try{ req.call(root); }catch(e){}
  }
}
function tryExitFullscreen(){
  const exit = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
  if(exit && (document.fullscreenElement || document.webkitFullscreenElement)){
    try{ exit.call(document); }catch(e){}
  }
}

// Service Workerï¼ˆã‚ã‚Œã°ç™»éŒ²ã€‚ç„¡ãã¦ã‚‚ã‚²ãƒ¼ãƒ ã¯å‹•ãï¼‰
window.addEventListener('load', ()=>{
  showA2HS();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
});

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lyricsEl = document.getElementById('lyrics-area');
const timerPanel = document.getElementById('timer-panel');
const timerEl = document.getElementById('timer');
const chordHUDEl = document.getElementById('chordHud');
const stopBtnEl = document.getElementById('stopBtn');

let gameState = 'MENU';
  tryExitFullscreen(); // MENU, PLAY, PAUSE, RESULT

// ãƒ¢ãƒ¼ãƒ‰è¨­å®š
let playModeSelected = 'WAIT';
let playModeActive   = 'TEST';

// å¤‰æ•°ç¾¤
let rafId = 0;
let gameEndAt = 0;
const GAME_DURATION_MS = 60 * 1000;

let score = 0; 
let combo = 0; 
let groups = []; 
let pops = [];
let flashes = [];
let toasts = []; 
let stars = [];
let lastSpawn = 0; 
let titleOpacity = 0;

// å®šæ•°ãƒ»è¨­å®š
const NUT_X = 180;
const MARK_CX = 125;
const MARK_R = 24;
const SUPPORT_AHEAD = 620;
const SUPPORT_PAST  = 220;
const HIT_WINDOW = 110;
const PERFECT_WINDOW = 50;
const AUTO_SPEED = true;
const SPEEDUP_MULT = 1.15; // å°‘ã—ãƒã‚¤ãƒ«ãƒ‰ã«
const MAX_SPEED = 11.0;
const MIN_SPEED = 2.6;

const MAX_ACTIVE_GROUPS = 6;
const MIN_SPAWN_GAP_PX = 260;

const STRING_LABELS = ['1A','2E','3C','4G'];
const STRING_COLORS = ['#ff5757', '#ffde59', '#7ed957', '#5ce1e6'];

let fretWidth = 0;
let baseScrollSpeed = 3.5;
let scrollSpeed = 3.5;
let gameMode = 'practice';

// ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ç”¨
let waitHold = false;
let waitHoldPrevSpeed = 0;
let waitTargetGroup = null;

// ã‚¹ãƒãƒ¼ãƒ³åˆ¶å¾¡
let currentLevelChords = [];
let practiceOrder = 'cycle';
let practiceIndex = 0;
let scaleSeq = ['do','re','mi','fa','so','la','si','do2'];
let scaleIndex = 0;
let spawnInterval = 1800;
let spawnMinInterval = 900;
let spawnStep = 120;
let startBannerText = '';

// ãƒ‡ãƒ¼ã‚¿å®šç¾©
const CHORD_LIB = {
  'C':  { name: 'C',  targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'è–¬'}] },
  'F':  { name: 'F',  targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 4, f: 2, txt: 'ä¸­'}] },
  'G7': { name: 'G7', targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 1, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}] },
  'Am': { name: 'Am', targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'ä¸­'}] },
  'G':  { name: 'G',  targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'äºº'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'A7': { name: 'A7', targetIdx: 0, fingers: [{s: 3, f: 1, txt: 'äºº'}] },
  'Dm': { name: 'Dm', targetIdx: 0, fingers: [{s: 4, f: 2, txt: 'ä¸­'}, {s: 3, f: 1, txt: 'äºº'}, {s: 2, f: 1, txt: 'äºº'}] },
  'Em': { name: 'Em', targetIdx: 0, fingers: [{s: 3, f: 4, txt: 'å°'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'D7': { name: 'D7', targetIdx: 0, fingers: [{s: 2, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}, {s: 4, f: 2, txt: 'äºº'}] }
};
const SOLO_LIB = {
  'do':  { name: '', targetIdx: 0, fingers: [{s: 3, f: 0, txt: '0'}] },
  're':  { name: '', targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'ä¸­'}] },
  'mi':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 0, txt: '0'}] },
  'fa':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}] },
  'so':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 3, txt: 'è–¬'}] },
  'la':  { name: '', targetIdx: 0, fingers: [{s: 1, f: 0, txt: '0'}] },
  'si':  { name: '', targetIdx: 0, fingers: [{s: 1, f: 2, txt: 'ä¸­'}] },
  'do2': { name: '', targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'è–¬'}] }
};
const SONG_DATA = [
  { lib: CHORD_LIB, key: 'C', lyrics: "ãã‚‰" }, { lib: SOLO_LIB, key: 'do', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ãã‚‰" }, { lib: SOLO_LIB, key: 'so', lyrics: "" },
  { lib: CHORD_LIB, key: 'F', lyrics: "ã²ã‹" }, { lib: SOLO_LIB, key: 'la', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚‹ãƒ¼" }, { lib: SOLO_LIB, key: 'so', lyrics: "" },
  { lib: CHORD_LIB, key: 'G7', lyrics: "ãŠã" }, { lib: SOLO_LIB, key: 'fa', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚‰ã®" }, { lib: SOLO_LIB, key: 'mi', lyrics: "" },
  { lib: CHORD_LIB, key: 'G7', lyrics: "ã»ã—" }, { lib: SOLO_LIB, key: 're', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚ˆãƒ¼" }, { lib: SOLO_LIB, key: 'do', lyrics: "" }
];
let songIndex = 0;
let isSongMode = false;
let audioCtx = null;
let lastStart = null; // ãƒªãƒˆãƒ©ã‚¤ç”¨ä¿å­˜

// --- UI Event Listeners ---
stopBtnEl.addEventListener('click', () => { if (gameState === 'PLAY') pauseGame(); });
document.querySelectorAll('.mode-pill').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.preventDefault(); e.stopPropagation();
    setPlayMode(btn.dataset.mode || 'TEST');
  });
});
setPlayMode(playModeSelected);

function setPlayMode(mode){
  playModeSelected = mode;
  document.querySelectorAll('.mode-pill').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
}

// --- Start Functions ---
function startScale(){
  initGame('scale', null, {speedBase: 3.4, interval: 2000, minInterval: 900, step: 120 });
}
function startChordsEasy(){
  initGame('practice', ['C','F','G7','Am'], { speedBase: 3.2, order: 'cycle' });
}
function startChordsHard(){
  initGame('practice', ['C','F','G7','Am','G','A7','Dm','Em','D7'], { speedBase: 3.35, order: 'cycle' });
}
function startSongTwinkle(){
  initGame('song', 'ãã‚‰ãã‚‰æ˜Ÿ', {speedBase: 3.45});
}

// --- Main Game Init ---
function initGame(mode, levelData, options = {}) {
  // å¤šé‡èµ·å‹•é˜²æ­¢
  if(rafId) cancelAnimationFrame(rafId);
  
  gameState = 'PLAY';
  // Android/PC: try fullscreen to eliminate browser UI
  tryEnterFullscreen();
  // Viewport lock: avoid iOS UI bar size wobble during PLAY
  lockViewport();
  kickHideBars();
  playModeActive = playModeSelected;
  
  // â˜…ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã®å¾¹åº•â˜…
  // å‰å›ã®åŠ é€ŸçŠ¶æ…‹ã‚’å¼•ãç¶™ãŒãªã„ã‚ˆã†ã€ã“ã“ã§åˆæœŸå€¤ã‚’ç¢ºå®šã•ã›ã‚‹
  baseScrollSpeed = (typeof options.speedBase === 'number') ? options.speedBase : 3.5;
  scrollSpeed = baseScrollSpeed; // å¿…ãšåˆæœŸå€¤ã«æˆ»ã™
  
  score = 0; 
  combo = 0;
  groups = []; 
  pops = []; 
  stars = [];
  flashes = []; 
  toasts = [];
  
  waitHold = false;
  waitTargetGroup = null;
  
  gameMode = mode;
  isSongMode = (mode === 'song');
  practiceIndex = 0;
  scaleIndex = 0;
  songIndex = 0;

  // å‡ºç¾é–“éš”ã®ãƒªã‚»ãƒƒãƒˆ
  if (mode === 'scale') {
    spawnInterval = options.interval ?? 2000;
    spawnMinInterval = options.minInterval ?? 900;
    spawnStep = options.step ?? 120;
    startBannerText = "ãƒ‰ãƒ¬ãƒŸã® ã‚Œã‚“ã—ã‚…ã†ï¼";
  } else {
    spawnInterval = 1800;
    spawnMinInterval = 900;
    spawnStep = 120;
    startBannerText = "";
  }
  
  practiceOrder = options.order || 'cycle';
  currentLevelChords = Array.isArray(levelData) ? levelData : (levelData ? [levelData] : ['C']);
  
  // ãƒªãƒˆãƒ©ã‚¤ç”¨ã«ä¿å­˜
  lastStart = { mode, levelData, options };

  // UIæ›´æ–°
  document.getElementById('menu-overlay').style.display = 'none';
  document.getElementById('result-overlay').style.display = 'none';
  document.getElementById('pause-overlay').style.display = 'none';
  document.getElementById('back-btn').style.display = 'none'; // ã‚²ãƒ¼ãƒ ä¸­ã¯é‚ªé­”ãªã‚‰æ¶ˆã™/å‡ºã™
  
  document.getElementById('score-panel').style.display = 'block';
  timerPanel.style.display = 'block';
  stopBtnEl.style.display = 'block';
  document.getElementById('score').innerText = "0";
  lyricsEl.innerText = "";
  
  gameEndAt = performance.now() + GAME_DURATION_MS;
  timerEl.innerText = Math.ceil(GAME_DURATION_MS/1000);
  
  titleOpacity = (mode === 'song') ? 2.0 : 0.0;
  lastFrameT = 0;
  lastSpawn = performance.now();

  // AudioContext (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãŸã‚ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§)
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();

  rafId = requestAnimationFrame(gameLoop);
}

// --- Audio ---
function playTick() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

// --- Classes (Visuals) ---
class FlashText {
  constructor(text, x, y) {
    this.text = text; this.x = x; this.y = y;
    this.life = 1.0; this.scale = 0.6; this.t = 0;
  }
  update() { this.t++; this.life -= 0.02; this.scale = Math.min(1.35, this.scale + 0.06); }
  draw() {
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.life);
    ctx.translate(this.x + Math.sin(this.t * 0.6)*6, this.y);
    ctx.scale(this.scale, this.scale);
    ctx.font = "900 80px sans-serif";
    ctx.textAlign = "center";
    ctx.strokeStyle = "white"; ctx.lineWidth = 10;
    ctx.strokeText(this.text, 0, 0);
    ctx.fillStyle = "#ff7a3d"; ctx.fillText(this.text, 0, 0);
    ctx.restore();
  }
}

class ToastText {
  constructor(text) {
    this.text = text; this.life = 1.0; this.y = 150;
  }
  update() { this.life -= 0.02; }
  draw() {
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.life) * 0.8;
    ctx.font = "900 20px sans-serif";
    ctx.textAlign = "center"; ctx.fillStyle = "#333";
    ctx.fillText(this.text, canvas.width/2, this.y);
    ctx.restore();
  }
}

class Star {
  constructor(x, y) {
    this.x = x; this.y = y;
    this.vx = (Math.random()-0.5)*20; this.vy = (Math.random()-0.5)*20;
    this.life = 1.0; this.color = `hsl(${Math.random()*360},100%,75%)`; this.size = Math.random()*8+4;
  }
  update() { this.x += this.vx; this.y += this.vy; this.life -= 0.03; this.vy += 0.5; }
  draw() {
    ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }
}

class PopText {
  constructor(text, x, y, isCombo=false) {
    this.text = text; this.x = x; this.y = y; this.life = 1.0; this.scale = 0.5; this.isCombo = isCombo;
  }
  update() { this.life -= 0.02; this.y -= 2; this.scale = Math.min(1.2, this.scale + 0.05); }
  draw() {
    ctx.save(); ctx.globalAlpha = this.life;
    ctx.translate(this.x, this.y); ctx.scale(this.scale, this.scale);
    ctx.font = this.isCombo ? "bold 50px sans-serif" : "italic 900 80px sans-serif";
    ctx.textAlign = "center"; ctx.strokeStyle = "white"; ctx.lineWidth = 8;
    ctx.strokeText(this.text, 0, 0);
    ctx.fillStyle = this.isCombo ? "#ffde59" : "#ff66c4";
    ctx.fillText(this.text, 0, 0); ctx.restore();
  }
}

class ChordGroup {
  constructor(chordData, lyrics="") {
    this.chord = chordData; this.lyrics = lyrics;
    this.x = canvas.width + 120; this.active = true; this.ticked = false;
  }
  update() {
    this.x -= scrollSpeed;
    if (!this.ticked && this.x <= NUT_X) {
      playTick(); if (this.lyrics) lyricsEl.innerText = this.lyrics;
      this.ticked = true;
    }
  }
  draw(isTarget) {
    const centerY = canvas.height / 2;
    // ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‹ã¤ãƒŠãƒƒãƒˆä»˜è¿‘ï¼‰
    if (isTarget && this.active) {
      const dx = Math.abs(this.x - NUT_X);
      if (dx < SUPPORT_AHEAD) {
        const t = Math.max(0, 1 - (dx/SUPPORT_AHEAD));
        const alpha = 0.2 + t * 0.6;
        const size = 32 + t * 10;
        
        // ã€Œ0ã¯é–‹æ”¾ã€ãƒ’ãƒ³ãƒˆ
        if (this.chord.fingers.some(f=>f.f===0)) {
           ctx.save(); ctx.globalAlpha = alpha; ctx.fillStyle = "#fff"; ctx.font="bold 18px sans-serif"; ctx.textAlign="center";
           ctx.fillText("0 ã¯æŒ‡ã‚’ã¯ãªã™", NUT_X + 160, centerY - 180); ctx.restore();
        }
        
        this.chord.fingers.forEach(f => {
          const fx = (f.f===0) ? NUT_X : NUT_X + (f.f*fretWidth) - (fretWidth/2);
          const fy = centerY + (f.s - 2.5) * 75;
          this.drawCircle(fx, fy, (f.f===0?'0':f.txt), size, alpha, true);
        });
      }
    }

    if (this.active) {
      // æœ¬ä½“ã®æç”»
      const tf = this.chord.fingers[this.chord.targetIdx];
      const nameX = (tf.f===0) ? this.x : this.x + (tf.f*fretWidth) - (fretWidth/2);
      
      // ã‚³ãƒ¼ãƒ‰åè¡¨ç¤ºï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ã¿ä¸Šéƒ¨ã«è¡¨ç¤ºã€ä»–ã¯HUDï¼‰
      if (gameMode === 'scale') {
        ctx.fillStyle = "#fff"; ctx.font = "bold 50px sans-serif"; ctx.textAlign = "center";
        ctx.fillText(this.chord.name || "", nameX, centerY - 180);
      }
      
      // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ç‚¹æ»…
      const isWaitTarget = (waitHold && playModeActive==='WAIT' && waitTargetGroup === this);
      const blink = isWaitTarget ? (0.5 + 0.5*Math.sin(performance.now()/100)) : 1.0;
      
      this.chord.fingers.forEach(f => {
        const fx = (f.f===0) ? this.x : this.x + (f.f * fretWidth) - (fretWidth / 2);
        const fy = centerY + (f.s - 2.5) * 75;
        this.drawCircle(fx, fy, (f.f===0?'0':f.txt), isWaitTarget?46:40, isWaitTarget?1.0:1.0, false, isWaitTarget?blink:1.0);
      });
    }
  }
  
  drawCircle(x, y, txt, size, alpha, blur, scale=1.0) {
    ctx.save();
    ctx.globalAlpha = alpha;
    if (blur) ctx.filter = "blur(2px)";
    ctx.translate(x, y); ctx.scale(scale, scale);
    ctx.beginPath(); ctx.arc(0, 0, size, 0, Math.PI * 2);
    // æŒ‡ã”ã¨ã®è‰²
    ctx.fillStyle = (txt==='è–¬')?'#5271ff':(txt==='ä¸­'?'#ff66c4':(txt==='äºº'?'#ff914d':'#888'));
    ctx.fill(); 
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.stroke();
    
    ctx.filter = "none"; ctx.fillStyle = "#fff"; 
    ctx.font = `bold ${size*0.75}px sans-serif`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(txt, 0, 2);
    ctx.restore();
  }
}

// --- Game Logic ---

function stopGame(reason) {
  gameState = 'MENU';
  tryExitFullscreen();
  // Release viewport lock when back to menu
  unlockViewport();
  // Reset speeds back to defaults for next start
  baseScrollSpeed = 3.5;
  scrollSpeed = baseScrollSpeed;
  if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
  
  // UIãƒªã‚»ãƒƒãƒˆ
  document.getElementById('menu-overlay').style.display = 'flex';
  document.getElementById('pause-overlay').style.display = 'none';
  document.getElementById('result-overlay').style.display = 'none';
  document.getElementById('score-panel').style.display = 'none';
  timerPanel.style.display = 'none';
  stopBtnEl.style.display = 'none';
  document.getElementById('back-btn').style.display = 'none';
  chordHUDEl.style.display = 'none';
  
  // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆï¼ˆå¿µã®ãŸã‚ï¼‰
  groups = [];
  scrollSpeed = baseScrollSpeed;
}

let pausedRemainMs = 0;
function pauseGame(){
  if (gameState !== 'PLAY') return;
  pausedRemainMs = Math.max(0, gameEndAt - performance.now());
  gameState = 'PAUSE';
  cancelAnimationFrame(rafId);
  document.getElementById('pause-overlay').style.display = 'flex';
}
function resumeGame(){
  if (gameState !== 'PAUSE') return;
  gameEndAt = performance.now() + pausedRemainMs;
  gameState = 'PLAY';
  // Android/PC: try fullscreen to eliminate browser UI
  tryEnterFullscreen();
  // Viewport lock: avoid iOS UI bar size wobble during PLAY
  lockViewport();
  kickHideBars();
  document.getElementById('pause-overlay').style.display = 'none';
  lastFrameT = 0; 
  rafId = requestAnimationFrame(gameLoop);
}
function goMenuFromPause(){ stopGame('MENU'); }
function goMenu(){ stopGame('MENU'); }
function restartLast(){ if(lastStart) initGame(lastStart.mode, lastStart.levelData, lastStart.options); else goMenu(); }

function endGame(){
  gameState = 'RESULT';
  cancelAnimationFrame(rafId);
  document.getElementById('result-score').innerText = score;
  document.getElementById('result-overlay').style.display = 'flex';
  
  let msg = "Nice Try!";
  if (score > 300) msg = "Amazing!!";
  else if (score > 150) msg = "Great Job!";
  document.getElementById('result-msg').innerText = msg;
}

function handleAction() {
  if (gameState !== 'PLAY') return;

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸å®šï¼ˆä¸€ç•ªè¿‘ã„ã‚‚ã®1ã¤ï¼‰
  let target = null;
  let bestDist = Infinity;
  
  // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯å›ºå®š
  if (waitHold && playModeActive === 'WAIT' && waitTargetGroup && waitTargetGroup.active) {
     target = waitTargetGroup;
     bestDist = Math.abs(target.x - NUT_X);
  } else {
    for (let g of groups) {
      if (!g.active) continue;
      const dx = g.x - NUT_X;
      if (dx > SUPPORT_AHEAD || dx < -SUPPORT_PAST) continue; // ç¯„å›²å¤–ç„¡è¦–
      const d = Math.abs(dx);
      if (d < bestDist) { bestDist = d; target = g; }
    }
  }

  // åˆ¤å®š
  let hit = false;
  let skipMiss = false;

  if (target) {
    // TESTãƒ¢ãƒ¼ãƒ‰ã¯åˆ¤å®šã‚¬ãƒã‚¬ãƒ
    const win = (playModeActive === 'TEST') ? HIT_WINDOW * 2.0 : HIT_WINDOW;
    
    if (bestDist < win) {
      // HIT!
      hit = true;
      target.active = false;
      
      // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰è§£é™¤
      if (waitHold) {
        waitHold = false;
        scrollSpeed = (waitHoldPrevSpeed > 0) ? waitHoldPrevSpeed : MIN_SPEED;
        waitTargetGroup = null;
        lastSpawn = performance.now(); // ã™ãæ¬¡ãŒå‡ºãªã„ã‚ˆã†ã«
        toasts.push(new ToastText("OK! Go!"));
      }
      
      combo++;
      // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—
      if (combo % 5 === 0 && AUTO_SPEED) {
         flashes.push(new FlashText('SPEED UP!', canvas.width/2, canvas.height/2 - 80));
         scrollSpeed = Math.min(MAX_SPEED, scrollSpeed * SPEEDUP_MULT);
      }
      
      const isPerfect = (bestDist < PERFECT_WINDOW);
      score += (isPerfect ? 15 : 10);
      document.getElementById('score').innerText = score;
      
      pops.push(new PopText(isPerfect?"Perfect!":"Good!", canvas.width/2, canvas.height/2));
      pops.push(new PopText(combo+" Chain!", canvas.width/2, canvas.height/2+60, true));
      for(let i=0;i<15;i++) stars.push(new Star(NUT_X, canvas.height/2));

    } else {
      // MISS (è¿‘ãã«ã‚ã‚‹ã‘ã©ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé•ã†)
      if (playModeActive === 'WAIT') {
        // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ï¼šæ­¢ã¾ã‚‹
        if (!waitHold) {
          waitHold = true;
          waitHoldPrevSpeed = scrollSpeed;
          scrollSpeed = 0;
          waitTargetGroup = target;
          target.x = NUT_X; // å¼·åˆ¶çš„ã«åˆã‚ã›ã‚‹
          combo = 0;
          flashes.push(new FlashText('Wait!', canvas.width/2, canvas.height/2));
          toasts.push(new ToastText('ã²ã‹ã‚‹ãƒãƒ¼ã‚¯ã‚’ ã‚¿ãƒƒãƒ—ï¼'));
        }
        skipMiss = true;
      }
    }
  }

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒãªã„ã€ã¾ãŸã¯å¤–ã—ãŸæ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£
  if (!hit && !skipMiss) {
    if (combo > 0) {
      combo = 0;
      if (AUTO_SPEED) {
        scrollSpeed = Math.max(MIN_SPEED, scrollSpeed * 0.9); // å°‘ã—æ¸›é€Ÿ
        toasts.push(new ToastText("Speed Down..."));
      }
    }
  }
}

// --- Draw & Loop ---
function drawFretboard() {
  const midY = canvas.height / 2;
  const fw = (canvas.width - NUT_X - 60) / 12; // 12ãƒ•ãƒ¬ãƒƒãƒˆåˆ†
  fretWidth = fw;
  
  // æŒ‡æ¿
  ctx.fillStyle = "#6d4c41"; ctx.fillRect(NUT_X, midY - 150, canvas.width, 300);
  
  // ãƒ•ãƒ¬ãƒƒãƒˆç·š
  for (let i = 0; i <= 12; i++) {
    const x = NUT_X + i * fw;
    ctx.strokeStyle = (i === 0) ? "#eee" : "#a1887f"; 
    ctx.lineWidth = (i === 0) ? 10 : 3;
    ctx.beginPath(); ctx.moveTo(x, midY - 150); ctx.lineTo(x, midY + 150); ctx.stroke();
  }
  
  // å·¦å´ã®å¼¦ãƒ©ãƒ™ãƒ« (Tuning like)
  for (let i = 0; i < 4; i++) {
    const y = midY + (i - 1.5) * 75;
    ctx.beginPath(); ctx.fillStyle = STRING_COLORS[i]; ctx.arc(MARK_CX, y, MARK_R, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.font = "bold 16px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(STRING_LABELS[i], MARK_CX, y);
    
    // å¼¦
    ctx.strokeStyle = STRING_COLORS[i]; ctx.lineWidth = 6;
    ctx.beginPath(); ctx.moveTo(NUT_X, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }
}

let lastFrameT = 0;
function gameLoop(time) {
  if (gameState !== 'PLAY') return;
  
  if (!lastFrameT) lastFrameT = time;
  const dt = time - lastFrameT;
  lastFrameT = time;
  
  // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆWaitä¸­ã¯æ¸›ã‚‰ã•ãªã„ï¼‰
  if (!waitHold) {
     const remain = Math.max(0, gameEndAt - performance.now());
     timerEl.innerText = Math.ceil(remain/1000);
     if (remain <= 0) { endGame(); return; }
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawFretboard();

  // Spawn Logic
  if (!waitHold && (time - lastSpawn > spawnInterval)) {
    // ç”»é¢ãŒ"ã”ã¡ã‚ƒã”ã¡ã‚ƒ"ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼šåŒæ™‚å‡ºç¾æ•°ã¨é–“éš”ã‚’åˆ¶é™
    let activeCount = 0;
    let maxX = -1e9;
    for (let i=0;i<groups.length;i++){
      const g = groups[i];
      if(!g.active) continue;
      activeCount++;
      if (g.x > maxX) maxX = g.x;
    }
    const spawnX = canvas.width + 120;
    const enoughSpace = (maxX < spawnX - MIN_SPAWN_GAP_PX);
    if (activeCount >= MAX_ACTIVE_GROUPS || !enoughSpace) {
      // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†åˆ¤å®šï¼ˆlastSpawnã¯æ›´æ–°ã—ãªã„ï¼‰
    } else {
    if (isSongMode) {
      const data = SONG_DATA[songIndex % SONG_DATA.length];
      groups.push(new ChordGroup(data.lib[data.key], data.lyrics));
      songIndex++;
    } else if (gameMode === 'scale') {
      const k = scaleSeq[scaleIndex % scaleSeq.length];
      groups.push(new ChordGroup(SOLO_LIB[k], ""));
      scaleIndex++;
      if (scaleIndex % scaleSeq.length === 0) { // 1å‘¨ã”ã¨ã«åŠ é€Ÿ
         spawnInterval = Math.max(spawnMinInterval, spawnInterval - spawnStep);
      }
    } else {
      let key;
      if (practiceOrder === 'cycle') {
         key = currentLevelChords[practiceIndex % currentLevelChords.length];
         practiceIndex++;
      } else {
         key = currentLevelChords[Math.floor(Math.random()*currentLevelChords.length)];
      }
      groups.push(new ChordGroup(CHORD_LIB[key], ""));
    }
    lastSpawn = time;
    }
  }

  // HUD Update
  let activeChordName = "";
  let targetIdx = -1; 
  let bestDist = Infinity;
  
  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹å®šï¼ˆæç”»ã¨HUDç”¨ï¼‰
  for(let i=0; i<groups.length; i++){
    const g = groups[i];
    if(!g.active) continue;
    const d = Math.abs(g.x - NUT_X);
    if(d < bestDist && d < SUPPORT_AHEAD + 100) { bestDist = d; targetIdx = i; }
  }
  
  if (targetIdx !== -1) {
    activeChordName = groups[targetIdx].chord.name || "";
  }
  if (gameMode !== 'scale' && activeChordName) {
     chordHUDEl.style.display = 'block'; chordHUDEl.innerText = activeChordName;
  } else {
     chordHUDEl.style.display = 'none';
  }

  // Update & Draw Objects
  for (let i = groups.length - 1; i >= 0; i--) {
    const g = groups[i];
    g.update();
    g.draw(i === targetIdx);
    if (g.x < -300) groups.splice(i, 1);
  }

  // Particles
  stars.forEach(s => { s.update(); s.draw(); });
  stars = stars.filter(s => s.life > 0);
  
  pops.forEach(p => { p.update(); p.draw(); });
  pops = pops.filter(p => p.life > 0);
  
  flashes.forEach(f => { f.update(); f.draw(); });
  flashes = flashes.filter(f => f.life > 0);

  toasts.forEach(t => { t.update(); t.draw(); });
  toasts = toasts.filter(t => t.life > 0);

  // Start Banner
  if (titleOpacity > 0) {
    ctx.save(); ctx.globalAlpha = Math.min(1, titleOpacity);
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.font = "bold 60px sans-serif";
    ctx.fillText(startBannerText || "Ready?", canvas.width/2, canvas.height/2);
    ctx.restore();
    titleOpacity -= 0.02;
  }

  rafId = requestAnimationFrame(gameLoop);
}



// --- Best-effort: hide Safari/Chrome UI bars ---
function kickHideBars(){
  // iOS Safari: cannot force-hide completely (PWA/ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ãŒå”¯ä¸€ç¢ºå®Ÿ)
  // but this reduces re-appearing by nudging scroll position.
  try {
    window.scrollTo(0, 1);
    setTimeout(()=>window.scrollTo(0, 1), 60);
    setTimeout(()=>window.scrollTo(0, 1), 220);
  } catch(e) {}
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå…¥ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶éƒ½åˆã§åŠ¹ãæ™‚ã ã‘åŠ¹ãï¼‰
document.addEventListener('touchstart', () => kickHideBars(), {passive:true});
document.addEventListener('pointerdown', () => kickHideBars(), {passive:true});

// --- Resize & Input Handling (viewport-safe) ---
const appEl = document.getElementById('app');
let viewportLocked = false;
let lockedW = 0, lockedH = 0;

function getViewportSize(){
  const vv = window.visualViewport;
  const w = Math.round(vv ? vv.width : window.innerWidth);
  const h = Math.round(vv ? vv.height : window.innerHeight);
  return { w, h };
}

function applyViewportSize(w, h){
  // Keep CSS size and canvas coordinate system aligned in *CSS pixels*.
  // (Avoid DPR scaling here because the existing game math uses canvas.width/height directly.)
  appEl.style.width = w + 'px';
  appEl.style.height = h + 'px';
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  canvas.width = w;
  canvas.height = h;
}

function handleResize(){
  if (viewportLocked) return;
  const { w, h } = getViewportSize();
  applyViewportSize(w, h);
}

function lockViewport(){
  const { w, h } = getViewportSize();
  viewportLocked = true;
  lockedW = w;
  lockedH = h;
  applyViewportSize(lockedW, lockedH);
}

function unlockViewport(){
  viewportLocked = false;
  handleResize();
}

window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', () => {
  // iOS: orientationchange fires before dimensions settle
  setTimeout(() => { viewportLocked ? lockViewport() : handleResize(); }, 80);
});
if (window.visualViewport) {
  visualViewport.addEventListener('resize', () => { viewportLocked ? lockViewport() : handleResize(); });
  // Address bar show/hide can fire scroll events; ignore while locked to prevent "size wobble"
  visualViewport.addEventListener('scroll', () => { if (!viewportLocked) handleResize(); });
}
handleResize();

// â˜…ä¿®æ­£: ã‚¿ãƒƒãƒã¨ãƒã‚¦ã‚¹ã®é‡è¤‡é˜²æ­¢
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault(); // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«é˜²æ­¢
  if(gameState === 'PLAY') handleAction();
}, {passive: false});

canvas.addEventListener('mousedown', (e) => {
  if(gameState === 'PLAY') handleAction();
});

// åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®è£œæ­£
window.onload = function(){
   kickHideBars();
};

// ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç„¡åŠ¹åŒ–ï¼ˆè¦‹ãŸç›®å›ºå®šï¼‰ã€‚ãŸã ã— kickHideBars() ã® scrollTo ã¯è¨±å¯
document.addEventListener('touchmove', (e)=>{
  const mo = document.getElementById('menu-overlay');
  const isMenu = mo && getComputedStyle(mo).display !== 'none';
  if(!isMenu){ e.preventDefault(); }
}, {passive:false});

</script>
</body>
</html>