<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#88cfd3" />
  <title>ã‚¦ã‚¯ãƒ¬ãƒ¬ãƒ»ã‚­ãƒƒã‚º - ã‚½ãƒ­ã‚‚ã²ã‘ã‚‹ã‚ˆï¼</title>
  <style>

:root{
  --vvTop: 0px;
  --vvLeft: 0px;

  --bgTop: rgba(168,230,207,0.45);
  --bgMid: rgba(122,177,204,0.22);
  --bgBottom: rgba(255,255,255,0.92);
  --text: #4a3728;
  --card: rgba(255,255,255,0.92);
  --shadow: rgba(0,0,0,0.18);
  --primary: #ff7a3d;
  --mint: #a8e6cf;
  --sky: #7ab1cc;
  --aqua: #5ce1e6;
  --markSize: clamp(54px, 10vw, 66px);
}

body{
  margin:0;
    background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%);
  color: var(--text);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  overflow:hidden;
  }
canvas{ display:block; width:100%; height:100%; touch-action:none; }

#menu-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.32);
  display:flex; align-items:flex-start; justify-content:center;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding: max(12px, env(safe-area-inset-top)) 18px max(12px, env(safe-area-inset-bottom));
  z-index: 100;
  backdrop-filter: blur(2px);
}
.menu-card{
  background: var(--card);
  max-height: calc(100dvh - 36px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  color: var(--text);
  width: min(560px, 96vw);
  margin: 0 auto;
  border-radius: 18px;
  padding: 18px 18px 14px;
  box-shadow: 0 12px 0 rgba(122,177,204,0.35), 0 18px 36px var(--shadow);
  border: 2px solid rgba(255,255,255,0.65);
}
.menu-card h1{
  margin: 0 0 10px;
  font-size: 26px;
  letter-spacing: 0.3px;
}
.menu-card .sub{
  margin: 0 0 14px;
  font-size: 13px;
  opacity: 0.85;
  line-height: 1.5;
}
.menu-list{ display:flex; flex-direction:column; gap:10px; margin-top: 6px; }
.menu-btn{
  appearance:none; border: none;
  background: rgba(255,255,255,0.98);
  color: var(--text);
  width: 100%;
  border-radius: 16px;
  padding: 12px 12px;
  cursor: pointer;
  display:flex; gap: 12px; align-items:flex-start;
  box-shadow: 0 6px 0 rgba(122,177,204,0.32);
  transition: transform 0.08s ease, box-shadow 0.08s ease;
}
.menu-btn:active{ transform: translateY(3px); box-shadow: none; }
.badge{
  flex: 0 0 auto;
  width: 34px; height: 34px;
  border-radius: 12px;
  background: var(--primary);
  display:flex; align-items:center; justify-content:center;
  color: #fff;
  font-weight: 900;
  box-shadow: 0 5px 0 rgba(0,0,0,0.14);
}
.menu-btn.mode2 .badge{ background: #ffde59; color:#4a3728; }
.menu-btn.mode3 .badge{ background: #7ed957; }
.menu-btn.mode4 .badge{ background: var(--aqua); color: #133; }
.menu-btn .title{ font-size: 18px; font-weight: 900; line-height: 1.2; }
.menu-btn small{ display:block; font-size: 13px; font-weight: 650; opacity: 0.86; margin-top: 4px; line-height: 1.35; }
.menu-btn .menu-text{ flex:1 1 auto; text-align:left; }
.badge{ font-size: 20px; }


#lyrics-area{
  position:absolute; top: calc(10px + env(safe-area-inset-top) + var(--vvTop)); left: 50%; transform: translateX(-50%);
  width: min(720px, 92vw);
  text-align:center;
  font-size: 34px;
  font-weight: 900;
  color: var(--text);
  text-shadow: 0 3px 10px rgba(255,255,255,0.75);
  pointer-events:none;
  z-index: 5;
}
#score-panel{
  position:fixed; top: calc(12px + env(safe-area-inset-top) + var(--vvTop)); left: calc(12px + env(safe-area-inset-left) + var(--vvLeft));
  font-size: 22px; font-weight: 900;
  z-index: 90; display:none;
  background: rgba(255,255,255,0.85);
  padding: 8px 10px;
  border-radius: 14px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
}

#timer-panel{
  position: fixed;
  top: calc(12px + env(safe-area-inset-top) + var(--vvTop));
  right: calc(12px + env(safe-area-inset-right));
  z-index: 90;
  display: none;
  padding: 8px 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.85);
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
  font-weight: 900;
  font-size: 16px;
}

#stopBtn{
  position: fixed;
  right: calc(14px + env(safe-area-inset-right));
  bottom: calc(14px + env(safe-area-inset-bottom));
  z-index: 180;
  display: none;
  border: none;
  border-radius: 16px;
  padding: 12px 14px;
  background: rgba(255,255,255,0.92);
  color: var(--text);
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 10px 24px rgba(0,0,0,0.12);
}
#stopBtn:active{ transform: translateY(2px); box-shadow: 0 6px 14px rgba(0,0,0,0.10); }

/* Pause / Result overlays */
#pause-overlay, #result-overlay{
  position: fixed; inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 120;
  pointer-events: auto;
  background: radial-gradient(circle at 20% 15%, rgba(255,255,255,0.78), rgba(255,122,61,0.18) 45%, rgba(168,230,207,0.34) 78%, rgba(122,177,204,0.26));
  backdrop-filter: blur(3px);
}

#pause-overlay{
  background: rgba(0,0,0,0.38);
}
.pause-card{
  width: min(520px, calc(100vw - 28px));
  border-radius: 22px;
  padding: 18px 18px 16px;
  background: rgba(255,255,255,0.95);
  box-shadow: 0 18px 40px rgba(0,0,0,0.22);
  text-align: center;
}
.pause-title{
  font-weight: 1000;
  font-size: 28px;
  margin-bottom: 6px;
}
.pause-sub{
  font-weight: 700;
  font-size: 14px;
  line-height: 1.4;
  opacity: 0.9;
  margin-bottom: 12px;
}
.pause-menu{
  border: none;
  border-radius: 16px;
  padding: 12px 14px;
  background: rgba(0,0,0,0.08);
  font-weight: 900;
  cursor: pointer;
}
#result-overlay{
  background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.35), rgba(0,0,0,0.45));
}
.result-card{
  width: min(560px, calc(100vw - 28px));
  border-radius: 26px;
  padding: 18px 18px 16px;
  background: rgba(255,255,255,1.0);
  box-shadow: 0 22px 48px rgba(0,0,0,0.28);
  border: 6px solid rgba(255,255,255,0.95);
  outline: 3px solid rgba(255,122,61,0.22);
  text-align: center;
  position: relative;
  overflow: hidden;
}
.result-card:before{
  content:"";
  position:absolute; inset:-40px;
  background: conic-gradient(from 90deg, rgba(255,122,61,0.35), rgba(92,225,230,0.35), rgba(126,217,87,0.35), rgba(255,222,89,0.35), rgba(255,122,61,0.35));
  filter: blur(18px);
  opacity: 0.9;
  z-index: 0;
}
.result-card > *{ position: relative; z-index: 1; }
.result-title{
  font-weight: 1000;
  font-size: 54px;
  background: linear-gradient(90deg, #ff7a3d, #ff5757, #7ed957, #5ce1e6);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
  text-shadow: none;

  letter-spacing: 1px;
  text-shadow: 0 6px 0 rgba(255,255,255,0.65);
  animation: popTitle 0.9s ease-out both;
}
.result-sub{
  font-weight: 1000;
  font-size: 20px;
  margin-top: 4px;
  margin-bottom: 10px;
  animation: popTitle 1.0s ease-out both;
}
.result-score{
  font-weight: 1000;
  font-size: 34px;
  margin: 10px 0 6px;
}
.result-msg{
  font-weight: 900;
  font-size: 16px;
  opacity: 0.95;
  margin-bottom: 14px;
}
.result-actions{
  display:flex;
  gap: 10px;
  justify-content: center;
}
.result-btn{
  border:none;
  border-radius: 18px;
  padding: 12px 16px;
  font-weight: 1000;
  cursor: pointer;
  background: rgba(0,0,0,0.08);
}
.result-btn.primary{
  background: rgba(255,122,61,0.95);
  color: #fff;
}
@keyframes popTitle{
  0%{ transform: translateY(10px) scale(0.9); opacity: 0; }
  100%{ transform: translateY(0) scale(1); opacity: 1; }
}


.pause-resume{
  width: 100%;
  border: none;
  border-radius: 18px;
  padding: 14px 16px;
  background: rgba(255,122,61,0.95);
  color: #fff;
  font-weight: 1000;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 14px 28px rgba(0,0,0,0.18);
  margin-bottom: 10px;
}
.pause-resume:active{ transform: translateY(1px) scale(0.99); }



  /* ===== ãƒ¢ãƒ¼ãƒ‰ã›ã‚Œãã¨ ===== */
  .mode-select{
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid rgba(0,0,0,0.08);
  }
  .mode-select-title{
    font-weight: 900;
    color: rgba(0,0,0,0.55);
    font-size: 13px;
    letter-spacing: .5px;
    margin: 0 0 8px;
  }
  .mode-pills{
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  .mode-pill{
    border: 2px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.85);
    border-radius: 999px;
    padding: 8px 12px;
    font-weight: 900;
    font-size: 13px;
    cursor: pointer;
    box-shadow: 0 6px 0 rgba(0,0,0,0.10);
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .mode-pill:active{ transform: translateY(2px); box-shadow: 0 4px 0 rgba(0,0,0,0.10); }
  .mode-pill.active{
    border-color: rgba(255,122,61,0.60);
    background: rgba(255,122,61,0.12);
  }



@media (max-height: 420px){
  .menu-card{ padding: 14px 14px 10px; border-radius: 16px; }
  .menu-card h1{ font-size: 22px; margin: 0 0 8px; }
  .menu-card .sub{ margin: 0 0 10px; font-size: 12px; }
  .menu-list{ gap: 8px; }
  .menu-btn{ padding: 10px 12px; }
}


#back-btn{
  position:fixed;
  top: calc(10px + env(safe-area-inset-top) + var(--vvTop));
  left: calc(10px + env(safe-area-inset-left) + var(--vvLeft));
  z-index: 120;
  display:none;
}
#back-btn a{
  display:inline-block;
  text-decoration:none;
  color: #0d2b3b;
  font-weight: 900;
  background: rgba(255,255,255,0.82);
  padding: 10px 12px;
  border-radius: 16px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
}

#chordHud{
  position:fixed;
  top: calc(58px + env(safe-area-inset-top) + var(--vvTop));
  left: 50%;
  transform: translateX(-50%);
  z-index: 125;
  display:none;
  pointer-events:none;
  background: rgba(255,255,255,0.86);
  border-radius: 18px;
  padding: 8px 14px;
  font-weight: 900;
  font-size: clamp(22px, 4.2vw, 40px);
  letter-spacing: 0.02em;
  box-shadow: 0 10px 24px rgba(0,0,0,0.14);
}

    /* --- UIBAR FIX PATCH (GitHub Pages / Safari) ------------------------- */
    /* Make the document scrollable by 1px so Safari can collapse the address bar.
       Keep the actual game UI fixed, so scrolling does not move the game. */
    body{ overflow-y: scroll !important; }
    #app{ position: fixed; inset: 0; overflow: hidden; }
    #scroll-hack{ height: 1px; width: 1px; }
    @supports (height: 100dvh){
      #app{ height: 100dvh; }
    }
    /* ------------------------------------------------------------------- */

</style>
</head>
<body>
<div id="app">

  <div id="menu-overlay">
  <div class="menu-card">
    <h1>ğŸ¸ ã‚¿ãƒƒãƒ—ã§ã‚Œã‚“ã—ã‚…ã†</h1>
    <p class="sub">ã¾ãšã¯ã‚¿ãƒƒãƒ—å¼ã§å®Œæˆã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<br>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãˆã‚‰ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>

    <div class="menu-list">
      <button class="menu-btn mode1" onclick="startScale()">
        <div class="badge">ğŸ¤</div>
        <div class="menu-text">
          <div class="title">ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰</div>
          <small>ãã‚Šè¿”ã—ã¦ã€ã ã‚“ã ã‚“é€Ÿããªã‚‹ï¼ˆåå¾©ã‚Œã‚“ã—ã‚…ã†ï¼‰</small>
        </div>
      </button>

      <button class="menu-btn mode2" onclick="startChordsEasy()">
        <div class="badge">ğŸ±</div>
        <div class="menu-text">
          <div class="title">ã‚³ãƒ¼ãƒ‰ ã‹ã‚“ãŸã‚“</div>
          <small>C / F / G7 / Am ã‚’ ãã‚Šè¿”ã™</small>
        </div>
      </button>

      <button class="menu-btn mode3" onclick="startChordsHard()">
        <div class="badge">ğŸ¼</div>
        <div class="menu-text">
          <div class="title">ã‚³ãƒ¼ãƒ‰ ã¡ã‚‡ã„ã‚€ãš</div>
          <small>C / F / G7 / Am ï¼‹ ã‚ˆãä½¿ã†ã‚³ãƒ¼ãƒ‰ã‚‚ ã‚Œã‚“ã—ã‚…ã†</small>
        </div>
      </button>

      <button class="menu-btn mode4" onclick="startSongTwinkle()">
        <div class="badge">ğŸ¦</div>
        <div class="menu-text">
          <div class="title">å®Ÿã•ã„ã®æ›²</div>
          <small>ãã‚‰ãã‚‰æ˜Ÿï¼ˆã‚½ãƒ­ï¼†ã‚³ãƒ¼ãƒ‰ï¼‰</small>
        </div>
      </button>
    </div>

    <div class="mode-select">
      <div class="mode-select-title">ãƒ¢ãƒ¼ãƒ‰ã›ã‚Œãã¨</div>
      <div class="mode-pills">
        <button class="mode-pill" type="button" data-mode="NORMAL">ãƒãƒ¼ãƒãƒ«ï¼ˆãƒŸã‚¹ã—ã¦ã‚‚é€²ã‚€ï¼‰</button>
        <button class="mode-pill active" type="button" data-mode="WAIT">ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒŸã‚¹ã—ãŸã‚‰æ­¢ã¾ã‚‹ã€€ç·´ç¿’ç”¨ï¼‰</button>
        <button class="mode-pill" type="button" data-mode="TEST">TESTãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒƒãƒ—ã§HITï¼‰</button>
      </div>
    </div>

  </div>
</div>

  <div id="lyrics-area"></div>
  <div class="nav-back" id="back-btn"><a href="#" onclick="location.reload()">ğŸï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a></div>
  <div id="score-panel">â­ <span id="score">0</span></div>
  <div id="timer-panel">ã®ã“ã‚Š <span id="timer">60</span> ç§’</div>
  <div id="chordHud" aria-hidden="true"></div>
  <button id="stopBtn" type="button">ã‚¹ãƒˆãƒƒãƒ—</button>
  <div id="pause-overlay" aria-hidden="true">
    <div class="pause-card">
      <div class="pause-title">ã‚¹ãƒˆãƒƒãƒ—ä¸­</div>
      <div class="pause-sub">ã€Œã¤ã¥ã‘ã‚‹ã€ã§ã€ã¤ã¥ãã‹ã‚‰å†é–‹ã§ãã‚‹ã‚ˆã€‚</div>
      <button class="pause-resume" type="button" onclick="resumeGame()">ã¤ã¥ã‘ã‚‹</button>
      <button class="pause-menu" type="button" onclick="goMenuFromPause()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="result-overlay" aria-hidden="true">
    <div class="result-card">
      <div class="result-title" id="result-title">ãã“ã¾ã§ï¼</div>
      <div class="result-sub">çµæœç™ºè¡¨ï¼ï¼</div>
      <div class="result-score">â­ <span id="result-score">0</span> ã¦ã‚“</div>
      <div class="result-msg" id="result-msg">ã¾ãŸã‚ãã¼ã†ï¼</div>
      <div class="result-actions">
        <button class="result-btn primary" type="button" onclick="restartLast()">ã‚‚ã†ä¸€åº¦</button>
        <button class="result-btn" type="button" onclick="goMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
      </div>
    </div>
  </div>
  <canvas id="gameCanvas"></canvas>

<script>

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const lyricsEl = document.getElementById('lyrics-area');
const timerPanel = document.getElementById('timer-panel');
const timerEl = document.getElementById('timer');
const chordHUDEl = document.getElementById('chordHud');
const stopBtnEl = document.getElementById('stopBtn');

let gameState = 'MENU';

// ===== Mode select =====
let playModeSelected = 'WAIT';   // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§é¸ã¶ï¼ˆæ—¢å®šï¼šä»Šã®å‹•ãã«åˆã‚ã›ã¦TESTï¼‰
let playModeActive   = 'TEST';   // å®Ÿãƒ—ãƒ¬ã‚¤ä¸­ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆstartæ™‚ã«ç¢ºå®šï¼‰

// ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒŸã‚¹ã—ãŸã‚‰æ­¢ã¾ã‚‹ï¼‰
let waitHold = false;
let waitHoldPrevSpeed = 0;
let waitTargetGroup = null; // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ã§â€œä»Šåˆã‚ã›ã‚‹ã¹ãâ€ã‚°ãƒ«ãƒ¼ãƒ—

// ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ç”¨
let lastFrameT = 0;

function setPlayMode(mode){
  playModeSelected = mode;
  document.querySelectorAll('.mode-pill').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
}

let rafId = 0;
let gameEndAt = 0;
const GAME_DURATION_MS = 60 * 1000; // 60ç§’ã§ãŠã‚ã‚Š

let score = 0; let combo = 0; let groups = []; let pops = [];
let flashes = [];
let toasts = []; let stars = [];
let lastSpawn = 0; let titleOpacity = 2.0;
const NUT_X = 180;

const STRING_LABELS = ['1A','2E','3C','4G'];
const STRING_COLORS = ['#ff5757', '#ffde59', '#7ed957', '#5ce1e6'];
const MARK_CX = 125; // ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ã¨åŒã˜ä½ç½®
const MARK_R = 24;   // ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ã¨åŒã˜åŠå¾„
// ã‚µãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰
const SUPPORT_AHEAD = 620;   // ã©ã‚Œãã‚‰ã„æ‰‹å‰ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆã‚’å‡ºã™ã‹
const SUPPORT_PAST  = 220;   // ãƒŠãƒƒãƒˆã‚’éãã¦ã‚‚å°‘ã—ã ã‘æ®‹ã™
const HIT_WINDOW = 110;      // ã‚¿ãƒƒãƒ—åˆ¤å®šã®å¹…
const PERFECT_WINDOW = 50;   // ã•ã‚‰ã«è‰¯ã„åˆ¤å®š
const AUTO_SPEED = true;     // 5ã‚Œã‚“ããã”ã¨ã«åŠ é€Ÿ / ãƒŸã‚¹ã§å°‘ã—æ¸›é€Ÿ
const SPEEDUP_MULT = 1.2;    // 5ã‚Œã‚“ããã”ã¨ã« 1.2ã°ã„
const MAX_SPEED = 10.0;
const MIN_SPEED = 2.6;
let fretWidth = 0;
let baseScrollSpeed = 3.5;
let scrollSpeed = baseScrollSpeed;
let currentLevelChords = [];
let gameMode = 'practice'; // 'practice' | 'scale' | 'song'
let practiceOrder = 'cycle';
let practiceIndex = 0;
let scaleSeq = ['do','re','mi','fa','so','la','si','do2'];
let scaleIndex = 0;
let spawnInterval = 1800;
let spawnMinInterval = 900;
let spawnStep = 120;
let startBannerText = '';

// å’ŒéŸ³ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
const CHORD_LIB = {
  'C':  { name: 'C',  targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'è–¬'}] },
  'F':  { name: 'F',  targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 4, f: 2, txt: 'ä¸­'}] },
  'G7': { name: 'G7', targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 1, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}] },

  // è¿½åŠ ï¼šã‚ˆãä½¿ã†ã‚³ãƒ¼ãƒ‰
  'Am': { name: 'Am', targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'ä¸­'}] },
  'G':  { name: 'G',  targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'äºº'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'A7': { name: 'A7', targetIdx: 0, fingers: [{s: 3, f: 1, txt: 'äºº'}] },
  'Dm': { name: 'Dm', targetIdx: 0, fingers: [{s: 4, f: 2, txt: 'ä¸­'}, {s: 3, f: 1, txt: 'äºº'}, {s: 2, f: 1, txt: 'äºº'}] },
  'Em': { name: 'Em', targetIdx: 0, fingers: [{s: 3, f: 4, txt: 'å°'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'D7': { name: 'D7', targetIdx: 0, fingers: [{s: 2, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}, {s: 4, f: 2, txt: 'äºº'}] }
};

// ã‚½ãƒ­ãƒ¡ãƒ­ãƒ‡ã‚£ï¼ˆå˜éŸ³ï¼‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼šæ¥½è­œã®æ•°å­—ã‚’å†ç¾
const SOLO_LIB = {
  'do':  { name: '', targetIdx: 0, fingers: [{s: 3, f: 0, txt: '0'}] },
  're':  { name: '', targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'ä¸­'}] },
  'mi':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 0, txt: '0'}] },
  'fa':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}] },
  'so':  { name: '', targetIdx: 0, fingers: [{s: 2, f: 3, txt: 'è–¬'}] },
  'la':  { name: '', targetIdx: 0, fingers: [{s: 1, f: 0, txt: '0'}] },
  'si':  { name: '', targetIdx: 0, fingers: [{s: 1, f: 2, txt: 'ä¸­'}] },
  'do2': { name: '', targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'è–¬'}] }
};

// IMG_6639.JPG ã‚’å¿ å®Ÿã«å†ç¾ï¼ˆä¼´å¥ã‚³ãƒ¼ãƒ‰ã¨ã‚½ãƒ­ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’äº¤äº’ã«é…ç½®ï¼‰
const SONG_DATA = [
  { lib: CHORD_LIB, key: 'C', lyrics: "ãã‚‰" }, { lib: SOLO_LIB, key: 'do', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ãã‚‰" }, { lib: SOLO_LIB, key: 'so', lyrics: "" },
  { lib: CHORD_LIB, key: 'F', lyrics: "ã²ã‹" }, { lib: SOLO_LIB, key: 'la', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚‹ãƒ¼" }, { lib: SOLO_LIB, key: 'so', lyrics: "" },
  { lib: CHORD_LIB, key: 'G7', lyrics: "ãŠã" }, { lib: SOLO_LIB, key: 'fa', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚‰ã®" }, { lib: SOLO_LIB, key: 'mi', lyrics: "" },
  { lib: CHORD_LIB, key: 'G7', lyrics: "ã»ã—" }, { lib: SOLO_LIB, key: 're', lyrics: "" },
  { lib: CHORD_LIB, key: 'C', lyrics: "ã‚ˆãƒ¼" }, { lib: SOLO_LIB, key: 'do', lyrics: "" }
];

let songIndex = 0;
let isSongMode = false;
let audioCtx = null;

stopBtnEl.addEventListener('click', () => {
  if (gameState === 'PLAY') pauseGame();
  // PAUSEä¸­ã¯ä¸­å¤®ã®ã€Œã¤ã¥ã‘ã‚‹ã€ã§å†é–‹ã™ã‚‹
  });



// ãƒ¢ãƒ¼ãƒ‰ã›ã‚Œãã¨ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
document.querySelectorAll('.mode-pill').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.preventDefault(); e.stopPropagation();
    setPlayMode(btn.dataset.mode || 'TEST');
  }, { passive:false });
});
// æ—¢å®šå€¤ã‚’åæ˜ 
setPlayMode(playModeSelected);

function startScale(){
  // ã ã‚“ã ã‚“é€Ÿããªã‚‹ï¼šæœ€åˆã¯ã‚†ã£ãã‚Š â†’ æœ€å¾Œã¯ã¡ã‚‡ã£ã¨æ—©ã‚
  initGame('scale', null, {speedBase: 3.4,  interval: 2000, minInterval: 900, step: 120, playMode: playModeSelected});
}
function startChordsEasy(){
  initGame('practice', ['C','F','G7','Am'], { speedBase: 3.2,  order: 'cycle' });
}
function startChordsHard(){
  // ã¡ã‚‡ã„ã‚€ãšï¼šã‚ˆãä½¿ã†ã‚³ãƒ¼ãƒ‰ã‚‚è¿½åŠ ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã«å¢—ã‚„ã—ã¦OKï¼‰
  initGame('practice', ['C','F','G7','Am','G','A7','Dm','Em','D7'], { speedBase: 3.35,  order: 'cycle' });
}
function startSongTwinkle(){
  initGame('song', 'ãã‚‰ãã‚‰æ˜Ÿ', {speedBase: 3.45, playMode: playModeSelected});
}

function initGame(mode, levelData, options = {}) {
  gameState = 'PLAY';
  // ãƒ¢ãƒ¼ãƒ‰ç¢ºå®šï¼ˆstartæ™‚ã«å›ºå®šï¼‰
  playModeActive = (options && options.playMode) ? options.playMode : playModeSelected;
  waitHold = false;
  waitTargetGroup = null;
  lastFrameT = 0;

  // å‰å›è¨­å®šã‚’ä¿å­˜ï¼ˆçµæœç”»é¢ã®ã€Œã‚‚ã†ä¸€åº¦ã€ã§ä½¿ã†ï¼‰
  lastStart = { mode, levelData, options: { ...(options||{}), playMode: playModeActive } };

  // reset
  score = 0; combo = 0;
  if (typeof options.speedBase === 'number') baseScrollSpeed = options.speedBase;
  scrollSpeed = baseScrollSpeed;
  groups = []; pops = []; stars = [];
  flashes = []; toasts = [];
  scrollSpeed = baseScrollSpeed;
  document.getElementById('score').innerText = "0";
  lyricsEl.innerText = "";

  // mode
  gameMode = mode;
  isSongMode = (mode === 'song');
  practiceIndex = 0;
  scaleIndex = 0;

  if (mode === 'scale') {
    spawnInterval = options.interval ?? 2000;
    spawnMinInterval = options.minInterval ?? 900;
    spawnStep = options.step ?? 120;
    startBannerText = "ãƒ‰ãƒ¬ãƒŸã® ã‚Œã‚“ã—ã‚…ã†ï¼";
  } else {
    spawnInterval = 1800;
    spawnMinInterval = 900;
    spawnStep = 120;
    startBannerText = "";
  }

  practiceOrder = options.order || 'cycle';
  currentLevelChords = Array.isArray(levelData) ? levelData : (levelData ? [levelData] : ['C']);

  document.getElementById('menu-overlay').style.display = 'none';
  const ro = document.getElementById('result-overlay'); if (ro) ro.style.display = 'none';
  const po = document.getElementById('pause-overlay'); if (po) po.style.display = 'none';
  stopBtnEl.innerText = 'ã‚¹ãƒˆãƒƒãƒ—';
  document.getElementById('score-panel').style.display = 'block';
  timerPanel.style.display = 'block';
  stopBtnEl.style.display = 'block';
  // 90ç§’ã‚¿ã‚¤ãƒãƒ¼
  gameEndAt = performance.now() + GAME_DURATION_MS;
  timerEl.innerText = Math.ceil(GAME_DURATION_MS/1000);
  document.getElementById('back-btn').style.display = 'block';

  // ãƒãƒŠãƒ¼ã¯æ›²ã ã‘/å¿…è¦ãªæ™‚ã ã‘
  titleOpacity = (mode === 'song') ? 2.0 : 0.0;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  

  rafId = requestAnimationFrame(gameLoop);
}

function playTick() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

class FlashText {
  constructor(text, x, y) {
    this.text = text; this.x = x; this.y = y;
    this.life = 1.0; this.scale = 0.6; this.t = 0;
  }
  update() { this.t++; this.life -= 0.02; this.scale = Math.min(1.35, this.scale + 0.06); }
  draw() {
    const wob = Math.sin(this.t * 0.6) * 6;
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.life);
    ctx.translate(this.x + wob, this.y);
    ctx.scale(this.scale, this.scale);
    ctx.font = "900 92px sans-serif";
    ctx.textAlign = "center";
    ctx.strokeStyle = "white";
    ctx.lineWidth = 10;
    ctx.strokeText(this.text, 0, 0);
    ctx.fillStyle = "#ff7a3d";
    ctx.fillText(this.text, 0, 0);
    ctx.restore();
  }
}

class ToastText {
  constructor(text, x, y) {
    this.text = text; this.x = x; this.y = y;
    this.life = 1.0;
  }
  update() { this.life -= 0.03; }
  draw() {
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.life) * 0.55;
    ctx.font = "900 18px sans-serif";
    ctx.textAlign = "center";
    ctx.fillStyle = "#333";
    ctx.fillText(this.text, this.x, this.y);
    ctx.restore();
  }
}

class Star {
  constructor(x, y) {
    this.x = x; this.y = y;
    this.vx = (Math.random() - 0.5) * 20; this.vy = (Math.random() - 0.5) * 20;
    this.life = 1.0; this.color = `hsl(${Math.random() * 360}, 100%, 75%)`; this.size = Math.random() * 8 + 4;
  }
  update() { this.x += this.vx; this.y += this.vy; this.life -= 0.025; this.vy += 0.3; }
  draw() {
    ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
    ctx.beginPath();
    for(let i=0; i<5; i++){
      ctx.lineTo(this.x + Math.cos((18+i*72)*Math.PI/180)*this.size, this.y + Math.sin((18+i*72)*Math.PI/180)*this.size);
      ctx.lineTo(this.x + Math.cos((54+i*72)*Math.PI/180)*this.size/2, this.y + Math.sin((54+i*72)*Math.PI/180)*this.size/2);
    }
    ctx.fill(); ctx.restore();
  }
}

class PopText {
  constructor(text, x, y, isCombo = false) {
    this.text = text; this.x = x; this.y = y; this.life = 1.0; this.scale = 0.5; this.isCombo = isCombo;
  }
  update() { this.life -= 0.02; this.y -= 2; this.scale = Math.min(1.2, this.scale + 0.05); }
  draw() {
    ctx.save(); ctx.globalAlpha = this.life;
    ctx.translate(this.x, this.y); ctx.scale(this.scale, this.scale);
    ctx.font = this.isCombo ? "bold 50px sans-serif" : "italic 900 80px sans-serif";
    ctx.textAlign = "center"; ctx.strokeStyle = "white"; ctx.lineWidth = 8;
    ctx.strokeText(this.text, 0, 0);
    ctx.fillStyle = this.isCombo ? "#ffde59" : "#ff66c4";
    ctx.fillText(this.text, 0, 0); ctx.restore();
  }
}

class ChordGroup {
  constructor(chordData, lyrics = "") {
    this.chord = chordData; this.lyrics = lyrics;
    this.x = canvas.width + 100; this.active = true; this.ticked = false;
  }
  update() { 
    this.x -= scrollSpeed; 
    if (!this.ticked && this.x <= NUT_X) {
      playTick(); if (this.lyrics) lyricsEl.innerText = this.lyrics;
      this.ticked = true;
    }
  }
  draw(isTarget) {
    const centerY = canvas.height / 2;

if (isTarget && this.active) {
  // ã‚µãƒãƒ¼ãƒˆï¼ˆãƒŠãƒƒãƒˆä½ç½®ã«â€œã†ã£ã™ã‚‰ã‚¬ã‚¤ãƒ‰â€ï¼‰
  // æ—©ã™ãã‚‹/æ¶ˆãˆã™ãå¯¾ç­–ï¼šè·é›¢ã«å¿œã˜ã¦æ¿ƒã•ã‚’å¤‰ãˆã¦ã€ãƒŠãƒƒãƒˆã‚’å°‘ã—éãã¦ã‚‚æ®‹ã™
  const dx = Math.abs(this.x - NUT_X);
  const inWindow = (this.x < NUT_X + SUPPORT_AHEAD) && (this.x > NUT_X - SUPPORT_PAST);
  if (inWindow) {
    const t = Math.max(0, Math.min(1, 1 - (dx / SUPPORT_AHEAD))); // è¿‘ã„ã»ã© 1
    const alpha = 0.22 + t * 0.58;  // è¿‘ã„ã»ã©æ¿ƒã
    const size = 32 + t * 10;       // è¿‘ã„ã»ã©å°‘ã—å¤§ãã
    const blur = (t < 0.55);

    const hasOpen = this.chord.fingers.some(ff => ff.f === 0);
    if (hasOpen) {
      ctx.save();
      ctx.globalAlpha = Math.min(0.95, alpha + 0.15);
      ctx.fillStyle = "#ffffff";
      ctx.font = "bold 20px sans-serif";
      ctx.textAlign = "center";
      const openHintY = Math.max(60, centerY - 185);
      ctx.fillText("0 ã¯ ã²ã‚‰ãï¼ˆé–‹æ”¾ï¼‰", NUT_X + 160, openHintY);
      ctx.restore();
    }

    this.chord.fingers.forEach(f => {
      if (f.f > 0) this.drawCircle(NUT_X + (f.f * fretWidth) - (fretWidth / 2), centerY + (f.s - 2.5) * 75, f.txt, size, alpha, blur);
      else this.drawCircle(NUT_X, centerY + (f.s - 2.5) * 75, '0', size, alpha, blur);
    });
  }
}
    if (this.active) {
      const targetFinger = this.chord.fingers[this.chord.targetIdx];
      const nameX = (targetFinger.f === 0) ? this.x : this.x + (targetFinger.f * fretWidth) - (fretWidth / 2);
      ctx.fillStyle = "#fff"; ctx.font = "bold 60px sans-serif"; ctx.textAlign = "center";
      const topTextY = Math.max(80, centerY - 180);
      if (gameMode === 'scale') { ctx.fillText(this.chord.name || "", nameX, topTextY); }
      const isWaitTarget = (waitHold && playModeActive === 'WAIT' && waitTargetGroup === this);
      const blinkT = performance.now();
      const blink = 0.35 + 0.65 * (0.5 + 0.5 * Math.sin(blinkT / 140));
      this.chord.fingers.forEach(f => {
        const fx = (f.f === 0) ? this.x : this.x + (f.f * fretWidth) - (fretWidth / 2);
        const fy = centerY + (f.s - 2.5) * 75;
        if (isWaitTarget) {
          this.drawCircle(fx, fy, f.txt, 48, 0.22 + blink * 0.35, true);
          this.drawCircle(fx, fy, f.txt, 42, blink, false);
        } else {
          this.drawCircle(fx, fy, f.txt, 40, 1.0, false);
        }
      });
    }
  }
  drawCircle(x, y, txt, size, alpha, isBlur) {
    ctx.save(); ctx.globalAlpha = alpha; if (isBlur) ctx.filter = "blur(2px)";
    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fillStyle = (txt === 'è–¬') ? '#5271ff' : (txt === 'ä¸­' ? '#ff66c4' : (txt === 'äºº' ? '#ff914d' : '#888'));
    ctx.fill(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.stroke();
    ctx.filter = "none"; ctx.fillStyle = "#fff"; ctx.font = `bold ${size * 0.8}px sans-serif`;
    ctx.textAlign = "center"; ctx.fillText(txt, x, y + size * 0.3); ctx.restore();
  }
}


function stopGame(reason = 'STOP') {
  gameState = 'MENU';
  // å¿µã®ãŸã‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹
  const po = document.getElementById('pause-overlay'); if (po) po.style.display = 'none';
  const ro = document.getElementById('result-overlay'); if (ro) ro.style.display = 'none';
  stopBtnEl.innerText = 'ã‚¹ãƒˆãƒƒãƒ—';
  if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
  document.getElementById('menu-overlay').style.display = 'flex';
  document.getElementById('score-panel').style.display = 'none';
  timerPanel.style.display = 'none';
  stopBtnEl.style.display = 'none';
  lyricsEl.innerText = "";
}


// ===== Pause / Result control =====
let pausedRemainMs = 0;
let lastStart = null;

function pauseGame(){
  if (gameState !== 'PLAY') return;
  const now = performance.now();
  pausedRemainMs = Math.max(0, gameEndAt - now);
  gameState = 'PAUSE';
  if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
  document.getElementById('pause-overlay').style.display = 'flex';
}

function resumeGame(){
  if (gameState !== 'PAUSE') return;
  gameEndAt = performance.now() + pausedRemainMs;
  gameState = 'PLAY';
  document.getElementById('pause-overlay').style.display = 'none';
  stopBtnEl.innerText = 'ã‚¹ãƒˆãƒƒãƒ—';
  rafId = requestAnimationFrame(gameLoop);
}

function goMenuFromPause(){
  // ãƒãƒ¼ã‚ºä¸­ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ï¼ˆãã®ã¾ã¾çµ‚ã‚ã‚‹ï¼‰
  document.getElementById('pause-overlay').style.display = 'none';
  stopGame('STOP');
}

function endGame(){
  gameState = 'RESULT';
  if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
  stopBtnEl.style.display = 'none';
  timerPanel.style.display = 'none';

  // çµæœè¡¨ç¤º
  const res = document.getElementById('result-overlay');
  document.getElementById('result-score').innerText = String(score);
  document.getElementById('result-title').innerText = 'ãã“ã¾ã§ï¼';
  document.getElementById('result-msg').innerText = (score >= 250) ? 'ã™ã”ã„ï¼ã¾ãŸã‚„ã‚ã†ï¼'
    : (score >= 140) ? 'ã„ã„ã­ï¼ã“ã®ã¡ã‚‡ã†ã—ï¼'
    : 'ã ã„ã˜ã‚‡ã†ã¶ï¼ã¤ãã¯ã€ã‚‚ã£ã¨ã®ã³ã‚‹ã‚ˆï¼';
  res.style.display = 'flex';
}

function restartLast(){
  if (!lastStart) { goMenu(); return; }
  // çµæœã‚’é–‰ã˜ã‚‹
  document.getElementById('result-overlay').style.display = 'none';
  // å‰å›ã¨åŒã˜ãƒ¢ãƒ¼ãƒ‰ã§å†é–‹
  initGame(lastStart.mode, lastStart.levelData, lastStart.options);
}

function goMenu(){
  document.getElementById('result-overlay').style.display = 'none';
  document.getElementById('pause-overlay').style.display = 'none';
  stopGame('MENU');
}

function handleAction() {
  if (gameState !== 'PLAY') return;

  // è¿‘ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’1ã¤ã ã‘é¸ã¶ï¼ˆ0å¼¦ã‚‚å«ã‚ã¦åˆ†ã‹ã‚Šã‚„ã™ãï¼‰
  let target = null;
  let best = Infinity;
  // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ã§æ­¢ã¾ã£ã¦ã„ã‚‹é–“ã¯ã€åŒã˜ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã ã‘ã‚’è¦‹ã‚‹ï¼ˆæŒ™å‹•å®‰å®šï¼‰
  if (waitHold && playModeActive === 'WAIT' && waitTargetGroup && waitTargetGroup.active) {
    target = waitTargetGroup;
    best = Math.abs(target.x - NUT_X);
  } else {
  for (let i = 0; i < groups.length; i++) {
    const g = groups[i];
    if (!g.active) continue;
    const dx = g.x - NUT_X;
    if (dx > SUPPORT_AHEAD) continue;
    if (dx < -SUPPORT_PAST) continue;
    const d = Math.abs(dx);
    if (d < best) { best = d; target = g; }
  }
  }

  let hit = false;
  let skipMissPenalty = false;
  if (target) {
    const dist = Math.abs(target.x - NUT_X);
    const win = (playModeActive === 'TEST') ? (HIT_WINDOW * 1.9) : HIT_WINDOW;
    if (dist < win) {
      hit = true;
      target.active = false;
      // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ã§æ­¢ã¾ã£ã¦ã„ãŸã‚‰ã€ã“ã“ã§å†é–‹ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰0ã®ã¾ã¾ã«ãªã‚‰ãªã„ï¼‰
      if (waitHold && playModeActive === 'WAIT') {
        waitHold = false;
        scrollSpeed = (waitHoldPrevSpeed && waitHoldPrevSpeed > 0) ? waitHoldPrevSpeed : (scrollSpeed > 0 ? scrollSpeed : MIN_SPEED);
        waitTargetGroup = null;
        lastSpawn = performance.now(); // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰å¾©å¸°ç›´å¾Œã«é€£ç¶šspawnã—ãªã„ã‚ˆã†ã«
        flashes.push(new FlashText('ã§ããŸï¼', canvas.width/2, canvas.height/2 - 20));
        toasts.push(new ToastText('OKï¼ã¤ã¥ã‘ã‚ˆã†'));
      }
      combo++;
      if (combo % 5 === 0) {
        flashes.push(new FlashText('ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼ï¼', canvas.width/2, canvas.height/2 - 80));
    if (AUTO_SPEED) { scrollSpeed = Math.min(MAX_SPEED, scrollSpeed * SPEEDUP_MULT); }
      }

      const isPerfect = (dist < PERFECT_WINDOW);
      const bonus = isPerfect ? 15 : 10;
      score += bonus;
      document.getElementById('score').innerText = score;

      const msg = isPerfect ? "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼" : "ã„ã„ã‹ã‚“ã˜ï¼";
      pops.push(new PopText(msg, canvas.width/2, canvas.height/2));
      pops.push(new PopText(`${combo} ã‚Œã‚“ããï¼`, canvas.width/2, canvas.height/2 + 72, true));
      for(let i=0; i<20; i++) stars.push(new Star(NUT_X, canvas.height/2));
    } else {
      if (playModeActive === 'WAIT') {
        // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ï¼šãƒŸã‚¹ã—ãŸã‚‰æ­¢ã‚ã¦ã€åŒã˜å ´æ‰€ã§HITã§ãã‚‹ã¾ã§å¾…ã¤
        waitHold = true;
        waitHoldPrevSpeed = scrollSpeed;
        scrollSpeed = 0;
        waitTargetGroup = target;
        lastSpawn = performance.now(); // æ­¢ã‚ãŸç›´å¾Œã«æºœã¾ã£ãŸspawnãŒå‡ºãªã„ã‚ˆã†ã«
        // å¼¾ãï¼ˆã‚¿ãƒƒãƒ—ã™ã‚‹ï¼‰ä½ç½®ã¾ã§å¯„ã›ã¦ã€ç‚¹æ»…ã•ã›ã‚‹
        if (target.x > NUT_X) target.x = NUT_X;
        combo = 0;
        flashes.push(new FlashText('ãŠã¡ã¤ã„ã¦ï¼', canvas.width/2, canvas.height/2));
        toasts.push(new ToastText('ã²ã‹ã‚‹â—‹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­'));
        skipMissPenalty = true;
      }
    }
  }

  if (!hit && !skipMissPenalty) {
    if (combo > 0) combo = 0;
    if (AUTO_SPEED) {
      scrollSpeed = Math.max(MIN_SPEED, scrollSpeed / 1.12);
      toasts.push(new ToastText('ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³', canvas.width/2, 150));}
  }
}


function drawFretboard() {
  const midY = canvas.height / 2;
  fretWidth = (canvas.width - NUT_X - 100) / 12;
  ctx.fillStyle = "#6d4c41"; ctx.fillRect(NUT_X, midY - 150, canvas.width, 300);
  for (let i = 0; i <= 12; i++) {
    const x = NUT_X + i * fretWidth;
    ctx.strokeStyle = (i === 0) ? "#fff" : "#a1887f"; ctx.lineWidth = (i === 0) ? 12 : 3;
    ctx.beginPath(); ctx.moveTo(x, midY - 150); ctx.lineTo(x, midY + 150); ctx.stroke();
  }
    // å·¦ã® 1A/2E/3C/4Gï¼ˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ã¨åŒã˜è¦‹ãŸç›®ãƒ»ä½ç½®ï¼‰
  ctx.save();
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  for (let i = 0; i < 4; i++) {
    const y = midY + (i - 1.5) * 75;

    // è‰²ã¤ãä¸¸
    ctx.beginPath();
    ctx.fillStyle = STRING_COLORS[i];
    ctx.globalAlpha = 0.85;
    ctx.arc(MARK_CX, y, MARK_R, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1.0;

    // ãƒ©ãƒ™ãƒ«
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px sans-serif';
    ctx.fillText(STRING_LABELS[i], MARK_CX, y);
  }
  ctx.restore();

  // å¼¦ãƒ©ã‚¤ãƒ³
  for (let i = 0; i < 4; i++) {
    const y = midY + (i - 1.5) * 75;
    ctx.strokeStyle = STRING_COLORS[i];
    ctx.lineWidth = 8;
    ctx.beginPath();
    ctx.moveTo(NUT_X, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

function gameLoop(time) {
  if (gameState !== 'PLAY') return;
  if (!lastFrameT) lastFrameT = time;
  // ã¾ã¡ãƒ¢ãƒ¼ãƒ‰ã§æ­¢ã¾ã£ã¦ã„ã‚‹é–“ã¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’æ­¢ã‚ã‚‹
  if (waitHold) {
    const dt = Math.max(0, time - lastFrameT);
    gameEndAt += dt;
  }
  lastFrameT = time;

  // 90ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
  const now = performance.now();
  const remainMs = Math.max(0, gameEndAt - now);
  timerEl.innerText = Math.ceil(remainMs / 1000);
  if (remainMs <= 0) { endGame(); return; }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawFretboard();

  // spawn
if (!waitHold && (time - lastSpawn > spawnInterval)) {
  if (isSongMode) {
    const data = SONG_DATA[songIndex % SONG_DATA.length];
    groups.push(new ChordGroup(data.lib[data.key], data.lyrics));
    songIndex++;
  } else if (gameMode === 'scale') {
    const k = scaleSeq[scaleIndex % scaleSeq.length];
    groups.push(new ChordGroup(SOLO_LIB[k], "")); // ã‚¹ã‚±ãƒ¼ãƒ«ã¯æ­Œè©ãªã—
    scaleIndex++;

    // 1å‘¨ã”ã¨ã«å°‘ã—é€Ÿãï¼ˆä¸‹é™ã¾ã§ï¼‰
    if (scaleIndex % scaleSeq.length === 0) {
      spawnInterval = Math.max(spawnMinInterval, spawnInterval - spawnStep);
    }
  } else {
    // practice chords: åå¾©ï¼ˆcycleï¼‰ã‚’åŸºæœ¬ã«ã™ã‚‹
    let chordKey;
    if (practiceOrder === 'random') {
      chordKey = currentLevelChords[Math.floor(Math.random() * currentLevelChords.length)];
    } else {
      chordKey = currentLevelChords[practiceIndex % currentLevelChords.length];
      practiceIndex++;
    }
    groups.push(new ChordGroup(CHORD_LIB[chordKey], "ãã®ã¡ã‚‡ã†ã—ï¼"));
  }
  lastSpawn = time;
}


// --- ã©ã‚Œã‚’â€œæ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆâ€ã«ã™ã‚‹ã‹ï¼ˆè¿‘ã„ã‚‚ã®ã‚’1ã¤ã ã‘ï¼‰ ---
let targetIdx = -1;
let bestDist = Infinity;
for (let i = 0; i < groups.length; i++) {
  const g = groups[i];
  if (!g.active) continue;
  const dx = g.x - NUT_X;
  // ã‚µãƒãƒ¼ãƒˆè¡¨ç¤ºç¯„å›²å†…ã ã‘ï¼ˆæ—©ã™ãå¯¾ç­–ï¼‰
  if (dx > SUPPORT_AHEAD) continue;
  if (dx < -SUPPORT_PAST) continue;
  const d = Math.abs(dx);
  if (d < bestDist) { bestDist = d; targetIdx = i; }
}


// --- Chord HUDï¼ˆã‚³ãƒ¼ãƒ‰åã¯ã“ã“1ã‹æ‰€ã ã‘ã«å‡ºã™ï¼šè¢«ã‚Šé˜²æ­¢ï¼‰ ---
(function updateChordHud(){
  if (!chordHUDEl) return;
  if (gameMode === 'practice' || gameMode === 'song') {
    let name = '';
    if (targetIdx >= 0 && groups[targetIdx] && groups[targetIdx].chord) {
      name = groups[targetIdx].chord.name || '';
    } else {
      // äºˆå‚™ï¼šä¸€ç•ªæ‰‹å‰ã®activeã‚’æ¢ã™
      for (let i = 0; i < groups.length; i++){
        const g = groups[i];
        if (g && g.active && g.chord && g.chord.name){ name = g.chord.name; break; }
      }
    }
    chordHUDEl.style.display = name ? 'block' : 'none';
    chordHUDEl.textContent = name;
  } else {
    chordHUDEl.style.display = 'none';
    chordHUDEl.textContent = '';
  }
})();

// groups update/draw + cleanup
for (let i = groups.length - 1; i >= 0; i--) {
  const g = groups[i];
  const isTarget = (i === targetIdx);
  g.update(); g.draw(isTarget);

  // ç”»é¢å¤–ã«å‡ºãŸã‚‰æƒé™¤ï¼ˆé…åˆ—ãŒå¢—ãˆç¶šã‘ãªã„ã‚ˆã†ã«ï¼‰
  if (g.x < -400) groups.splice(i, 1);
}

// stars/pops: å¾Œã‚ã‹ã‚‰å‰Šé™¤ï¼ˆå®‰å®šï¼‰
for (let i = stars.length - 1; i >= 0; i--) { const s = stars[i]; s.update(); s.draw(); if (s.life <= 0) stars.splice(i, 1); }
for (let i = pops.length - 1; i >= 0; i--) { const p = pops[i]; p.update(); p.draw(); if (p.life <= 0) pops.splice(i, 1); }

  if (titleOpacity > 0) {
    ctx.save(); ctx.globalAlpha = Math.min(1.0, titleOpacity);
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.font = "bold 60px sans-serif";
    ctx.fillText(startBannerText || "ãƒ¡ãƒ­ãƒ‡ã‚£ã‚‚ ã²ã„ã¦ã¿ã‚ˆã†ï¼", canvas.width/2, canvas.height/2);
    ctx.restore(); titleOpacity -= 0.015;
  }
  // flashes/toastsï¼ˆæ´¾æ‰‹ãªã‚¹ãƒ”ãƒ¼ãƒ‰UP / æ§ãˆã‚ã‚¹ãƒ”ãƒ¼ãƒ‰DOWNï¼‰
  for (let i = flashes.length - 1; i >= 0; i--) {
    const f = flashes[i];
    f.update(); f.draw();
    if (f.life <= 0) flashes.splice(i, 1);
  }
  for (let i = toasts.length - 1; i >= 0; i--) {
    const t = toasts[i];
    t.update(); t.draw();
    if (t.life <= 0) toasts.splice(i, 1);
  }

  rafId = requestAnimationFrame(gameLoop);
}


function applyViewportSize() {
  const vv = window.visualViewport;
  const w = Math.round(vv ? vv.width : window.innerWidth);
  const h = Math.round(vv ? vv.height : window.innerHeight);
  canvas.width = w;
  canvas.height = h;

  // iOSã®è¡¨ç¤ºé ˜åŸŸã‚ºãƒ¬å¯¾ç­–ï¼ˆå›ºå®šUIã‚’â€œå†…å´â€ã«å¯„ã›ã‚‹ï¼‰
  const top = Math.round(vv ? vv.offsetTop : 0);
  const left = Math.round(vv ? vv.offsetLeft : 0);
  document.documentElement.style.setProperty('--vvTop', top + 'px');
  document.documentElement.style.setProperty('--vvLeft', left + 'px');
}
window.addEventListener('resize', applyViewportSize);
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', applyViewportSize);
  // iOS Safari ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®å‡ºå…¥ã‚Šã§é«˜ã•ãŒå¤‰ã‚ã‚‹ã®ã§ scroll ã‚‚æ‹¾ã†
  window.visualViewport.addEventListener('scroll', applyViewportSize);
}
applyViewportSize();
// å…¥åŠ›ã¯ canvas ã«ã ã‘ä»˜ã‘ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œã‚’é‚ªé­”ã—ãªã„ï¼‰
canvas.addEventListener('mousedown', (e) => { if (gameState === 'PLAY') handleAction(); });
canvas.addEventListener('touchstart', (e) => { if (gameState === 'PLAY') { e.preventDefault(); handleAction(); } }, {passive: false});

// å¿µã®ãŸã‚ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®onclickãŒåŠ¹ã‹ãªã„ç’°å¢ƒã§ã‚‚å‹•ãã‚ˆã†ã«ç›´ä»˜ã‘
document.querySelectorAll('#menu-overlay .mode1').forEach(b => b.addEventListener('click', startScale));
document.querySelectorAll('#menu-overlay .mode2').forEach(b => b.addEventListener('click', startChordsEasy));
document.querySelectorAll('#menu-overlay .mode3').forEach(b => b.addEventListener('click', startChordsHard));
document.querySelectorAll('#menu-overlay .mode4').forEach(b => b.addEventListener('click', startSongTwinkle));
window.startScale = startScale; window.startChordsEasy = startChordsEasy; window.startChordsHard = startChordsHard; window.startSongTwinkle = startSongTwinkle;


  // --- UIBAR FIX PATCH: collapse browser chrome (best-effort) -----------
  (function(){
    function nudge(){
      // Works best on iOS Safari in a normal tab. No harm elsewhere.
      try{ window.scrollTo(0, 1); }catch(e){}
      // Repeat a few times (iOS sometimes ignores the first call)
      setTimeout(function(){ try{ window.scrollTo(0, 1); }catch(e){} }, 50);
      setTimeout(function(){ try{ window.scrollTo(0, 1); }catch(e){} }, 200);
    }
    // First user gesture
    window.addEventListener('touchstart', nudge, {passive:true});
    window.addEventListener('touchend',   nudge, {passive:true});
    window.addEventListener('click',      nudge, {passive:true});
    // After orientation changes / resume
    window.addEventListener('orientationchange', function(){ setTimeout(nudge, 250); }, {passive:true});
    window.addEventListener('pageshow', function(){ setTimeout(nudge, 250); }, {passive:true});
    // Initial
    setTimeout(nudge, 300);
  })();
  // ---------------------------------------------------------------------

</script>
</div>
<div id="scroll-hack" aria-hidden="true"></div>
</body>
</html>